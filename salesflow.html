<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ScaleVest - SalesFlow Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; font-family: Inter, sans-serif; }
body { 
  margin: 0; 
  background: #f6f7fb; 
  padding: 20px; 
  overflow-x: hidden;
}

.top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 15px;
}

.back-nav-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 38px;
  height: 38px;
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  color: #1e293b;
  text-decoration: none;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  cursor: pointer;
}

.back-nav-btn:hover {
  background: #f5f3ff;
  border-color: #7c3aed;
  color: #7c3aed;
  transform: translateX(-3px);
}

h2 {
  margin: 0;
  font-size: 26px;
  font-weight: 800;
  color: #1e293b;
}

/* Performance Chart Section - Premium YouTube Style */
.chart-section {
  background: white;
  padding: 30px;
  border-radius: 24px;
  border: 1px solid #f1f5f9;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
  margin-bottom: 30px;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 10px;
}

.chart-title {
  font-size: 18px;
  font-weight: 700;
  color: #1e293b;
  margin: 0;
}

#performanceChart {
  max-height: 350px;
}

/* Filter Controls */
.filter-container {
  display: flex;
  align-items: center;
  gap: 10px;
  position: relative;
}

.filter-container select {
  padding: 10px 15px;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
  background: white;
  font-weight: 600;
  color: #1e293b;
  cursor: pointer;
  outline: none;
  transition: all 0.2s;
}

.filter-container select:hover {
  border-color: #cbd5e1;
}

.btn-reason {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 16px;
  background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.btn-reason:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
}

/* Metric Grid - 4 Column Clean Layout */
.metric-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 30px;
}

.metric-card {
  background: white;
  padding: 24px;
  border-radius: 20px;
  border: 1px solid #f1f5f9;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  position: relative;
  overflow: hidden;
}

.metric-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
}

.metric-label {
  font-size: 12px;
  font-weight: 600;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 12px;
  display: block;
}

.metric-value {
  font-size: 32px;
  font-weight: 800;
  color: #1e293b;
  margin-bottom: 12px;
  line-height: 1.2;
}

.metric-sub {
  font-size: 12px;
  color: #94a3b8;
  font-weight: 500;
  margin-bottom: 12px;
}

/* Comparison Badge - Pill Style */
.comparison-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 6px 12px;
  border-radius: 50px;
  font-size: 11px;
  font-weight: 700;
  margin-top: 8px;
  letter-spacing: 0.3px;
}

.comparison-up {
  background: rgba(16, 185, 129, 0.1);
  color: #059669;
}

.comparison-down {
  background: rgba(239, 68, 68, 0.1);
  color: #dc2626;
}

.comparison-neutral {
  background: rgba(148, 163, 184, 0.1);
  color: #64748b;
}

/* Margin Gauge Bar */
.margin-gauge {
  margin-top: 16px;
  padding-top: 12px;
  border-top: 1px solid #f1f5f9;
}

.margin-label {
  font-size: 11px;
  font-weight: 600;
  color: #64748b;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.margin-bar {
  height: 8px;
  background: #f1f5f9;
  border-radius: 50px;
  overflow: hidden;
  position: relative;
}

.margin-fill {
  height: 100%;
  border-radius: 50px;
  transition: width 0.5s ease, background 0.3s ease;
}

.margin-profit {
  background: linear-gradient(90deg, #10b981, #059669);
}

.margin-loss {
  background: linear-gradient(90deg, #ef4444, #dc2626);
}

/* Products Wrapper */
.products-wrapper {
  background: white;
  border-radius: 24px;
  border: 1px solid #f1f5f9;
  box-shadow: 0 4px 20px rgba(0,0,0,0.03);
  overflow: hidden;
}

.products-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid #f1f5f9;
}

.products-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 700;
  color: #1e293b;
}

.button-group {
  display: flex;
  gap: 16px;
  align-items: center;
}

.btn-modern {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 12px 28px;
  border-radius: 14px;
  font-size: 15px;
  font-weight: 700;
  letter-spacing: -0.2px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border: none;
  height: 52px;
}

.btn-bulk {
  background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%);
  color: white;
  box-shadow: 0 10px 20px -10px rgba(99, 102, 241, 0.5);
}

.btn-bulk:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 20px 25px -5px rgba(99, 102, 241, 0.4);
  filter: brightness(1.1);
}

.btn-download {
  background: #ffffff;
  color: #1e293b;
  border: 1px solid #e2e8f0;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
}

.btn-download:hover {
  background: #f8fafc;
  border-color: #cbd5e1;
  transform: translateY(-3px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.btn-modern:active {
  transform: translateY(0) scale(0.98);
}

/* Desktop Product Grid */
.grid-header {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
  background: #f8fafc;
  padding: 16px 24px;
  border-bottom: 1px solid #f1f5f9;
  color: #64748b;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.grid-body {
  max-height: 50vh;
  overflow-y: auto;
}

.product-row {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
  align-items: center;
  padding: 18px 24px;
  border-bottom: 1px solid #f8fafc;
  transition: all 0.2s ease;
}

.product-row:hover {
  background-color: #f5f3ff;
}

.product-row:last-child { border-bottom: none; }

.product-name {
  font-weight: 600;
  color: #1e293b;
}

.product-qty {
  font-weight: 600;
  color: #64748b;
}

.set-btn {
  padding: 8px 16px;
  background: #7c3aed;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
}

.set-btn:hover {
  background: #6d28d9;
  transform: scale(1.05);
}

/* Modal Styles */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(8px);
}

.modal-box {
  background: white;
  padding: 35px;
  border-radius: 28px;
  width: 90%;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

.modal-box h3 {
  margin: 0 0 10px 0;
  font-size: 20px;
  font-weight: 700;
}

.modal-box p {
  color: #64748b;
  margin-bottom: 20px;
}

.price-inputs {
  display: grid;
  gap: 15px;
  margin: 20px 0;
}

.input-group {
  text-align: left;
}

.input-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #64748b;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.input-group input {
  width: 100%;
  padding: 14px;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  transition: all 0.2s;
}

.input-group input:focus {
  outline: none;
  border-color: #7c3aed;
  box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1);
}

.modal-actions {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 12px;
  margin-top: 20px;
}

.btn-cancel {
  padding: 12px;
  background: #f1f5f9;
  color: #64748b;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
}

.btn-save {
  padding: 12px;
  background: #7c3aed;
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
}

.btn-save:hover { background: #6d28d9; }

.btn-save-all {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3);
}

.btn-save-all:hover {
  transform: translateY(-2px);
  box-shadow: 0 20px 25px -5px rgba(16, 185, 129, 0.4);
  filter: brightness(1.05);
}

.success-popup {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: #10b981;
  color: white;
  padding: 14px 28px;
  border-radius: 50px;
  font-weight: 600;
  display: none;
  z-index: 3000;
  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { bottom: -50px; opacity: 0; }
  to { bottom: 30px; opacity: 1; }
}

/* Reasoning Modal - Special Styling */
#reasoningModal .modal-box {
  max-width: 600px;
  text-align: left;
}

#reasoningModal .reasoning-section {
  background: #f8fafc;
  padding: 20px;
  border-radius: 16px;
  margin: 15px 0;
  border-left: 4px solid #6366f1;
}

#reasoningModal .reasoning-section h4 {
  margin: 0 0 12px 0;
  color: #1e293b;
  font-size: 16px;
  font-weight: 700;
}

#reasoningModal .reasoning-section p {
  margin: 8px 0;
  color: #475569;
  font-size: 14px;
  line-height: 1.6;
}

#reasoningModal .formula-box {
  background: white;
  padding: 12px;
  border-radius: 8px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  color: #059669;
  margin: 10px 0;
  border: 1px solid #e2e8f0;
}

/* Mobile Optimizations */
@media (max-width: 1200px) {
  .metric-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  body {
    padding: 15px;
  }

  .top {
    flex-direction: column;
    align-items: flex-start;
  }

  h2 {
    font-size: 22px;
  }

  .metric-grid {
    grid-template-columns: 1fr;
  }
  
  .chart-section {
    padding: 20px;
  }
  
  .metric-value {
    font-size: 28px;
  }

  .filter-container {
    flex-wrap: wrap;
    width: 100%;
  }

  .filter-container select {
    flex: 1;
    min-width: 120px;
  }

  .btn-reason {
    flex: 1;
    justify-content: center;
  }
  
  /* MOBILE PRODUCT CARDS - PREMIUM TRANSFORMATION */
  .grid-header { 
    display: none; 
  }
  
  .grid-body {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 15px;
    max-height: none;
  }

  .product-row {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 16px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    transition: all 0.3s ease;
  }

  .product-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    background: #fafafa;
  }

  /* Top Row - Name & Stock Badge */
  .product-name {
    font-size: 16px;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 4px;
  }

  .product-qty {
    display: inline-block;
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.3px;
  }

  /* Middle Row - Price Grid */
  .product-row > div:nth-child(3),
  .product-row > div:nth-child(4) {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    width: 100%;
  }

  .product-cost,
  .product-sell {
    padding: 12px;
    background: #f8fafc;
    border-radius: 10px;
    text-align: center;
    border: 1px solid #e2e8f0;
  }

  .product-cost::before {
    content: "Cost: ";
    display: block;
    font-size: 11px;
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .product-sell::before {
    content: "Sell: ";
    display: block;
    font-size: 11px;
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .product-cost,
  .product-sell {
    font-size: 16px;
    font-weight: 700;
    color: #1e293b;
  }

  /* Bottom Row - Full Width Edit Button */
  .product-row > div:last-child {
    width: 100%;
  }

  .set-btn {
    width: 100%;
    padding: 14px;
    font-size: 15px;
    border-radius: 12px;
    background: linear-gradient(135deg, #7c3aed, #6d28d9);
    min-height: 48px;
  }

  .set-btn:active {
    transform: scale(0.98);
  }

  /* Mobile Button Adjustments */
  .products-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }

  .button-group {
    width: 100%;
    flex-direction: column;
    gap: 10px;
  }

  .btn-modern {
    width: 100%;
    justify-content: center;
    height: 48px;
    padding: 12px 20px;
    font-size: 14px;
  }

  /* Bulk Upload Modal Mobile */
  #tableUploadModal > div {
    width: 95% !important;
    padding: 15px !important;
    max-height: 85vh;
  }

  #tableUploadModal table {
    font-size: 13px;
  }

  #tableUploadModal th,
  #tableUploadModal td {
    padding: 8px 6px !important;
  }

  .input-with-currency input {
    width: 70px !important;
    font-size: 13px !important;
    padding: 6px !important;
  }

  .modal-box {
    padding: 25px;
    max-width: 95%;
  }

  #reasoningModal .modal-box {
    max-width: 95%;
  }
}

@media (max-width: 480px) {
  .metric-value {
    font-size: 24px;
  }

  .chart-title {
    font-size: 16px;
  }

  .btn-modern svg {
    width: 18px;
    height: 18px;
  }
}

/* Input with Currency Styling */
.input-with-currency {
  position: relative;
  display: flex;
  align-items: center;
  gap: 8px;
}

.currency-label {
  font-size: 13px;
  font-weight: 700;
  color: #64748b;
  min-width: 35px;
}

.input-with-currency input {
  flex: 1;
  padding: 8px 12px;
  border: 1.5px solid #e2e8f0;
  border-radius: 8px;
  font-weight: 600;
  color: #1e293b;
  transition: all 0.2s;
  outline: none;
}

.input-with-currency input:focus {
  border-color: #6366f1;
  box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
}

.modern-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 600px;
}

.modern-table th,
.modern-table td {
  padding: 12px;
  border: 1px solid #e2e8f0;
  text-align: left;
}

.modern-table th {
  background: #f8fafc;
  font-weight: 700;
  font-size: 12px;
  text-transform: uppercase;
  color: #64748b;
}

.modern-table tbody tr:hover {
  background: #f9fafb;
}
</style>
</head>

<body>

<div id="successPopup" class="success-popup">Prices Updated!</div>

<div class="top">
  <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
    <a href="mainbusinesshub.html" class="back-nav-btn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
        <line x1="19" y1="12" x2="5" y2="12"/>
        <polyline points="12 19 5 12 12 5"/>
      </svg>
    </a>

    <button onclick="openSettings()" class="back-nav-btn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
    </button>

    <h2 style="margin: 0;">üí∞ SalesFlow Premium</h2>
  </div>

  <div class="filter-container">
    <span style="font-size: 13px; font-weight: 600; color: #64748b; margin-right: 8px;">Period:</span>
    <select id="timeFilter" onchange="calculateFinancials()">
      <option value="all">All Time</option>
      <option value="today">Today</option>
      <option value="yesterday">Yesterday</option>
      <option value="week">This Week</option>
      <option value="lastWeek">Last Week</option>
      <option value="month">This Month</option>
      <option value="lastMonth">Last Month</option>
      <option value="year">This Year</option>
    </select>
    
    <button class="btn-reason" onclick="openReasoningModal()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
      Reasoning
    </button>
  </div>
</div>

<!-- Performance Chart -->
<div class="chart-section">
  <div class="chart-header">
    <h3 class="chart-title">üìà Performance Comparison</h3>
  </div>
  <canvas id="performanceChart"></canvas>
</div>

<!-- Metric Grid -->
<div class="metric-grid">
  <div class="metric-card">
    <span class="metric-label">Total Spend</span>
    <div class="metric-value" id="totalSpend">$0</div>
    <div class="metric-sub">Lifetime investment</div>
  </div>

  <div class="metric-card">
    <span class="metric-label">Performance</span>
    <div class="metric-value" id="performanceIndicator">‚Äî</div>
    <div class="metric-sub" id="performanceSub">Period comparison</div>
    <div id="performanceComparison"></div>
  </div>
</div>

<!-- Products Section -->
<div class="products-wrapper">
  <div class="products-header">
    <h3 style="font-size: 24px; font-weight: 800; color: #0f172a; margin: 0;">üì¶ Inventory Manager</h3>
    
    <div class="button-group">
      <button class="btn-modern btn-bulk" onclick="openTableUpload()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:10px;">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="12" y1="18" x2="12" y2="12"></line>
          <line x1="9" y1="15" x2="15" y2="15"></line>
        </svg>
        Bulk Price Editor
      </button>

      <button class="btn-modern btn-download" onclick="downloadProducts()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:10px;">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Download Report
      </button>
    </div>
  </div>

  <div class="grid-header">
    <div>Product Name</div>
    <div>Quantity</div>
    <div>Cost Price</div>
    <div>Sell Price</div>
    <div>Action</div>
  </div>

  <div class="grid-body" id="productsGrid"></div>
</div>

<!-- Price Setting Modal -->
<div id="priceModal" class="modal">
  <div class="modal-box">
    <h3 id="modalTitle">Set Prices</h3>
    <p id="modalSubtitle">Define cost and selling price</p>
    
    <div class="price-inputs">
      <div class="input-group">
        <label>Cost Price</label>
        <input type="number" id="costPriceInput" placeholder="Enter number (e.g., 200)" step="0.01">
        <div style="font-size: 11px; color: #ef4444; margin-top: 4px; font-weight: bold;">
         ‚ö†Ô∏è Numbers only. Do not add "per pack" or "kg".
        </div>
      </div>
      <div class="input-group">
        <label>Selling Price</label>
        <input type="number" id="sellPriceInput" placeholder="Enter number (e.g., 400)" step="0.01">
        <div style="font-size: 11px; color: #ef4444; margin-top: 4px; font-weight: bold;">
          ‚ö†Ô∏è Numbers only. System calculates per unit automatically.
        </div>
      </div>
    </div>
    
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closePriceModal()">Cancel</button>
      <button class="btn-save" onclick="savePrices()">Save Prices</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
  <div class="modal-box">
    <h3>‚öôÔ∏è General Settings</h3>
    <p>Change your business currency below</p>
    
    <div class="price-inputs">
      <div class="input-group">
        <label>Active Currency</label>
        <input type="text" id="settingsCurrencyInput" maxlength="3" style="text-transform: uppercase;">
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeSettings()">Close</button>
      <button class="btn-save" onclick="updateCurrencyFromSettings()">Update Currency</button>
    </div>
  </div>
</div>

<!-- Currency Setup Modal -->
<div id="currencyModal" class="modal">
  <div class="modal-box">
    <h3>üåç Regional Settings</h3>
    <p>Enter your 3-letter currency code (e.g., USD, INR, GBP, EUR)</p>
    
    <div class="price-inputs">
      <div class="input-group">
        <label>Currency Code</label>
        <input type="text" id="currencyInput" placeholder="USD" maxlength="3" style="text-transform: uppercase;">
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-save" style="grid-column: span 2;" onclick="saveCurrency()">Save & Continue</button>
    </div>
  </div>
</div>

<!-- Reasoning Modal - NEW FEATURE -->
<div id="reasoningModal" class="modal">
  <div class="modal-box">
    <h3 style="text-align: center; margin-bottom: 20px;">üß† Calculation Reasoning</h3>
    <div id="reasoningContent"></div>
    <div style="display: flex; justify-content: center; margin-top: 25px;">
      <button class="btn-save" onclick="closeReasoningModal()" style="width: 100%;">Got It!</button>
    </div>
  </div>
</div>

<!-- Bulk Upload Modal -->
<div id="tableUploadModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:white; width:95%; max-width:900px; padding:20px; border-radius:15px; max-height:90vh; overflow-y:auto; display:flex; flex-direction:column;">
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h2 style="font-size: 1.2rem; margin:0;">Bulk Price Manager</h2>
      <button onclick="closeTableUpload()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
    </div>
    
    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom:20px;">
      <table class="modern-table">
        <thead>
          <tr>
            <th>Product</th>
            <th>Stock</th>
            <th>Cost</th>
            <th>Sell</th>
          </tr>
        </thead>
        <tbody id="bulkTableBody"></tbody>
      </table>
    </div>

    <div style="display:flex; gap:8px; justify-content:flex-end; width:100%;">
      <button class="btn-modern btn-cancel" onclick="closeTableUpload()">Cancel</button>
      <button class="btn-modern btn-save-all" onclick="saveAllPrices()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:5px;">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
          <polyline points="17 21 17 13 7 13 7 21"></polyline>
          <polyline points="7 3 7 8 15 8"></polyline>
        </svg>
        Save All
      </button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
// Firebase Configuration
firebase.initializeApp({
  apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain: "scalevest-163a0.firebaseapp.com",
  databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId: "scalevest-163a0"
});

const auth = firebase.auth();
const db = firebase.database();

// Global State
let inventory = {};
let prices = {};
let sales = {};
let purchases = {};
let invRef, pricesRef, salesRef, purchasesRef;
let currentProductId = null;
let userCurrency = "USD";
let performanceChart = null;
let reportCounter = 1;

// Utility Functions
function extractNumericValue(input) {
  if (!input) return 0;
  const str = String(input).trim();
  const match = str.match(/[\d,.]+/);
  if (!match) return 0;
  const numStr = match[0].replace(/,/g, '');
  return parseFloat(numStr) || 0;
}

function calculateComparison(currentValue, previousValue) {
  if (!previousValue || previousValue === 0) {
    return { change: 0, percentage: 0, direction: 'neutral' };
  }
  const change = currentValue - previousValue;
  const percentage = (change / previousValue) * 100;
  const direction = change > 0 ? 'up' : change < 0 ? 'down' : 'neutral';
  return { change, percentage, direction };
}

function renderComparisonBadge(comparison, periodName) {
  if (!comparison || comparison.direction === 'neutral' || isNaN(comparison.percentage) || comparison.percentage === 0) {
    return '';
  }
  
  const arrow = comparison.direction === 'up' ? '‚ñ≤' : '‚ñº';
  const comparisonClass = `comparison-${comparison.direction}`;
  
  return `
    <div class="comparison-badge ${comparisonClass}">
      ${arrow} ${Math.abs(comparison.percentage).toFixed(1)}% ${periodName}
    </div>
  `;
}

function getTimeRanges() {
  const now = new Date();
  const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
  const startOfYesterday = startOfToday - 86400000;
  
  const day = now.getDay();
  const startOfWeek = startOfToday - (day * 86400000);
  const startOfLastWeek = startOfWeek - (7 * 86400000);
  
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
  const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1).getTime();
  
  const startOfYear = new Date(now.getFullYear(), 0, 1).getTime();
  const startOfLastYear = new Date(now.getFullYear() - 1, 0, 1).getTime();
  const endOfLastYear = new Date(now.getFullYear(), 0, 1).getTime();
  
  return {
    today: { start: startOfToday, end: Infinity },
    yesterday: { start: startOfYesterday, end: startOfToday },
    thisWeek: { start: startOfWeek, end: Infinity },
    lastWeek: { start: startOfLastWeek, end: startOfWeek },
    thisMonth: { start: startOfMonth, end: Infinity },
    lastMonth: { start: startOfLastMonth, end: startOfMonth },
    thisYear: { start: startOfYear, end: Infinity },
    lastYear: { start: startOfLastYear, end: endOfLastYear }
  };
}

function calculateRevenueForPeriod(start, end) {
  let total = 0;
  if (!sales) return 0;
  
  Object.values(sales).forEach(sale => {
    if (sale.timestamp >= start && sale.timestamp <= end) {
      total += (parseFloat(sale.revenue) || 0);
    }
  });
  return total;
}

function calculateCostForPeriod(startTime, endTime) {
  let cost = 0;
  Object.values(sales).forEach(sale => {
    const saleTime = sale.timestamp;
    if (saleTime >= startTime && saleTime < endTime) {
      const productId = sale.productId;
      const priceData = prices[productId];
      if (priceData && priceData.costPrice) {
        const costValue = typeof priceData.costPrice === 'object' 
          ? priceData.costPrice.numericValue 
          : extractNumericValue(priceData.costPrice);
        cost += costValue * (sale.quantity || 0);
      }
    }
  });
  return cost;
}

// PREMIUM YOUTUBE-STYLE CHART - DUAL LINE AREA COMPARISON
function renderPerformanceChart(filter) {
  const ctx = document.getElementById('performanceChart');
  if (!ctx) return;
  
  if (performanceChart) {
    performanceChart.destroy();
  }
  
  const ranges = getTimeRanges();
  let labels = [];
  let currentData = [];
  let previousData = [];
  let chartTitle = "Performance Comparison";
  
  if (filter === 'today') {
    // Hourly comparison: Today vs Yesterday
    chartTitle = "Today vs Yesterday (Hourly)";
    for (let hour = 0; hour < 24; hour++) {
      labels.push(`${hour}:00`);
      
      const todayStart = ranges.today.start + (hour * 3600000);
      const todayEnd = todayStart + 3600000;
      const yesterdayStart = ranges.yesterday.start + (hour * 3600000);
      const yesterdayEnd = yesterdayStart + 3600000;
      
      currentData.push(calculateRevenueForPeriod(todayStart, todayEnd));
      previousData.push(calculateRevenueForPeriod(yesterdayStart, yesterdayEnd));
    }
  } else if (filter === 'week' || filter === 'lastWeek') {
    // Daily comparison: This Week vs Last Week
    chartTitle = "This Week vs Last Week (Daily)";
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    for (let i = 0; i < 7; i++) {
      labels.push(days[i]);
      
      const thisWeekStart = ranges.thisWeek.start + (i * 86400000);
      const thisWeekEnd = thisWeekStart + 86400000;
      const lastWeekStart = ranges.lastWeek.start + (i * 86400000);
      const lastWeekEnd = lastWeekStart + 86400000;
      
      currentData.push(calculateRevenueForPeriod(thisWeekStart, thisWeekEnd));
      previousData.push(calculateRevenueForPeriod(lastWeekStart, lastWeekEnd));
    }
  } else if (filter === 'month' || filter === 'lastMonth') {
    // Daily comparison: This Month vs Last Month
    chartTitle = "This Month vs Last Month";
    const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
    for (let day = 1; day <= Math.min(daysInMonth, 30); day++) {
      labels.push(`Day ${day}`);
      
      const thisMonthDay = new Date(new Date().getFullYear(), new Date().getMonth(), day).getTime();
      const thisMonthEnd = thisMonthDay + 86400000;
      const lastMonthDay = new Date(new Date().getFullYear(), new Date().getMonth() - 1, day).getTime();
      const lastMonthEnd = lastMonthDay + 86400000;
      
      currentData.push(calculateRevenueForPeriod(thisMonthDay, thisMonthEnd));
      previousData.push(calculateRevenueForPeriod(lastMonthDay, lastMonthEnd));
    }
  } else {
    // All Time: Monthly comparison
    chartTitle = "Last 12 Months - Revenue & Costs";
    for (let i = 11; i >= 0; i--) {
      const date = new Date();
      date.setMonth(date.getMonth() - i);
      labels.push(date.toLocaleDateString('en-US', { month: 'short' }));
      
      const monthStart = new Date(date.getFullYear(), date.getMonth(), 1).getTime();
      const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 1).getTime();
      
      const revenue = calculateRevenueForPeriod(monthStart, monthEnd);
      const cost = calculateCostForPeriod(monthStart, monthEnd);
      
      currentData.push(revenue);
      previousData.push(cost);
    }
  }
  
  // YouTube Analytics Style Configuration
  performanceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: filter === 'all' ? 'Revenue' : (filter === 'today' ? 'Today' : 'Current Period'),
          data: currentData,
          borderColor: '#10b981',
          backgroundColor: (context) => {
            const ctx = context.chart.ctx;
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(16, 185, 129, 0.25)');
            gradient.addColorStop(1, 'rgba(16, 185, 129, 0.0)');
            return gradient;
          },
          fill: true,
          tension: 0.4,
          borderWidth: 3,
          pointRadius: 0,
          pointHoverRadius: 6,
          pointHoverBackgroundColor: '#10b981',
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 2
        },
        {
          label: filter === 'all' ? 'Costs' : (filter === 'today' ? 'Yesterday' : 'Previous Period'),
          data: previousData,
          borderColor: '#64748b',
          backgroundColor: (context) => {
            const ctx = context.chart.ctx;
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(100, 116, 139, 0.2)');
            gradient.addColorStop(1, 'rgba(100, 116, 139, 0.0)');
            return gradient;
          },
          fill: true,
          tension: 0.4,
          borderWidth: 3,
          pointRadius: 0,
          pointHoverRadius: 6,
          pointHoverBackgroundColor: '#64748b',
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          position: 'top',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: {
              size: 13,
              weight: '600'
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(255, 255, 255, 0.95)',
          titleColor: '#1e293b',
          bodyColor: '#64748b',
          borderColor: '#e2e8f0',
          borderWidth: 1,
          padding: 12,
          displayColors: true,
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${userCurrency} ${context.parsed.y.toFixed(2)}`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: '#f1f5f9',
            drawBorder: false
          },
          ticks: {
            callback: function(value) {
              return userCurrency + ' ' + value.toLocaleString();
            },
            font: {
              size: 12,
              weight: '500'
            },
            color: '#64748b'
          }
        },
        x: {
          grid: {
            display: false,
            drawBorder: false
          },
          ticks: {
            font: {
              size: 12,
              weight: '500'
            },
            color: '#64748b'
          }
        }
      }
    }
  });
}

// Calculate Financials with Enhanced Logic
function calculateFinancials() {
  const filter = document.getElementById("timeFilter").value;
  const ranges = getTimeRanges();
  
  let startTime = 0;
  let endTime = Infinity;
  let comparisonPeriod = null;
  let periodName = "";

  switch(filter) {
    case "today":
      startTime = ranges.today.start;
      comparisonPeriod = ranges.yesterday;
      periodName = "vs Yesterday";
      break;
    case "yesterday":
      startTime = ranges.yesterday.start;
      endTime = ranges.yesterday.end;
      periodName = "vs Day Before";
      break;
    case "week":
      startTime = ranges.thisWeek.start;
      comparisonPeriod = ranges.lastWeek;
      periodName = "vs Last Week";
      break;
    case "month":
      startTime = ranges.thisMonth.start;
      comparisonPeriod = ranges.lastMonth;
      periodName = "vs Last Month";
      break;
    case "year":
      startTime = ranges.thisYear.start;
      comparisonPeriod = ranges.lastYear;
      periodName = "vs Last Year";
      break;
  }

  // Calculate Spend
  let totalSpend = 0;
  const productsWithHistory = new Set();
  if (purchases) {
    Object.values(purchases).forEach(purchase => {
      totalSpend += (parseFloat(purchase.totalCost) || 0);
      productsWithHistory.add(purchase.productId);
    });
  }
  Object.entries(inventory).forEach(([id, product]) => {
    if (!productsWithHistory.has(id)) {
      const priceData = prices[id];
      if (priceData && priceData.costPrice) {
        const costValue = typeof priceData.costPrice === 'object' 
          ? (priceData.costPrice.numericValue || 0) 
          : parseFloat(priceData.costPrice) || 0;
        totalSpend += costValue * (parseFloat(product.quantity) || 0);
      }
    }
  });

  // Calculate Revenue & Profit
  const currentRevenue = calculateRevenueForPeriod(startTime, endTime);
  const currentCost = calculateCostForPeriod(startTime, endTime);
  const grossProfit = currentRevenue - currentCost;
  
  const formatter = new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // Update UI
  document.getElementById("totalSpend").textContent = `${userCurrency} ${formatter.format(totalSpend)}`;
  document.getElementById("totalEarned").textContent = `${userCurrency} ${formatter.format(currentRevenue)}`;
  
  const profitEl = document.getElementById("grossProfit");
  profitEl.textContent = `${userCurrency} ${formatter.format(Math.abs(grossProfit))}`;
  profitEl.style.color = grossProfit >= 0 ? "#1e293b" : "#ef4444";

  // Margin Gauge
  const marginLabel = document.getElementById("marginLabel");
  const marginValue = document.getElementById("marginValue");
  const marginFill = document.getElementById("marginFill");
  
  let marginPercent = 0;
  if (grossProfit >= 0) {
    marginPercent = currentRevenue > 0 ? (grossProfit / currentRevenue) * 100 : 0;
    marginLabel.textContent = "Profit Margin";
    marginFill.className = "margin-fill margin-profit";
  } else {
    marginPercent = currentCost > 0 ? (Math.abs(grossProfit) / currentCost) * 100 : 0;
    marginLabel.textContent = "Loss Margin";
    marginFill.className = "margin-fill margin-loss";
  }
  
  marginValue.textContent = `${marginPercent.toFixed(1)}%`;
  marginFill.style.width = `${Math.min(marginPercent, 100)}%`;

  // Comparison Logic
  const earnedCompEl = document.getElementById("earnedComparison");
  const perfIndicator = document.getElementById("performanceIndicator");

  if (comparisonPeriod && filter !== 'all') {
    const previousRevenue = calculateRevenueForPeriod(comparisonPeriod.start, comparisonPeriod.end);
    const comparison = calculateComparison(currentRevenue, previousRevenue);
    earnedCompEl.innerHTML = renderComparisonBadge(comparison, periodName);
    perfIndicator.textContent = comparison.direction === 'up' ? 'Growing' : comparison.direction === 'down' ? 'Declining' : 'Stable';
    perfIndicator.style.color = comparison.direction === 'up' ? '#10b981' : comparison.direction === 'down' ? '#ef4444' : '#1e293b';
  } else {
    earnedCompEl.innerHTML = '<span style="color:#94a3b8; font-size:12px;">No comparison</span>';
    perfIndicator.textContent = "Stable";
  }

  renderPerformanceChart(filter);
}

// NEW: Reasoning Modal Functions
function openReasoningModal() {
  const filter = document.getElementById("timeFilter").value;
  const content = document.getElementById("reasoningContent");
  
  let reasoning = "";
  
  switch(filter) {
    case "today":
      reasoning = `
        <div class="reasoning-section">
          <h4>üìä Today's Performance Analysis</h4>
          <p><strong>Time Frame:</strong> Current day from 00:00 to now</p>
          <p><strong>Comparison:</strong> Today vs Yesterday (same hourly period)</p>
          <p><strong>Chart Logic:</strong> Displays hour-by-hour revenue comparison between today and yesterday</p>
          <div class="formula-box">
            Revenue = Œ£(Sale Price √ó Quantity Sold) for sales within today's timeframe
          </div>
          <p><strong>Why This Matters:</strong> Shows if today is performing better than yesterday at the same point in time. Perfect for tracking daily improvements.</p>
        </div>
      `;
      break;
      
    case "week":
      reasoning = `
        <div class="reasoning-section">
          <h4>üìä This Week's Performance Analysis</h4>
          <p><strong>Time Frame:</strong> Sunday to Saturday (current week)</p>
          <p><strong>Comparison:</strong> This Week vs Last Week (day-by-day)</p>
          <p><strong>Chart Logic:</strong> Shows daily revenue for each day of the week compared to the same day last week</p>
          <div class="formula-box">
            Weekly Revenue = Œ£(Daily Revenue) for all 7 days
          </div>
          <p><strong>Why This Matters:</strong> Identifies which days perform best and shows week-over-week growth trends.</p>
        </div>
      `;
      break;
      
    case "month":
      reasoning = `
        <div class="reasoning-section">
          <h4>üìä This Month's Performance Analysis</h4>
          <p><strong>Time Frame:</strong> 1st day to last day of current month</p>
          <p><strong>Comparison:</strong> This Month vs Last Month (same date comparison)</p>
          <p><strong>Chart Logic:</strong> Compares daily performance for each date against the same date last month</p>
          <div class="formula-box">
            Gross Profit = Total Revenue - Total Costs<br>
            Profit Margin% = (Gross Profit / Revenue) √ó 100
          </div>
          <p><strong>Why This Matters:</strong> Shows monthly growth patterns and helps identify if business is improving month-over-month.</p>
        </div>
      `;
      break;
      
    case "all":
      reasoning = `
        <div class="reasoning-section">
          <h4>üìä All-Time Performance Overview</h4>
          <p><strong>Time Frame:</strong> Last 12 months of business data</p>
          <p><strong>Chart Type:</strong> Revenue vs Costs (Monthly Trend)</p>
          <p><strong>Chart Logic:</strong> Displays monthly revenue and costs side-by-side to show profitability trends</p>
          <div class="formula-box">
            Monthly Profit = Monthly Revenue - Monthly Costs<br>
            Total Spend = Œ£(Cost Price √ó Initial Inventory + Purchase Costs)
          </div>">Total Revenue</span>
    <div class="metric-value" id="totalEarned">$0</div>
    <div class="metric-sub" id="earnedSub">Sales income</div>
    <div id="earnedComparison"></div>
  </div>

  <div class="metric-card">
    <span class="metric-label">Gross Profit</span>
    <div class="metric-value" id="grossProfit">$0</div>
    <div class="metric-sub">After cost deduction</div>
    
    <div class="margin-gauge">
      <div class="margin-label">
        <span id="marginLabel">Profit Margin</span>
        <span id="marginValue">0%</span>
      </div>
      <div class="margin-bar">
        <div class="margin-fill margin-profit" id="marginFill" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <div class="metric-card">
    <span class="metric-label">Performance</span>
    <div class="metric-value" id="performanceIndicator">‚Äî</div>
    <div class="metric-sub" id="performanceSub">Period comparison</div>
    <div id="performanceComparison"></div>
  </div>
</div>

<div class="products-wrapper">
  <div class="products-header">
    <h3 style="font-size: 24px; font-weight: 800; color: #0f172a; margin: 0;">üì¶ Inventory Manager</h3>
    
    <div class="button-group">
      <button class="btn-modern btn-bulk" onclick="openTableUpload()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:10px;">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="12" y1="18" x2="12" y2="12"></line>
          <line x1="9" y1="15" x2="15" y2="15"></line>
        </svg>
        Bulk Price Editor
      </button>

      <button class="btn-modern btn-download" onclick="downloadProducts()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:10px;">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Download Report
      </button>
    </div>
  </div>

  <div class="grid-header">
    <div>Product Name</div>
    <div>Quantity</div>
    <div>Cost Price</div>
    <div>Sell Price</div>
    <div>Action</div>
  </div>

  <div class="grid-body" id="productsGrid"></div>
</div>

<script>
// Authentication & Database Initialization
auth.onAuthStateChanged(user => {
  if (user) {
    const userId = user.uid;
    invRef = db.ref(`users/${userId}/inventory`);
    pricesRef = db.ref(`users/${userId}/prices`);
    salesRef = db.ref(`users/${userId}/sales`);
    purchasesRef = db.ref(`users/${userId}/purchases`);
    
    // Fetch Currency
    db.ref(`users/${userId}/settings/currency`).once('value', snapshot => {
      userCurrency = snapshot.val() || "USD";
      document.getElementById("settingsCurrencyInput").value = userCurrency;
      loadData();
    });
  } else {
    window.location.href = "login.html";
  }
});

function loadData() {
  // Listen for real-time updates
  invRef.on('value', snap => { inventory = snap.val() || {}; renderInventory(); });
  pricesRef.on('value', snap => { prices = snap.val() || {}; renderInventory(); calculateFinancials(); });
  salesRef.on('value', snap => { sales = snap.val() || {}; calculateFinancials(); });
  purchasesRef.on('value', snap => { purchases = snap.val() || {}; calculateFinancials(); });
}

function renderInventory() {
  const grid = document.getElementById("productsGrid");
  grid.innerHTML = "";
  
  Object.entries(inventory).forEach(([id, product]) => {
    const priceData = prices[id] || { costPrice: 0, sellPrice: 0 };
    const row = document.createElement("div");
    row.className = "product-row";
    row.innerHTML = `
      <div class="product-name">${product.name}</div>
      <div class="product-qty">${product.quantity} units</div>
      <div class="product-cost">${userCurrency} ${priceData.costPrice}</div>
      <div class="product-sell">${userCurrency} ${priceData.sellPrice}</div>
      <div>
        <button class="set-btn" onclick="openPriceModal('${id}', '${product.name}')">Edit Price</button>
      </div>
    `;
    grid.appendChild(row);
  });
}

// Modal Controls
function openPriceModal(id, name) {
  currentProductId = id;
  document.getElementById("modalTitle").textContent = `Set Prices for ${name}`;
  document.getElementById("priceModal").style.display = "flex";
}

function closePriceModal() {
  document.getElementById("priceModal").style.display = "none";
}

function savePrices() {
  const cost = document.getElementById("costPriceInput").value;
  const sell = document.getElementById("sellPriceInput").value;
  
  if (currentProductId && cost && sell) {
    pricesRef.child(currentProductId).update({
      costPrice: parseFloat(cost),
      sellPrice: parseFloat(sell)
    }).then(() => {
      showSuccess();
      closePriceModal();
    });
  }
}

function showSuccess() {
  const popup = document.getElementById("successPopup");
  popup.style.display = "block";
  setTimeout(() => { popup.style.display = "none"; }, 3000);
}

// Bulk Editor Logic
function openTableUpload() {
  const bulkBody = document.getElementById("bulkTableBody");
  bulkBody.innerHTML = "";
  
  Object.entries(inventory).forEach(([id, product]) => {
    const p = prices[id] || { costPrice: 0, sellPrice: 0 };
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${product.name}</td>
      <td>${product.quantity}</td>
      <td><div class="input-with-currency"><span>${userCurrency}</span><input type="number" data-id="${id}" class="bulk-cost" value="${p.costPrice}"></div></td>
      <td><div class="input-with-currency"><span>${userCurrency}</span><input type="number" data-id="${id}" class="bulk-sell" value="${p.sellPrice}"></div></td>
    `;
    bulkBody.appendChild(tr);
  });
  document.getElementById("tableUploadModal").style.display = "flex";
}

async function saveAllPrices() {
  const costs = document.querySelectorAll(".bulk-cost");
  const sells = document.querySelectorAll(".bulk-sell");
  const updates = {};
  
  costs.forEach((input, index) => {
    const id = input.getAttribute("data-id");
    updates[id] = {
      costPrice: parseFloat(input.value) || 0,
      sellPrice: parseFloat(sells[index].value) || 0
    };
  });
  
  await pricesRef.update(updates);
  closeTableUpload();
  showSuccess();
}

function closeTableUpload() {
  document.getElementById("tableUploadModal").style.display = "none";
}

function closeReasoningModal() {
  document.getElementById("reasoningModal").style.display = "none";
}
</script>
</body>
</html>
