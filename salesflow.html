<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SaleFlow Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; font-family: 'Inter', sans-serif; }
body { margin: 0; background: #f6f7fb; padding: 25px; color: #1e293b; }

.header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 30px;
}

.back-btn {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: white;
    border: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    color: #1e293b;
}

.finance-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 30px;
}

.finance-card {
    background: white;
    padding: 20px;
    border-radius: 24px;
    border: 1px solid #f1f5f9;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
}

.finance-card h4 {
    margin: 0;
    font-size: 11px;
    text-transform: uppercase;
    color: #64748b;
    letter-spacing: 1px;
}

.finance-card p {
    margin-top: 8px;
    font-size: 24px;
    font-weight: 800;
}

.spend { color: #64748b; }
.revenue { color: #10b981; }

.list-container {
    background: white;
    border-radius: 24px;
    overflow: hidden;
    border: 1px solid #f1f5f9;
}

.row {
    display: grid;
    grid-template-columns: 1.5fr 1fr 1fr;
    gap: 15px;
    padding: 20px;
    border-bottom: 1px solid #f8fafc;
    align-items: center;
}

.row:last-child { border-bottom: none; }

.prod-name {
    font-weight: 700;
    font-size: 16px;
}

.prod-stock {
    font-size: 12px;
    color: #94a3b8;
}

.input-box {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.input-box label {
    font-size: 9px;
    font-weight: 800;
    color: #94a3b8;
    text-transform: uppercase;
}

.input-box input {
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    font-weight: 700;
}
</style>
</head>

<body>

<div class="header">
    <a href="inventory.html" class="back-btn">
        ←
    </a>
    <h2 style="margin:0;font-weight:800;">SaleFlow</h2>
</div>

<div class="finance-grid">
    <div class="finance-card">
        <h4>Total Spend (Inventory Value)</h4>
        <p id="totalSpend" class="spend">$0.00</p>
    </div>
    <div class="finance-card">
        <h4>Total Earned (Sales)</h4>
        <p id="totalEarned" class="revenue">$0.00</p>
    </div>
</div>

<div class="list-container" id="flowList"></div>

<!-- ===================== FIREBASE ===================== -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ===================== INIT ===================== */
firebase.initializeApp({
    apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
    authDomain: "scalevest-163a0.firebaseapp.com",
    databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
    projectId: "scalevest-163a0"
});

const db = firebase.database();
const auth = firebase.auth();

let inventory = {};
let previousInventory = null;
let totalEarned = 0;

let invRef;
let earnedRef;

/* ===================== AUTH ===================== */
auth.onAuthStateChanged(async user => {
    if (!user) return;

    invRef = db.ref(`Businesses/${user.uid}/inventory`);
    earnedRef = db.ref(`Businesses/${user.uid}/finances/totalEarned`);

    /* 1️⃣ LOAD STORED REVENUE */
    const earnedSnap = await earnedRef.once("value");
    totalEarned = earnedSnap.val() || 0;

    /* 2️⃣ LOAD INVENTORY ONCE (BASELINE) */
    const invSnap = await invRef.once("value");
    inventory = invSnap.val() || {};
    previousInventory = JSON.parse(JSON.stringify(inventory));

    renderList();
    updateSummary();

    /* 3️⃣ REALTIME INVENTORY WATCH */
    invRef.on("value", snap => {
        const newInv = snap.val() || {};

        if (previousInventory) {
            detectSales(previousInventory, newInv);
        }

        inventory = newInv;
        previousInventory = JSON.parse(JSON.stringify(newInv));

        renderList();
        updateSummary();
    });
});

/* ===================== SALE DETECTION ===================== */
function detectSales(oldInv, newInv) {
    let earnedNow = 0;

    Object.keys(oldInv).forEach(id => {
        if (!newInv[id]) return;

        const oldQty = oldInv[id].quantity || 0;
        const newQty = newInv[id].quantity || 0;

        if (newQty < oldQty) {
            const sold = oldQty - newQty;
            const price = newInv[id].sellingPrice || 0;
            earnedNow += sold * price;
        }
    });

    if (earnedNow > 0) {
        totalEarned += earnedNow;
        earnedRef.set(totalEarned);
    }
}

/* ===================== UI ===================== */
function renderList() {
    const list = document.getElementById("flowList");
    list.innerHTML = "";

    Object.entries(inventory).forEach(([id, item]) => {
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
            <div>
                <div class="prod-name">${item.name}</div>
                <div class="prod-stock">Current: ${item.quantity || 0}</div>
            </div>
            <div class="input-box">
                <label>Cost</label>
                <input type="number" value="${item.costPrice || 0}"
                    onchange="updatePrice('${id}','costPrice',this.value)">
            </div>
            <div class="input-box">
                <label>Sale</label>
                <input type="number" value="${item.sellingPrice || 0}"
                    onchange="updatePrice('${id}','sellingPrice',this.value)">
            </div>
        `;
        list.appendChild(row);
    });
}

function updatePrice(id, field, val) {
    invRef.child(id).update({ [field]: parseFloat(val) || 0 });
}

function updateSummary() {
    let spend = 0;
    Object.values(inventory).forEach(item => {
        spend += (item.costPrice || 0) * (item.quantity || 0);
    });

    document.getElementById("totalSpend").textContent = `$${spend.toFixed(2)}`;
    document.getElementById("totalEarned").textContent = `$${totalEarned.toFixed(2)}`;
}
</script>

</body>
</html>
