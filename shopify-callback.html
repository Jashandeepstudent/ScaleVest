<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify Connection - ScaleVest</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 24px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f4f6;
            border-top-color: #7c3aed;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        h2 { color: #1e293b; margin-bottom: 10px; }
        p { color: #64748b; }
        .success { color: #16a34a; font-size: 60px; margin-bottom: 20px; }
        .error { color: #ef4444; font-size: 60px; margin-bottom: 20px; }
        .btn {
            display: inline-block;
            margin-top: 20px;
            padding: 14px 28px;
            background: #7c3aed;
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container" id="content">
        <div class="spinner"></div>
        <h2>Connecting to Shopify...</h2>
        <p>Please wait while we complete the connection.</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <script>
        // Initialize Firebase (same config as main page)
        const firebaseConfig = {
            apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
            authDomain: "scalevest-163a0.firebaseapp.com",
            databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
            projectId: "scalevest-163a0"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const storedState = localStorage.getItem('shopifyOAuthState');
        const shopName = localStorage.getItem('shopifyStoreName');

       async function handleCallback() {
    const content = document.getElementById('content');
    
    // Verify state to prevent CSRF
    if (state !== storedState) {
        content.innerHTML = `
            <div class="error">⚠️</div>
            <h2>Security Error</h2>
            <p>Invalid state parameter. Please try connecting again.</p>
            <a href="business-hub.html" class="btn">Back to Dashboard</a>
        `;
        return;
    }

    if (!code) {
        content.innerHTML = `
            <div class="error">❌</div>
            <h2>Connection Failed</h2>
            <p>No authorization code received from Shopify.</p>
            <a href="business-hub.html" class="btn">Back to Dashboard</a>
        `;
        return;
    }

    try {
        // Get API key from localStorage (sent from main page)
        const apiKey = localStorage.getItem('shopifyApiKey');
        
        if (!apiKey) {
            throw new Error('API key not found. Please try connecting again.');
        }

        // Exchange authorization code for access token via Vercel backend
        const tokenResponse = await fetch('YOUR_VERCEL_URL/api/shopify-token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                code: code,
                shop: shopName,
                apiKey: apiKey
            })
        });

        if (!tokenResponse.ok) {
            const errorData = await tokenResponse.json();
            throw new Error(errorData.error || 'Failed to connect to Shopify');
        }

        const tokenData = await tokenResponse.json();

        // Store the access token securely
        localStorage.setItem('shopifyAccessToken', tokenData.access_token);
        localStorage.setItem('shopifyConnected', 'true');
        localStorage.removeItem('shopifyOAuthState');
        localStorage.removeItem('shopifyApiKey'); // Clean up

        // Save to Firebase for current user
        const user = auth.currentUser;
        if (user) {
            await db.ref(`BusinessOwners/${user.uid}/shopify`).set({
                connected: true,
                storeName: shopName,
                accessToken: tokenData.access_token, // In production, encrypt this or store server-side
                scope: tokenData.scope,
                connectedAt: new Date().toISOString()
            });
        }

        // Show success
        content.innerHTML = `
            <div class="success">✓</div>
            <h2>Successfully Connected!</h2>
            <p>Your Shopify store "${shopName}" is now connected to ScaleVest.</p>
            <p style="margin-top: 10px; font-size: 13px;">Redirecting to dashboard...</p>
        `;

        // Redirect after 2 seconds
        setTimeout(() => {
            window.location.href = 'business-hub.html';
        }, 2000);

    } catch (error) {
        console.error('Error:', error);
        content.innerHTML = `
            <div class="error">❌</div>
            <h2>Connection Error</h2>
            <p>${error.message}</p>
            <a href="business-hub.html" class="btn">Back to Dashboard</a>
        `;
    }
}

        // Wait for auth state, then handle callback
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            handleCallback();
        });
    </script>
</body>
</html>
