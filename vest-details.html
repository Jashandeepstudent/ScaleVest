<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vest Analysis | ScaleVest</title>
    <style>
        /* --- GLOBAL STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'SF Pro Display', -apple-system, sans-serif; background: #f8f9fa; color: #1a1a1a; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* GLOBAL LOADER */
        #globalLoader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.6s ease, visibility 0.6s; }
        .loader-terminal { width: 300px; background: #1a1a1a; border-radius: 12px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); color: #10b981; font-family: monospace; font-size: 14px; }
        .loader-spinner { width: 50px; height: 50px; border: 4px solid rgba(16, 185, 129, 0.1); border-top: 4px solid #10b981; border-radius: 50%; margin-bottom: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #globalLoader.hidden { opacity: 0; visibility: hidden; }

        /* UI ELEMENTS */
        .header { background: white; border-radius: 16px; padding: 40px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .hook-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 16px; }
        .progress-container { background: #e5e7eb; height: 8px; border-radius: 20px; overflow: hidden; margin-bottom: 12px; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #10b981, #059669); width: 20%; transition: width 0.5s ease; }
        .categories { display: flex; gap: 12px; margin-bottom: 30px; flex-wrap: wrap; }
        .category-pill { padding: 12px 24px; border-radius: 25px; background: white; border: 2px solid #e5e7eb; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .category-pill.active { background: #10b981; color: white; border-color: #10b981; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .info-card { background: white; border-radius: 16px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card-label { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
        .label-red { color: #ef4444; } .label-blue { color: #3b82f6; } .label-green { color: #10b981; }
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .startup-logo-big { width: 80px; height: 80px; border-radius: 50%; background: #1a1a1a; display: flex; align-items: center; justify-content: center; font-size: 32px; color: white; overflow: hidden; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; }
        .modal-btn { padding: 14px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; border: 1px solid #ddd; }
        .modal-btn.primary { background: #10b981; color: white; border: none; }
        .cta-button { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 18px; border-radius: 12px; font-size: 18px; font-weight: 700; border: none; cursor: pointer; width: 100%; margin-top: 20px; }
    </style>
</head>
<body>

<div id="globalLoader">
    <div class="loader-spinner"></div>
    <div class="loader-terminal"><div id="loadStatus">> CONNECTING TO TERMINAL...</div></div>
</div>

<div class="container">
    <div class="header">
        <div class="hook-title" id="hookTitle">Loading...</div>
        <div class="description" id="description">Analysis Terminal Active</div>
        <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
        <div class="progress-text">Vest Explored: <span id="progressText">20%</span></div>
    </div>

    <div class="categories">
        <div class="category-pill active" data-section="main">Main Details</div>
        <div class="category-pill" data-section="startup">Startup Details</div>
        <div class="category-pill" data-section="audit">Audit</div>
        <div class="category-pill" data-section="roadmap">Roadmap</div>
        <div class="category-pill" data-section="founder">Founder Presence</div>
    </div>

    <div class="section active" id="main">
        <div class="info-card"><div class="card-label label-red">PROBLEM</div><div id="problem">...</div></div>
        <div class="info-card"><div class="card-label label-blue">SOLUTION</div><div id="solution">...</div></div>
        <div class="info-card"><div class="card-label label-blue">OUR ADVANTAGE</div><div id="advantage">...</div></div>
        <div class="two-column">
            <div class="info-card"><div class="card-label label-green">FUNDING ASK</div><div id="fundAsk">...</div></div>
            <div class="info-card"><div class="card-label label-green">EQUITY OFFERED</div><div id="equityOffered">...</div></div>
        </div>
    </div>

    <div class="section" id="startup">
        <div class="info-card">
            <div class="details-header">
                <div class="startup-logo-big" id="logoInitials">ST</div>
                <div><h1 id="startupName">...</h1><p id="startupDescription">...</p></div>
            </div>
            <div class="two-column">
                <div class="info-card"><strong>Stage:</strong> <span id="stage">...</span></div>
                <div class="info-card"><strong>Category:</strong> <span id="category">...</span></div>
            </div>
            <div class="info-card"><strong>Valuation:</strong> <span id="valuation">...</span></div>
        </div>
        <div class="info-card">
            <div class="card-label label-blue">PITCH DECK</div>
            <a href="#" id="pitchDeckLink" style="color: #3b82f6; font-weight: 700;">View Pitch Deck →</a>
        </div>
    </div>

    <div class="section" id="audit">
        <div class="info-card"><strong>Scalability:</strong> <p id="scalability">...</p></div>
        <div class="info-card"><strong>Market Share:</strong> <p id="marketShare">...</p></div>
        <div class="info-card"><strong>Competitors:</strong> <p id="competitors">...</p></div>
        <div class="info-card"><strong>Monetization:</strong> <p id="monetization">...</p></div>
    </div>

    <div class="section" id="roadmap">
        <div class="info-card"><strong>Goal This Year:</strong> <p id="yearGoal">...</p></div>
        <div class="info-card"><strong>Fund Usage:</strong> <p id="fundUtilization">...</p></div>
    </div>

    <div class="section" id="founder">
        <div class="info-card"><strong>Founder:</strong> <p id="founderName">...</p></div>
        <div class="info-card"><strong>Demo:</strong> <a href="#" id="demoVideoLink" style="color: #3b82f6;">Watch Video →</a></div>
        <button class="cta-button" id="fundButton">Interested to Fund</button>
    </div>
</div>

<div class="modal" id="fundModal">
    <div class="modal-content">
        <h2>Interested in Funding</h2>
        <p>Would you like to start a secure chat with the founder?</p><br>
        <div class="two-column">
            <button class="modal-btn" onclick="closeModal()">Cancel</button>
            <button class="modal-btn primary" onclick="scheduleCall()">Start Chat</button>
        </div>
    </div>
</div>

<div id="mediaTerminal" class="modal" style="background: rgba(0,0,0,0.95); backdrop-filter: blur(10px);">
    <div style="width: 90%; height: 85%; display: flex; flex-direction: column; align-items: center;">
        <div id="mediaViewport" style="width: 100%; height: 100%; background: #000; border-radius: 12px; overflow: hidden;"></div>
        <div style="margin-top: 20px; display: flex; gap: 20px;">
            <button class="modal-btn" style="background:#ef4444; color:white; border:none;" onclick="closeMediaTerminal()">CLOSE</button>
            <a id="externalOpenBtn" href="#" target="_blank" class="modal-btn" style="background:#fff; text-decoration:none; display:flex; align-items:center; padding: 0 20px;">OPEN IN NEW TAB</a>
        </div>
    </div>
</div>

<div id="chatTerminal" class="modal" style="background: rgba(0,0,0,0.8);">
    <div style="width: 400px; height: 550px; background: white; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden;">
        <div style="padding: 20px; background: #1a1a1a; color: #10b981; font-weight: 800; display: flex; justify-content: space-between;">
            CHANNEL: <span id="chatTargetName">STARTUP</span>
            <button onclick="closeChat()" style="color:white; background:none; border:none; cursor:pointer;">×</button>
        </div>
        <div id="messageDisplay" style="flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #f3f4f6;"></div>
        <div style="padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px;">
            <input type="text" id="chatInput" placeholder="Message..." style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
            <button id="sendMsgBtn" style="background:#10b981; color:white; border:none; padding: 10px 15px; border-radius: 8px; font-weight: 700;">SEND</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, push, set, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
        authDomain: "scalevest-163a0.firebaseapp.com",
        databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
        projectId: "scalevest-163a0",
        storageBucket: "scalevest-163a0.firebasestorage.app",
        messagingSenderId: "938358950124",
        appId: "1:938358950124:web:043506aeaacea2a96bfdc9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const params = new URLSearchParams(window.location.search);
    const vestID = params.get('id');
    const ownerUID = params.get('owner');
    const storageKey = `progress_${vestID}`;
    let viewedSections = new Set(['main']);
    let activeChatId = null;

    /* --- AUTH & DATA --- */
    onAuthStateChanged(auth, (user) => {
        if (user) {
            const saved = localStorage.getItem(storageKey);
            if (saved) viewedSections = new Set(JSON.parse(saved));
            updateProgressUI();
            loadVestData();
        } else { window.location.href = "login3.html"; }
    });

    async function loadVestData() {
        const status = document.getElementById('loadStatus');
        if (!vestID || !ownerUID) return;
        try {
            status.textContent = "> SYNCING STARTUP DATA...";
            const snapshot = await get(ref(db, `Vests/${ownerUID}/${vestID}`));
            if (snapshot.exists()) {
                const data = snapshot.val();
                const main = data.MainVest || {};
                const details = data.StartupDetails || {};
                const founder = data.FounderPresence || {};

                document.getElementById('hookTitle').textContent = main.hook || 'Opportunity';
                document.getElementById('problem').textContent = main.problem || '---';
                document.getElementById('solution').textContent = main.solution || '---';
                document.getElementById('advantage').textContent = main.advantage || '---';
                document.getElementById('fundAsk').textContent = '$' + (main.fundAsk || '0');
                document.getElementById('equityOffered').textContent = main.equityOffered || '0%';
                document.getElementById('startupName').textContent = details.startupName || details.name || 'Startup';
                document.getElementById('startupDescription').textContent = details.description || '';
                document.getElementById('stage').textContent = details.stage || 'N/A';
                document.getElementById('category').textContent = details.category || 'N/A';
                document.getElementById('valuation').textContent = main.valuation || 'TBD';
                document.getElementById('scalability').textContent = (data.Audit || {}).scalability || '---';
                document.getElementById('marketShare').textContent = (data.Audit || {}).marketShare || '---';
                document.getElementById('monetization').textContent = (data.Audit || {}).monetization || '---';
                document.getElementById('yearGoal').textContent = (data.Roadmap || {}).yearGoal || '---';
                document.getElementById('fundUtilization').textContent = (data.Roadmap || {}).fundUsage || '---';
                document.getElementById('founderName').textContent = founder.founderName || 'Founder';

                document.getElementById('pitchDeckLink').onclick = (e) => { e.preventDefault(); window.openPitchDeck(details.pitchDeckUrl); };
                document.getElementById('demoVideoLink').onclick = (e) => { e.preventDefault(); window.openDemoVideo(founder.demoVideoUrl); };

                const logoSnap = await get(ref(db, `startupProfile/${ownerUID}`));
                if (logoSnap.exists() && logoSnap.val().logo) {
                    document.getElementById('logoInitials').innerHTML = `<img src="${logoSnap.val().logo}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
                }
                
                status.textContent = "> TERMINAL READY.";
                setTimeout(() => document.getElementById('globalLoader').classList.add('hidden'), 500);
            }
        } catch (e) { console.error(e); }
    }

    /* --- GLOBALS --- */
    window.closeModal = () => document.getElementById('fundModal').classList.remove('active');
    
    window.scheduleCall = () => { window.closeModal(); window.openChat(); };

    window.openChat = () => {
        const investorUID = auth.currentUser.uid;
        activeChatId = investorUID < ownerUID ? `${investorUID}_${ownerUID}` : `${ownerUID}_${investorUID}`;
        document.getElementById('chatTargetName').textContent = document.getElementById('startupName').textContent.toUpperCase();
        document.getElementById('chatTerminal').classList.add('active');
        onValue(ref(db, `Chats/${activeChatId}/messages`), (snap) => {
            const display = document.getElementById('messageDisplay');
            display.innerHTML = "";
            if (snap.exists()) {
                Object.values(snap.val()).forEach(m => {
                    const isMine = m.senderId === investorUID;
                    display.innerHTML += `<div style="max-width:80%; padding:10px; border-radius:10px; font-size:14px; align-self:${isMine ? 'flex-end' : 'flex-start'}; background:${isMine ? '#10b981' : '#ddd'}; color:${isMine ? '#fff' : '#1a1a1a'}">${m.text}</div>`;
                });
                display.scrollTop = display.scrollHeight;
            }
        });
    };

    window.sendMessage = async () => {
        const input = document.getElementById('chatInput');
        if (!input.value.trim() || !activeChatId) return;
        await push(ref(db, `Chats/${activeChatId}/messages`), { senderId: auth.currentUser.uid, text: input.value, timestamp: serverTimestamp() });
        input.value = "";
    };

    window.closeChat = () => document.getElementById('chatTerminal').classList.remove('active');

    window.openPitchDeck = (url) => {
        if (!url || url === "#") return alert("Deck not available.");
        const viewerUrl = url.endsWith('.pdf') ? `https://docs.google.com/gview?url=${encodeURIComponent(url)}&embedded=true` : url;
        document.getElementById('mediaViewport').innerHTML = `<iframe src="${viewerUrl}" style="width:100%; height:100%; border:none;"></iframe>`;
        document.getElementById('externalOpenBtn').href = url;
        document.getElementById('mediaTerminal').classList.add('active');
    };

    window.openDemoVideo = (url) => {
        if (!url || url === "#") return alert("Video not available.");
        let videoHtml = (url.includes('youtube.com') || url.includes('youtu.be')) 
            ? `<iframe src="https://www.youtube.com/embed/${url.split('v=')[1] || url.split('/').pop()}" style="width:100%; height:100%; border:none;" allowfullscreen></iframe>`
            : `<video src="${url}" controls autoplay style="width:100%; height:100%;"></video>`;
        document.getElementById('mediaViewport').innerHTML = videoHtml;
        document.getElementById('mediaTerminal').classList.add('active');
    };

    window.closeMediaTerminal = () => { document.getElementById('mediaViewport').innerHTML = ""; document.getElementById('mediaTerminal').classList.remove('active'); };

    function updateProgressUI() {
        const progress = (viewedSections.size / 5) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent = Math.round(progress) + '%';
        localStorage.setItem(storageKey, JSON.stringify(Array.from(viewedSections)));
    }

    document.querySelectorAll('.category-pill').forEach(pill => {
        pill.addEventListener('click', () => {
            const section = pill.dataset.section;
            viewedSections.add(section);
            updateProgressUI();
            document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section).classList.add('active');
        });
    });

    // Final Bindings
    document.getElementById('sendMsgBtn').onclick = window.sendMessage;
    document.getElementById('chatInput').onkeypress = (e) => { if(e.key === 'Enter') window.sendMessage(); };
    document.getElementById('fundButton').onclick = () => document.getElementById('fundModal').classList.add('active');

</script>
</body>
</html>
