<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <title>ScaleVest CFO</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #0a0e27;
            color: #fff;
            min-height: 100vh;
            padding: 30px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(236, 72, 153, 0.1) 0%, transparent 50%);
            filter: blur(80px);
            pointer-events: none;
            z-index: 0;
        }
/* Enhanced Animations - Smoother & Faster */
@keyframes popupSlideIn {
    from {
        opacity: 0;
        transform: scale(0.85) translateY(40px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

@keyframes popupSlideOut {
    from {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
    to {
        opacity: 0;
        transform: scale(0.95) translateY(-30px);
    }
}

@keyframes shimmer {
    0% {
        background-position: -200% center;
    }
    100% {
        background-position: 200% center;
    }
}

@keyframes buttonPulse {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
    }
    50% {
        box-shadow: 0 0 0 20px rgba(59, 130, 246, 0);
    }
}

@keyframes spinLoader {
    to {
        transform: rotate(360deg);
    }
}

/* Smooth Transitions for Welcome Text */
#welcome-text {
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
}

/* Enhanced Button States */
.launch-btnv {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.launch-btnv.active {
    animation: buttonPulse 2.5s infinite;
}

.launch-btnv.active:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 15px 40px rgba(59, 130, 246, 0.6);
}

.launch-btnv.active:active {
    transform: translateY(-1px) scale(0.98);
}

.launch-btnv.loading {
    pointer-events: none;
    background: linear-gradient(
        90deg,
        #3b82f6 0%,
        #60a5fa 50%,
        #3b82f6 100%
    );
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}

.launch-btnv.loading::before {
    content: '';
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 22px;
    height: 22px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spinLoader 0.7s linear infinite;
}

.launch-btnv.loading span {
    opacity: 0;
}

/* Popup Entry Animation Enhancement */
#cfo-popup {
    animation-timing-function: cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* Checkbox Interaction */
#terms-check {
    cursor: pointer;
    width: 18px;
    height: 18px;
    transition: transform 0.2s ease;
}

#terms-check:hover {
    transform: scale(1.1);
}

/* Input Focus State */
#cfo-name-input {
    transition: all 0.3s ease;
}

#cfo-name-input:focus {
    border-color: rgba(59, 130, 246, 0.6);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    transform: translateY(-2px);
}
        .blur-orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.4;
            pointer-events: none;
            z-index: 0;
        }

        .orb1 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.4), transparent);
            top: -150px;
            left: -150px;
            animation: float1 20s ease-in-out infinite;
        }

        .orb2 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.3), transparent);
            top: 50%;
            right: -100px;
            animation: float2 18s ease-in-out infinite;
        }

        .orb3 {
            width: 450px;
            height: 450px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.35), transparent);
            bottom: -100px;
            left: 30%;
            animation: float3 22s ease-in-out infinite;
        }

        @keyframes float1 {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(100px, 50px); }
        }
/* NEW ANIMATIONS FOR ONBOARDING */
@keyframes popupSlideIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(30px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

@keyframes shimmer {
    0% {
        background-position: -200% center;
    }
    100% {
        background-position: 200% center;
    }
}

@keyframes buttonPulse {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
    }
    50% {
        box-shadow: 0 0 0 15px rgba(59, 130, 246, 0);
    }
}

@keyframes spinLoader {
    to {
        transform: rotate(360deg);
    }
}
.launch-btnv {
    width: 100%;
    padding: 18px 32px;
    border-radius: 14px;
    border: none;
    font-size: 15px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    cursor: not-allowed;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.3) 0%, rgba(37, 99, 235, 0.3) 100%);
    color: rgba(255, 255, 255, 0.5);
}

.launch-btnv.active {
    cursor: pointer;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
    animation: buttonPulse 2s infinite;
}

.launch-btnv.active:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(59, 130, 246, 0.5);
}

.launch-btnv.active:active {
    transform: translateY(0);
}

.launch-btnv.loading {
    pointer-events: none;
    background: linear-gradient(
        90deg,
        #3b82f6 0%,
        #60a5fa 50%,
        #3b82f6 100%
    );
    background-size: 200% 100%;
    animation: shimmer 2s infinite;
    color: white;
}

.launch-btnv.loading::before {
    content: '';
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spinLoader 0.8s linear infinite;
}

.launch-btnv.loading span {
    opacity: 0;
}
/* IMPROVED START CFO BUTTON */
        @keyframes float2 {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-80px, -60px); }
        }

        @keyframes float3 {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(60px, -70px); }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
        }
@keyframes popupSlideOut {
    from {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
    to {
        opacity: 0;
        transform: scale(0.9) translateY(30px);
    }
}
.trend-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    margin-bottom: 10px;
    border-left: 4px solid #00e5ff;
}
        .header {
            text-align: right;
            margin-bottom: 25px;
        }

        .logo {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: 3px;
            background: linear-gradient(135deg, #fff 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .search-bar {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 50px;
            padding: 16px 28px;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 35px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .mic-icon {
            width: 20px;
            height: 20px;
            color: #3b82f6;
        }

        .search-text {
            color: rgba(255, 255, 255, 0.6);
            font-size: 15px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            padding: 28px;
            backdrop-filter: blur(30px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        }
        /* ========== ENHANCED MOBILE RESPONSIVE FIXES ========== */

@media (max-width: 768px) {
    body {
        padding: 15px 10px;
    }

    .container {
        padding: 0;
    }

    .logo {
        font-size: 24px;
        letter-spacing: 1.5px;
    }

    .search-bar {
        padding: 12px 20px;
        font-size: 14px;
        width: 100%;
        margin-bottom: 20px;
    }

    /* Dashboard Grid - Single Column */
    .dashboard {
        grid-template-columns: 1fr !important;
        gap: 15px;
    }

    /* All Cards */
    .card {
        padding: 20px;
        border-radius: 16px;
    }
@keyframes popupSlideIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(30px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

@keyframes shimmer {
    0% {
        background-position: -200% center;
    }
    100% {
        background-position: 200% center;
    }
}

@keyframes buttonPulse {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
    }
    50% {
        box-shadow: 0 0 0 15px rgba(59, 130, 246, 0);
    }
}

@keyframes spinLoader {
    to {
        transform: rotate(360deg);
    }
}


    /* Card Titles */
    .card-title {
        font-size: 10px;
        margin-bottom: 12px;
        letter-spacing: 1.5px;
    }

    /* Profit Card */
    .big-number {
        font-size: 32px;
    }

    .profit-text {
        font-size: 13px;
    }

    #trend-badge {
        font-size: 0.75rem !important;
        padding: 3px 6px !important;
    }

    #daily-breakdown {
        font-size: 0.75rem !important;
    }

    .burn-rate {
        font-size: 11px;
        padding: 5px 12px;
    }

    /* Revenue Chart */
    .chart, #revenue-chart {
        height: 80px !important;
    }

    /* Products Card */
    .products {
        grid-template-columns: 1fr !important;
        gap: 12px;
    }

    .product {
        padding: 15px;
    }

    .product-icon, .dynamic-icon {
        font-size: 32px !important;
        width: 40px !important;
        height: 40px !important;
    }

    .product-name {
        font-size: 14px;
    }

    .product-badge {
        font-size: 11px;
    }

    .product-header {
        font-size: 9px;
    }

    /* Salary Card */
    .salary-card-wide {
        padding: 20px !important;
        max-width: 100% !important;
    }

    .salary-card-wide h2 {
        font-size: 20px !important;
    }

    .salary-card-wide > div:first-child {
        flex-direction: column !important;
        gap: 20px !important;
    }

    .svg-container img {
        width: 60px !important;
        height: 60px !important;
    }

    /* Momentum Card */
    .momentum-text {
        font-size: 16px;
    }

    .line-chart {
        height: 80px;
    }

    .price-warning {
        font-size: 11px;
    }

    /* Alert Card */
    .alert-text {
        font-size: 15px;
    }

    .launch-btn {
        padding: 12px 20px;
        font-size: 12px;
    }

    /* Quick Actions */
    .quick-actions {
        grid-template-columns: 1fr 1fr !important;
        gap: 10px;
    }

    .action-btn {
        padding: 15px 10px;
    }

    .action-icon {
        font-size: 24px;
    }

    .action-label {
        font-size: 9px;
    }

    /* Advice Card */
    .advice-text {
        font-size: 13px;
        line-height: 1.5;
    }

    /* Stock Card */
    .stock-text {
        font-size: 12px;
    }

    /* AI CFO Card */
    .ai-cfo-card {
        grid-column: span 1 !important;
    }

    #ai-suggestions {
        font-size: 13px;
    }

    #shelf-upload-section button {
        padding: 10px;
        font-size: 12px;
    }

    /* Onboarding Popup */
    #cfo-popup .card {
        max-width: 95% !important;
        padding: 25px !important;
    }

    #cfo-popup h2 {
        font-size: 22px;
    }

    #cfo-name-input {
        padding: 12px;
        font-size: 14px;
    }

    /* Product Analysis Page */
    #product-analysis-page {
        padding: 15px;
    }

    #product-analysis-page h1 {
        font-size: 28px !important;
    }

    #products-grid {
        grid-template-columns: 1fr !important;
        gap: 15px;
    }

    /* Finance Report Page */
    #finance-report-page {
        padding: 15px;
    }

    #finance-report-page h1 {
        font-size: 32px !important;
    }

    #dashboard-container .card {
        padding: 25px !important;
    }

    #weekly-sales-chart,
    #monthly-sales-chart {
        height: 200px !important;
    }

    #pnl-status-main {
        font-size: 42px !important;
    }

    #executive-summary {
        font-size: 14px !important;
    }

    /* Export Modal */
    #export-modal .card {
        padding: 25px !important;
    }

    #export-modal h3 {
        font-size: 20px;
    }

    /* Trend Overlay */
    #trend-overlay .card {
        width: 95% !important;
        padding: 20px !important;
    }

    .trend-item {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
}

@media (max-width: 480px) {
    body {
        padding: 10px 8px;
    }

    .logo {
        font-size: 20px;
    }

    .search-bar {
        padding: 10px 16px;
        font-size: 13px;
    }

    .big-number {
        font-size: 28px;
    }

    .card {
        padding: 16px;
    }

    .product-name {
        font-size: 13px;
    }

    .action-label {
        font-size: 8px;
    }

    .salary-card-wide h2 {
        font-size: 18px !important;
    }

    #finance-report-page h1 {
        font-size: 26px !important;
    }

    .chart, #revenue-chart {
        height: 60px !important;
    }

    #pnl-status-main {
        font-size: 36px !important;
    }
}

/* Fix for Horizontal Overflow */
@media (max-width: 768px) {
    body {
        overflow-x: hidden;
    }

    * {
        max-width: 100%;
    }

    .container {
        max-width: 100%;
        overflow-x: hidden;
    }

    /* Ensure flex items don't overflow */
    .salary-card-wide > div:first-child > div {
        min-width: 0;
    }

    /* Wrap long text */
    .advice-text,
    .stock-text,
    .alert-text,
    .momentum-text,
    .product-name,
    #executive-summary {
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
}
        /* ========== MOBILE RESPONSIVE FIXES ========== */

@media (max-width: 768px) {
    body {
        padding: 10px;
    }

    .logo {
        font-size: 20px;
        letter-spacing: 1px;
    }

    .search-bar {
        padding: 10px 16px;
        font-size: 13px;
    }

    .dashboard {
        grid-template-columns: 1fr !important;
        gap: 15px;
    }

    .card {
        padding: 20px;
        border-radius: 16px;
    }

    .card-title {
        font-size: 10px;
        margin-bottom: 12px;
    }

    .big-number {
        font-size: 36px;
    }

    .profit-text {
        font-size: 14px;
    }

    .products {
        grid-template-columns: 1fr !important;
        gap: 15px;
    }

    .product-icon {
        font-size: 36px;
    }

    .quick-actions {
        grid-template-columns: 1fr 1fr !important;
        gap: 10px;
    }

    .action-icon {
        font-size: 24px;
    }

    .salary-card-wide {
        padding: 20px !important;
    }

    .salary-card-wide h2 {
        font-size: 22px !important;
    }

    .svg-container img {
        width: 60px !important;
        height: 60px !important;
    }
}

@media (max-width: 480px) {
    .logo {
        font-size: 18px;
    }

    .big-number {
        font-size: 28px;
    }

    .card {
        padding: 16px;
    }

    .product-name {
        font-size: 13px;
    }

    .action-label {
        font-size: 9px;
    }
}
#revenue-chart {
    display: flex;
    align-items: flex-end; /* Aligns bars to the bottom */
    justify-content: space-between;
    height: 120px; /* Give the chart a specific height */
    padding: 10px 0;
    margin: 20px 0;
    gap: 5px;
}

.bar-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
}

.stock-bar {
    width: 100%;
    max-width: 15px;
    border-radius: 4px 4px 0 0;
    transition: height 0.5s ease-out, background-color 0.3s;
    min-height: 2px; /* So a 0 sale day still shows a tiny line */
}

.bar-label {
    font-size: 10px;
    color: #94a3b8;
    margin-top: 8px;
    font-weight: bold;
}
.salary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(79, 70, 229, 0.08);
        border-color: #e0e7ff !important;
    }
/* PDF Layout Fixes */
.pdf-page-break {
    page-break-before: always;
}

/* Ensure the chart containers don't get cut in half */
.card {
    page-break-inside: avoid;
}

/* Hide UI elements from the PDF */
.no-print {
    display: none !important;
}
        .card:hover {
            transform: translateY(-8px);
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 0 20px 60px rgba(59, 130, 246, 0.15);
            background: rgba(255, 255, 255, 0.04);
        }

        .card-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 18px;
            font-weight: 600;
        }

        .profit-card {
            grid-column: span 1;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(59, 130, 246, 0.02) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .big-number {
            font-size: 56px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            line-height: 1;
        }

        .profit-text {
            font-size: 17px;
            margin-bottom: 12px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }
.dynamic-icon {
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, #6366f1, #a855f7); 
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    font-weight: bold;
    color: white;
    margin: 15px auto;
    text-transform: uppercase;
}

        .burn-rate {
            display: inline-block;
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .chart {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            height: 80px;
            margin-top: 20px;
        }

        .bar {
            flex: 1;
            background: linear-gradient(180deg, #3b82f6 0%, #1e40af 100%);
            border-radius: 6px 6px 0 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            position: relative;
        }

        .bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.2), transparent);
            border-radius: 6px 6px 0 0;
        }

        .bar:hover {
            transform: scaleY(1.05);
            filter: brightness(1.2);
        }

        .products-card {
            grid-column: span 1;
            position: relative;
        }

        .bulk-ship {
            position: absolute;
            top: 24px;
            right: 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .products {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .product {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .product:hover {
            background: rgba(255, 255, 255, 0.04);
            transform: scale(1.02);
        }

        .product-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .star-badge {
            color: #fbbf24;
            font-size: 16px;
        }

        .ghost-badge {
            color: rgba(255, 255, 255, 0.15);
            font-size: 16px;
        }

        .product-icon {
            font-size: 48px;
            margin: 15px 0;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .product-name {
            font-size: 15px;
            margin-bottom: 6px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .product-badge {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
        }

        .reason {
            text-align: right;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 15px;
            font-style: italic;
        }

        .momentum-card {
            grid-column: span 1;
        }

        .momentum-text {
            font-size: 20px;
            color: #4ade80;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .line-chart {
            height: 100px;
            margin-top: 15px;
            position: relative;
        }

        .line-chart svg {
            width: 100%;
            height: 100%;
        }

        .price-warning {
            font-size: 12px;
            color: rgba(251, 146, 60, 0.8);
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .alert-card {
            grid-column: span 1;
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.12) 0%, rgba(251, 146, 60, 0.02) 100%);
            border: 1.5px solid rgba(251, 146, 60, 0.4);
            animation: alertPulse 3s infinite;
        }

        @keyframes alertPulse {
            0%, 100% { 
                border-color: rgba(251, 146, 60, 0.4);
                box-shadow: 0 0 0 0 rgba(251, 146, 60, 0);
            }
            50% { 
                border-color: rgba(251, 146, 60, 0.7);
                box-shadow: 0 0 20px 5px rgba(251, 146, 60, 0.2);
            }
        }

        .alert-title {
            color: #fb923c;
        }

        .alert-text {
            font-size: 18px;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }
.salary-card-wide:hover {
    transform: translateY(-5px);
    background: rgba(255, 255, 255, 0.05);
    
       border-color: #1e40af; 
    
     box-shadow: 0 0 20px rgba(30, 64, 175, 0.4), 0 25px 50px -12px rgba(0, 0, 0, 0.5);
}

.salary-card-wide:hover .svg-container {
   
    border-color: #3b82f6;
    background: rgba(59, 130, 246, 0.15);
    box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
}
        .launch-btn {
            background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
            border: none;
            padding: 16px 32px;
            border-radius: 14px;
            color: #fff;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 8px 24px rgba(251, 146, 60, 0.3);
        }

        .launch-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(251, 146, 60, 0.4);
        }

        .launch-btn:active {
            transform: translateY(0);
        }

        .advice-card {
            grid-column: span 1;
        }

        .advice-text {
            font-size: 15px;
            line-height: 1.7;
            color: rgba(255, 255, 255, 0.75);
        }

        .menu-icon {
            position: absolute;
            top: 24px;
            right: 24px;
            opacity: 0.3;
            font-size: 20px;
        }

        .stock-card {
            grid-column: span 1;
        }

        .stock-bar {
            height: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .stock-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
            width: 35%;
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            animation: fillPulse 2s ease-in-out infinite;
        }

        @keyframes fillPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .stock-text {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .status-card {
            grid-column: span 1;
        }

        .status-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.03);
            padding: 14px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .status-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .status-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .status-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .status-check { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .status-orange { background: linear-gradient(135deg, #fb923c, #f97316); }

        .status-check-mark {
            margin-left: auto;
            color: #4ade80;
            font-size: 18px;
        }

        .actions-card {
            grid-column: span 1;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-4px);
        }

        .action-icon {
            font-size: 28px;
        }

        .action-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.6);
        }

        .sparkle {
            position: fixed;
            bottom: 40px;
            right: 40px;
            font-size: 48px;
            opacity: 0.2;
            animation: sparkle 4s ease-in-out infinite;
            z-index: 2;
        }

        @keyframes sparkle {
            0%, 100% { 
                transform: translateY(0) rotate(0deg);
                opacity: 0.2;
            }
            50% { 
                transform: translateY(-15px) rotate(180deg);
                opacity: 0.4;
            }
        }

        @media (max-width: 1400px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain: "scalevest-163a0.firebaseapp.com",
  databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId: "scalevest-163a0",
  storageBucket: "scalevest-163a0.firebasestorage.app",
  messagingSenderId: "938358950124",
  appId: "1:938358950124:web:043506aeaacea2a96bfdc9",
  measurementId: "G-QD3TWBZHR0"
};

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

async function fetchRevenuePulse(userId) {
    const dbRef = ref(getDatabase());
    const salesSnapshot = await get(child(dbRef, `Businesses/${userId}/sales`));
    
    if (!salesSnapshot.exists()) return;
    const salesData = salesSnapshot.val();

    const now = new Date();
    // We define "This Week" as the last 7 days from today
    const sevenDaysAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
    const fourteenDaysAgo = new Date(now.getTime() - (14 * 24 * 60 * 60 * 1000));

    let thisWeekTotal = 0;
    let lastWeekTotal = 0;
    
    // Object to track specific totals for each of the last 7 days
    const dailyTotals = {}; 
    const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

    Object.values(salesData).forEach(sale => {
        const saleDate = new Date(sale.timestamp);
        const revenue = parseFloat(sale.revenue) || 0;

        if (saleDate > sevenDaysAgo) {
            thisWeekTotal += revenue;
            
            // Map to specific day name (e.g., "Friday")
            const dayName = daysOfWeek[saleDate.getDay()];
            dailyTotals[dayName] = (dailyTotals[dayName] || 0) + revenue;
        } else if (saleDate > fourteenDaysAgo) {
            lastWeekTotal += revenue;
        }
    });

    updateCFOUI(thisWeekTotal, lastWeekTotal, dailyTotals);
}

function updateCFOUI(current, previous, daily) {
    const totalRevEl = document.getElementById('total-revenue');
    const badgeEl = document.getElementById('trend-badge');
    const arrowEl = document.getElementById('trend-arrow');
    const percentEl = document.getElementById('trend-percent');
    const statusEl = document.getElementById('pnl-status');

    totalRevEl.innerText = `$${current.toLocaleString()}`;

    // 1. Stock Market Trend Logic
    const diff = current - previous;
    const percent = previous > 0 ? (diff / previous) * 100 : 100;

    if (diff >= 0) {
        // BULLISH (UP)
        badgeEl.style.backgroundColor = "rgba(74, 222, 128, 0.2)"; // Soft Green
        badgeEl.style.color = "#4ade80";
        arrowEl.innerText = "▲";
        percentEl.innerText = `${percent.toFixed(1)}%`;
        statusEl.innerText = `Market Outperformance: +$${diff.toLocaleString()} vs last week`;
    } else {
        // BEARISH (DOWN)
        badgeEl.style.backgroundColor = "rgba(248, 113, 113, 0.2)"; // Soft Red
        badgeEl.style.color = "#f87171";
        arrowEl.innerText = "▼";
        percentEl.innerText = `${Math.abs(percent).toFixed(1)}%`;
        statusEl.innerText = `Market Correction: -$${Math.abs(diff).toLocaleString()} gap noticed`;
    }

    // 2. Weekly Daily Breakdown
    const breakdownEl = document.getElementById('daily-breakdown');
    const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    let html = "";
    
    // Show only days that have sales
    days.forEach(day => {
        if(daily[day]) {
            html += `<div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span>${day}</span>
                        <span style="color:white;">$${daily[day].toFixed(0)}</span>
                     </div>`;
        }
    });
    breakdownEl.innerHTML = html || "No trading activity this week.";

    // 3. Dynamic Stock-style Bars
    updateStockChart(daily, diff >= 0);
const activeDays = Object.keys(daily).length || 1;
document.getElementById('burn-rate').innerText = `Velocity: $${(current / activeDays).toFixed(0)} / active day`;
}

function updateStockChart(daily, isPositive) {
    const chart = document.getElementById('revenue-chart');
    chart.innerHTML = ''; // Clear "Loading..."
    
    const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    
    // Find the highest value to scale the bars correctly
    const values = Object.values(daily);
    const maxVal = values.length > 0 ? Math.max(...values) : 100;

    days.forEach(day => {
        const val = daily[day] || 0;
        const heightPercent = (val / maxVal) * 100;
        
        // Container for bar + label
        const container = document.createElement('div');
        container.className = 'bar-container';

        // The actual bar
        const bar = document.createElement('div');
        bar.className = 'stock-bar';
        bar.style.height = `${Math.max(heightPercent, 2)}%`; // Ensure at least 2% height
        
        // Stock Market Color Logic:
        // If the day has sales, make it Green/Red based on overall performance
        bar.style.backgroundColor = val > 0 ? (isPositive ? "#4ade80" : "#f87171") : "#1e293b";
        
        // The Label (S, M, T, W...)
        const label = document.createElement('div');
        label.className = 'bar-label';
        label.innerText = day;

        container.appendChild(bar);
        container.appendChild(label);
        chart.appendChild(container);
    });
}
async function fetchAnalytics(userId) {
    const dbRef = ref(getDatabase());
    try {
        const snapshot = await get(child(dbRef, `Businesses/${userId}/analytics`));
        if (snapshot.exists()) {
            const data = snapshot.val();
            updateProductUI(data);
        }
    } catch (error) {
        console.error("Error fetching analytics:", error);
    }
}

function updateProductUI(analytics) {
    if (!analytics) return;

    // Helper function to set Name, Sold count, and the First Letter Icon
    const updateSlot = (prefix, data, isTrending = false) => {
        if (!data) return;
        
        const nameEl = document.getElementById(`${prefix}-name`);
        const soldEl = document.getElementById(`${prefix}-sold`);
        const iconEl = document.getElementById(`${prefix}-icon`);

        if (nameEl) nameEl.innerText = data.name;
        
        // Handle 'totalSold' vs 'recentSold'
        if (soldEl) {
            const count = isTrending ? data.recentSold : data.totalSold;
            const label = isTrending ? 'Recent' : 'Sold';
            soldEl.innerText = `${count} ${label}`;
        }

        // SET THE DYNAMIC ICON: Take the first letter of the name
        if (iconEl && data.name) {
            iconEl.innerText = data.name.charAt(0);
        }
    };

    updateSlot('star', analytics.mostSelling);
    updateSlot('trending', analytics.trendingSelling, true);
    updateSlot('ghost', analytics.leastSelling);

    // Update the footer reason
    if (analytics.trendingSelling) {
        document.getElementById('analytics-reason').innerText = 
            `Momentum: ${analytics.trendingSelling.name} is the current trending product!`;
    }
}
 function displayCFOName(name) {
      const header = document.querySelector('.header');
      const existingLabel = document.getElementById('cfo-display-label');
      if (existingLabel) existingLabel.remove();

      const cfoLabel = document.createElement('div');
      cfoLabel.id = "cfo-display-label";
      cfoLabel.style = "font-size: 14px; color: rgba(255,255,255,0.7); margin-top: 5px; font-weight: 500;";
      cfoLabel.innerHTML = `<span style="color: #3b82f6; font-weight: 700;">${name}</span> - Your CFO`;
      header.appendChild(cfoLabel);
  }
class ScaleVestBusinessKing {
    constructor() {
        this.apiUrl = 'https://gemini-sigma-plum.vercel.app/api/cfoscalevest';
        this.userData = null;
        this.analysisHistory = [];
        this.isAnalyzing = false;
        this.shelfImages = [];
        this.currentLanguage = 'en'; // 'en' or 'hi'
        this.currentAnalysis = null;
        this.maxImages = 10;
        this.maxImageSizeMB = 5;
    }

    // Initialize with user business data
    async initialize(userId, businessData) {
        this.userData = {
            userId,
            timestamp: new Date().toISOString(),
            ...businessData
        };
        
        this.setupUI();
    }

    // Setup UI elements
    setupUI() {
        const analyzeBtn = document.getElementById('analyze-business-btn');
        if (analyzeBtn) {
            analyzeBtn.onclick = () => this.analyzeBusinessData();
        }

        const uploadBtn = document.getElementById('upload-shelf-btn');
        const fileInput = document.getElementById('shelf-images-input');
        
        if (uploadBtn && fileInput) {
            uploadBtn.onclick = () => fileInput.click();
            fileInput.multiple = true;
            fileInput.accept = 'image/jpeg,image/jpg,image/png,image/webp';
            fileInput.onchange = (e) => this.handleMultipleImageUploads(e);
        }

        const analyzeShelvesBtn = document.getElementById('analyze-shelves-btn');
        if (analyzeShelvesBtn) {
            analyzeShelvesBtn.onclick = () => this.analyzeAllShelves();
        }

        const langToggle = document.getElementById('language-toggle');
        if (langToggle) {
            langToggle.onclick = () => this.toggleLanguage();
        }
    }

    // Handle multiple image uploads with validation
    async handleMultipleImageUploads(event) {
        const files = Array.from(event.target.files);
        
        if (this.shelfImages.length + files.length > this.maxImages) {
            this.showAlert(
                this.currentLanguage === 'hi' 
                    ? `आप केवल ${this.maxImages} फोटो अपलोड कर सकते हैं!`
                    : `You can only upload up to ${this.maxImages} photos!`,
                'warning'
            );
            return;
        }

        this.showLoadingToast(
            this.currentLanguage === 'hi' 
                ? 'फोटो अपलोड हो रही हैं...'
                : 'Uploading photos...'
        );

        let uploadedCount = 0;
        let failedCount = 0;

        for (const file of files) {
            const fileSizeMB = file.size / (1024 * 1024);
            if (fileSizeMB > this.maxImageSizeMB) {
                failedCount++;
                console.warn(`File ${file.name} is too large (${fileSizeMB.toFixed(2)}MB)`);
                continue;
            }

            if (!file.type.startsWith('image/')) {
                failedCount++;
                console.warn(`File ${file.name} is not an image`);
                continue;
            }

            try {
                const compressed = await this.compressImage(file);
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    this.shelfImages.push({
                        name: file.name,
                        data: e.target.result.split(',')[1],
                        timestamp: new Date().toISOString(),
                        size: fileSizeMB.toFixed(2) + 'MB'
                    });
                    uploadedCount++;
                    this.updateShelfPreview();
                };

                reader.onerror = () => {
                    failedCount++;
                };

                reader.readAsDataURL(compressed);
            } catch (error) {
                failedCount++;
                console.error('Error processing image:', error);
            }
        }

        setTimeout(() => {
            this.hideLoadingToast();
            
            if (uploadedCount > 0) {
                this.showAlert(
                    this.currentLanguage === 'hi'
                        ? `${uploadedCount} फोटो अपलोड हो गई ${failedCount > 0 ? `(${failedCount} विफल)` : ''}`
                        : `${uploadedCount} photo(s) uploaded ${failedCount > 0 ? `(${failedCount} failed)` : ''}`,
                    'success'
                );
            }

            if (this.shelfImages.length > 0) {
                const analyzeBtn = document.getElementById('analyze-shelves-btn');
                if (analyzeBtn) {
                    analyzeBtn.disabled = false;
                    analyzeBtn.style.opacity = '1';
                    analyzeBtn.style.display = 'block';
                }
            }
        }, 1000);
    }

    // Compress image to reduce size
    async compressImage(file, maxWidth = 1920, quality = 0.8) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const img = new Image();
                
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob(
                        (blob) => {
                            resolve(new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            }));
                        },
                        'image/jpeg',
                        quality
                    );
                };

                img.onerror = reject;
                img.src = e.target.result;
            };

            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // Update shelf preview UI
    updateShelfPreview() {
        const previewContainer = document.getElementById('shelf-preview-container');
        if (!previewContainer) return;

        const isHindi = this.currentLanguage === 'hi';

        previewContainer.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin: 15px 0;">
                ${this.shelfImages.map((img, index) => `
                    <div style="position: relative; aspect-ratio: 1; border-radius: 10px; overflow: hidden; border: 2px solid rgba(139, 92, 246, 0.4); background: rgba(0,0,0,0.3);">
                        <img src="data:image/jpeg;base64,${img.data}" style="width: 100%; height: 100%; object-fit: cover;">
                        <div style="position: absolute; top: 6px; left: 6px; background: rgba(168, 85, 247, 0.9); color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700;">
                            #${index + 1}
                        </div>
                        <div style="position: absolute; bottom: 6px; left: 6px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px;">
                            ${img.size}
                        </div>
                        <button onclick="window.businessKing.removeShelfImage(${index})" style="position: absolute; top: 6px; right: 6px; background: rgba(248, 113, 113, 0.95); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: 700; display: flex; align-items: center; justify-content: center; transition: transform 0.2s;">
                            ×
                        </button>
                    </div>
                `).join('')}
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 13px; color: rgba(255,255,255,0.8);">
                    ${isHindi 
                        ? `${this.shelfImages.length} फोटो अपलोड की गई (अधिकतम ${this.maxImages})`
                        : `${this.shelfImages.length} photo(s) uploaded (max ${this.maxImages})`
                    }
                </div>
                ${this.shelfImages.length > 0 ? `
                    <button onclick="window.businessKing.clearAllImages()" style="background: rgba(248, 113, 113, 0.2); border: 1px solid rgba(248, 113, 113, 0.4); color: #f87171; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                        ${isHindi ? 'सभी हटाएं' : 'Clear All'}
                    </button>
                ` : ''}
            </div>
        `;
    }

    // Remove single shelf image
    removeShelfImage(index) {
        this.shelfImages.splice(index, 1);
        this.updateShelfPreview();

        if (this.shelfImages.length === 0) {
            const analyzeBtn = document.getElementById('analyze-shelves-btn');
            if (analyzeBtn) {
                analyzeBtn.disabled = true;
                analyzeBtn.style.opacity = '0.5';
            }
        }
    }

    // Clear all images
    clearAllImages() {
        if (confirm(this.currentLanguage === 'hi' 
            ? 'क्या आप सभी फोटो हटाना चाहते हैं?'
            : 'Are you sure you want to remove all photos?')) {
            this.shelfImages = [];
            this.updateShelfPreview();
        }
    }

    // ============ ENHANCED ANALYSIS WITH SMART PROMPTING ============
    
    async analyzeBusinessData() {
        if (this.isAnalyzing) {
            console.log('⏳ Analysis already in progress...');
            return;
        }

        this.isAnalyzing = true;
        const loadingEl = document.getElementById('ai-loading');
        const suggestionsEl = document.getElementById('ai-suggestions');

        try {
            const prompt = this.buildIntelligentBusinessPrompt();

            if (loadingEl) {
                loadingEl.style.display = 'block';
                loadingEl.innerHTML = this.getLoadingHTML();
            }

            const data = await this.makeAPIRequest(prompt);

            this.currentAnalysis = data;
            this.analysisHistory.push({
                timestamp: new Date().toISOString(),
                type: 'business-data',
                data: data
            });

            if (loadingEl) loadingEl.style.display = 'none';
            if (suggestionsEl) {
                suggestionsEl.style.display = 'block';
                this.displayBusinessInsights(data);
            }

        } catch (error) {
            console.error('💥 Business Analysis Error:', error);
            this.showError(error);
        } finally {
            this.isAnalyzing = false;
        }
    }

    // Analyze all shelf images
    async analyzeAllShelves() {
        if (this.shelfImages.length === 0) {
            this.showAlert(
                this.currentLanguage === 'hi'
                    ? 'कृपया पहले शेल्फ की फोटो अपलोड करें'
                    : 'Please upload shelf photos first',
                'warning'
            );
            return;
        }

        if (this.isAnalyzing) return;

        this.isAnalyzing = true;
        const modal = this.createAnalyzingModal();
        document.body.appendChild(modal);

        try {
            const prompt = this.buildIntelligentShelfPrompt();
            const imageDataArray = this.shelfImages.map(img => img.data);

            console.log(`📸 Sending ${imageDataArray.length} images for analysis...`);

            const data = await this.makeAPIRequest(prompt, imageDataArray);

            this.analysisHistory.push({
                timestamp: new Date().toISOString(),
                type: 'shelf-analysis',
                imageCount: this.shelfImages.length,
                data: data
            });

            modal.remove();
            this.displayShelfAnalysis(data);

        } catch (error) {
            console.error('💥 Shelf Analysis Error:', error);
            modal.remove();
            this.showAlert(
                this.currentLanguage === 'hi'
                    ? `विश्लेषण विफल: ${error.message}`
                    : `Analysis failed: ${error.message}`,
                'error'
            );
        } finally {
            this.isAnalyzing = false;
        }
    }

    // ============ SMART API REQUEST WITH RETRY LOGIC ============
    
    async makeAPIRequest(prompt, images = null) {
        const maxRetries = 2;
        let lastError = null;
        
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const payload = {
                    prompt: prompt,
                    language: this.currentLanguage || 'en'
                };
                
                if (images && images.length > 0) {
                    payload.images = images;
                    payload.type = 'shelf-analysis';
                } else {
                    payload.type = 'business-analysis';
                }
                
                console.log(`🔄 API Request attempt ${attempt + 1}/${maxRetries}`);
                
                const response = await fetch(this.apiUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('🔴 API Error Response:', errorText);
                    throw new Error(`API returned ${response.status}: ${errorText.substring(0, 100)}`);
                }
                
                const result = await response.json();
                console.log('✅ API Request successful');
                return result;
                
            } catch (error) {
                lastError = error;
                console.error(`❌ Attempt ${attempt + 1} failed:`, error.message);
                
                if (attempt < maxRetries - 1) {
                    const waitTime = 1000 * (attempt + 1);
                    console.log(`⏳ Retrying in ${waitTime}ms...`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
        }
        
        throw lastError;
    }

    // ============ INTELLIGENT PROMPT BUILDING ============
    
    buildIntelligentBusinessPrompt() {
        const { totalRevenue, totalCosts, netProfit, profitMargin, weeklyGrowth, products, lowStockItems, expiringProducts } = this.userData;

        const isProfit = netProfit >= 0;
        const isHindi = this.currentLanguage === 'hi';

        // Calculate actual numbers for context
        const avgProductRevenue = products && products.length > 0 ? totalRevenue / products.length : 0;
        const costToRevenueRatio = totalRevenue > 0 ? ((totalCosts / totalRevenue) * 100).toFixed(1) : 0;

        if (isHindi) {
            return `आप एक EXPERT Business CFO हैं जो INDIAN छोटे व्यापारियों की मदद करते हैं। मेरा व्यापार डेटा है:

**मेरा बिज़नेस का हाल:**
📊 कुल बिक्री: ₹${totalRevenue?.toLocaleString('en-IN') || 0}
💸 कुल खर्च: ₹${totalCosts?.toLocaleString('en-IN') || 0}
${isProfit ? '✅' : '❌'} नेट ${isProfit ? 'मुनाफा' : 'नुकसान'}: ₹${Math.abs(netProfit || 0).toLocaleString('en-IN')}
📈 मार्जिन: ${profitMargin || 0}% | इस हफ्ते ग्रोथ: ${weeklyGrowth || 0}%
📦 प्रोडक्ट्स: ${products?.length || 0} | कम स्टॉक: ${lowStockItems?.length || 0} | एक्सपायर होने वाले: ${expiringProducts?.length || 0}

**महत्वपूर्ण संदर्भ:**
- खर्च का प्रतिशत: ${costToRevenueRatio}% (70% से कम अच्छा है)
- प्रति प्रोडक्ट औसत बिक्री: ₹${avgProductRevenue.toFixed(0)}

अब मुझे JSON format में जवाब दें (बिना markdown के):

{
  "simpleStatus": "एक लाइन में स्थिति (जैसे: 'बढ़िया! आप मुनाफे में हैं' या 'ध्यान दें! नुकसान हो रहा है')",
  "biggestProblem": "सबसे बड़ी समस्या क्या है? SPECIFIC बताएं (जैसे: 'खर्च 85% है - बहुत ज्यादा!' नहीं 'खर्च ज्यादा है')",
  "whyHappening": "यह क्यों हो रहा है? 2-3 असली कारण",
  "immediateActions": [
    {
      "number": 1,
      "action": "क्या करें (SPECIFIC - 'कीमत बढ़ाएं' नहीं, बल्कि 'सेब की कीमत ₹10 से ₹12 करें')",
      "reason": "क्यों करें?",
      "moneyImpact": "कितना पैसा बचेगा/बनेगा? (जैसे: '₹500/दिन बचत')",
      "difficulty": "easy/medium/hard",
      "timeToImplement": "कितना समय? (जैसे: '30 मिनट')"
    }
  ],
  "hiddenOpportunity": "कोई छुपा मौका? (optional)",
  "warnings": ["चेतावनी 1", "चेतावनी 2"],
  "encouragement": "हौसला बढ़ाने वाली बात",
  "nextSteps": "अगले 7 दिनों में क्या करें?"
}

**RULES:**
1. सभी नंबर INDIAN RUPEES (₹) में दें
2. हर ACTION में SPECIFIC numbers दें (जैसे: "कीमत ₹10 से ₹12 करें" - सिर्फ "कीमत बढ़ाएं" मत लिखें)
3. हर ACTION में पैसे का EXACT impact दें
4. सरल हिंदी में लिखें जैसे दोस्त से बात कर रहे हों
5. कोई भी ACTION जो काम का ना हो वो मत दें`;
        }

        // English version
        return `You are an EXPERT Business CFO helping small business owners in India. Here's my business data:

**My Business Status:**
📊 Total Revenue: ₹${totalRevenue?.toLocaleString('en-IN') || 0}
💸 Total Costs: ₹${totalCosts?.toLocaleString('en-IN') || 0}
${isProfit ? '✅' : '❌'} Net ${isProfit ? 'Profit' : 'Loss'}: ₹${Math.abs(netProfit || 0).toLocaleString('en-IN')}
📈 Margin: ${profitMargin || 0}% | Weekly Growth: ${weeklyGrowth || 0}%
📦 Products: ${products?.length || 0} | Low Stock: ${lowStockItems?.length || 0} | Expiring Soon: ${expiringProducts?.length || 0}

**Important Context:**
- Cost to Revenue Ratio: ${costToRevenueRatio}% (below 70% is good)
- Average Revenue per Product: ₹${avgProductRevenue.toFixed(0)}

Respond in JSON format (no markdown):

{
  "simpleStatus": "One-line status (e.g., 'Great! You're profitable' or 'Warning! Operating at loss')",
  "biggestProblem": "What's the BIGGEST problem? Be SPECIFIC (e.g., 'Costs are 85% - too high!' not just 'Costs are high')",
  "whyHappening": "Why is this happening? Give 2-3 real reasons",
  "immediateActions": [
    {
      "number": 1,
      "action": "What to do (SPECIFIC - not 'increase price' but 'Increase Apple price from ₹10 to ₹12')",
      "reason": "Why do this?",
      "moneyImpact": "How much money saved/earned? (e.g., '₹500/day savings')",
      "difficulty": "easy/medium/hard",
      "timeToImplement": "How long? (e.g., '30 minutes')"
    }
  ],
  "hiddenOpportunity": "Any hidden opportunity? (optional)",
  "warnings": ["Warning 1", "Warning 2"],
  "encouragement": "Encouraging message",
  "nextSteps": "What to do in next 7 days?"
}

**RULES:**
1. All numbers in INDIAN RUPEES (₹)
2. Every ACTION must have SPECIFIC numbers (e.g., "Increase price from ₹10 to ₹12" - not just "increase price")
3. Every ACTION must show EXACT money impact
4. Write in simple English like talking to a friend
5. Don't give useless generic advice`;
    }

    buildIntelligentShelfPrompt() {
        const isHindi = this.currentLanguage === 'hi';

        if (isHindi) {
            return `आप एक EXPERT Retail Merchandising Specialist हैं। मैंने ${this.shelfImages.length} शेल्फ की फोटो भेजी है।

हर फोटो को ध्यान से देखें और JSON में जवाब दें:

{
  "overallScore": "1 से 10 (कुल स्कोर)",
  "totalPotentialIncrease": "₹X/महीना (कुल कमाई अगर सब ठीक करें)",
  "criticalIssues": [
    "सबसे जरूरी समस्या 1",
    "सबसे जरूरी समस्या 2"
  ],
  "shelfAnalysis": [
    {
      "shelfNumber": 1,
      "score": "1-10",
      "moneyLost": "₹X/दिन (इस शेल्फ से)",
      "biggestMistake": "SPECIFIC गलती (जैसे: 'महंगे प्रोडक्ट निचे रखे हैं - कोई नहीं देख पाएगा')",
      "quickFix": "सबसे आसान तरीका (5 मिनट में)",
      "recommendations": [
        {
          "action": "क्या करें? (SPECIFIC)",
          "where": "कहाँ करें?",
          "why": "क्यों करें?",
          "moneyGain": "₹X/महीना बढ़ेगा"
        }
      ]
    }
  ],
  "psychologyTricks": [
    "ग्राहक मनोविज्ञान ट्रिक 1",
    "ग्राहक मनोविज्ञान ट्रिक 2"
  ],
  "priorityActions": "आज ही करें (TOP 3)"
}

**RULES:**
1. हर MISTAKE में बताएं - यह कैसे पैसा खो रहा है
2. हर RECOMMENDATION में EXACT money impact दें
3. सिर्फ काम की बातें बताएं - बेकार की सलाह नहीं
4. सरल हिंदी में लिखें`;
        }

        return `You are an EXPERT Retail Merchandising Specialist. I've sent ${this.shelfImages.length} shelf photos.

Analyze each photo carefully and respond in JSON:

{
  "overallScore": "1 to 10 (overall score)",
  "totalPotentialIncrease": "₹X/month (total earnings if all fixed)",
  "criticalIssues": [
    "Most urgent issue 1",
    "Most urgent issue 2"
  ],
  "shelfAnalysis": [
    {
      "shelfNumber": 1,
      "score": "1-10",
      "moneyLost": "₹X/day (from this shelf)",
      "biggestMistake": "SPECIFIC mistake (e.g., 'Premium products at bottom - nobody sees them')",
      "quickFix": "Easiest fix (5 minutes)",
      "recommendations": [
        {
          "action": "What to do? (SPECIFIC)",
          "where": "Where to do it?",
          "why": "Why do it?",
          "moneyGain": "₹X/month increase"
        }
      ]
    }
  ],
  "psychologyTricks": [
    "Customer psychology trick 1",
    "Customer psychology trick 2"
  ],
  "priorityActions": "Do TODAY (TOP 3)"
}

**RULES:**
1. Every MISTAKE must explain how it's losing money
2. Every RECOMMENDATION must show EXACT money impact
3. Only give useful advice - no generic stuff
4. Write in simple English`;
    }

    // ============ ENHANCED DISPLAY FUNCTIONS ============
    
    displayBusinessInsights(data) {
        const suggestionsEl = document.getElementById('ai-suggestions');
        if (!suggestionsEl) return;

        const isHindi = this.currentLanguage === 'hi';
        let insights = this.parseResponse(data);

        // Handle raw text responses by creating structure
        if (insights.raw || typeof insights === 'string') {
            insights = {
                simpleStatus: isHindi ? 'विश्लेषण पूरा हुआ' : 'Analysis Complete',
                biggestProblem: insights.text || insights,
                immediateActions: [],
                warnings: [],
                encouragement: isHindi ? 'आप सही दिशा में हैं!' : 'You\'re on the right track!'
            };
        }

        const isGood = insights.simpleStatus?.includes(isHindi ? 'बढ़िया' : 'Great') || 
                       insights.simpleStatus?.includes(isHindi ? 'मुनाफे' : 'profit');
        const statusColor = isGood ? '#4ade80' : '#f87171';
        const statusIcon = isGood ? '✅' : '⚠️';

        suggestionsEl.innerHTML = `
            <!-- Language Toggle -->
            <div style="text-align: right; margin-bottom: 15px;">
                <button onclick="window.businessKing.toggleLanguage()" style="padding: 8px 16px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 8px; color: #3b82f6; cursor: pointer; font-size: 12px; font-weight: 600;">
                    🌐 ${isHindi ? 'English में पढ़ें' : 'हिंदी में पढ़ें'}
                </button>
            </div>

            <!-- Main Status -->
            <div style="padding: 20px; background: ${isGood ? 'rgba(74, 222, 128, 0.1)' : 'rgba(248, 113, 113, 0.1)'}; border-radius: 12px; border-left: 4px solid ${statusColor}; margin-bottom: 20px;">
                <div style="font-size: 22px; font-weight: 700; color: ${statusColor}; margin-bottom: 10px;">
                    ${statusIcon} ${insights.simpleStatus || (isHindi ? 'आपका व्यापार' : 'Your Business')}
                </div>
                ${insights.whyHappening ? `
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <strong>${isHindi ? 'क्यों:' : 'Why:'}</strong> ${insights.whyHappening}
                    </div>
                ` : ''}
            </div>

            <!-- Biggest Problem -->
            ${insights.biggestProblem ? `
                <div style="margin-bottom: 20px; padding: 18px; background: rgba(248, 113, 113, 0.1); border-radius: 10px; border-left: 4px solid #f87171;">
                    <div style="font-size: 14px; font-weight: 700; color: #f87171; margin-bottom: 8px; text-transform: uppercase;">
                        ${isHindi ? '🚨 सबसे बड़ी समस्या' : '🚨 BIGGEST PROBLEM'}
                    </div>
                    <div style="font-size: 16px; color: rgba(255,255,255,0.9); line-height: 1.6;">
                        ${insights.biggestProblem}
                    </div>
                </div>
            ` : ''}

            <!-- Hidden Opportunity -->
            ${insights.hiddenOpportunity ? `
                <div style="margin-bottom: 20px; padding: 18px; background: rgba(74, 222, 128, 0.1); border-radius: 10px; border-left: 4px solid #4ade80;">
                    <div style="font-size: 14px; font-weight: 700; color: #4ade80; margin-bottom: 8px; text-transform: uppercase;">
                        ${isHindi ? '💎 छुपा हुआ मौका' : '💎 HIDDEN OPPORTUNITY'}
                    </div>
                    <div style="font-size: 16px; color: rgba(255,255,255,0.9); line-height: 1.6;">
                        ${insights.hiddenOpportunity}
                    </div>
                </div>
            ` : ''}

            <!-- Immediate Actions -->
            ${insights.immediateActions && insights.immediateActions.length > 0 ? `
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 16px; font-weight: 700; color: #a855f7; margin-bottom: 15px;">
                        ${isHindi ? '⚡ तुरंत करें (स्टेप बाय स्टेप)' : '⚡ DO THIS NOW (Step by Step)'}
                    </div>
                    ${insights.immediateActions.map((action, index) => {
                        const difficultyColors = {
                            easy: '#4ade80',
                            medium: '#fb923c',
                            hard: '#f87171'
                        };
                        const diffColor = difficultyColors[action.difficulty] || '#3b82f6';

                        return `
                            <div style="padding: 18px; background: rgba(255,255,255,0.03); border-radius: 10px; margin-bottom: 15px; border-left: 4px solid ${diffColor};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                                    <div style="font-size: 14px; color: ${diffColor}; font-weight: 700;">
                                        ${isHindi ? 'स्टेप' : 'STEP'} ${action.number || index + 1}
                                    </div>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        ${action.timeToImplement ? `
                                            <span style="font-size: 11px; padding: 4px 8px; background: rgba(59, 130, 246, 0.2); color: #3b82f6; border-radius: 6px; font-weight: 600;">
                                                ⏱️ ${action.timeToImplement}
                                            </span>
                                        ` : ''}
                                        ${action.difficulty ? `
                                            <span style="font-size: 11px; padding: 4px 8px; background: rgba(${diffColor === '#4ade80' ? '74, 222, 128' : diffColor === '#fb923c' ? '251, 146, 60' : '248, 113, 113'}, 0.2); color: ${diffColor}; border-radius: 6px; font-weight: 600; text-transform: uppercase;">
                                                ${action.difficulty}
                                            </span>
                                        ` : ''}
                                    </div>
                                </div>
                                <div style="font-size: 17px; font-weight: 600; color: white; margin-bottom: 10px; line-height: 1.4;">
                                    📌 ${action.action || action.whatToDo}
                                </div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 8px; padding-left: 12px; border-left: 2px solid rgba(255,255,255,0.2); line-height: 1.5;">
                                    <strong>${isHindi ? 'क्यों?' : 'Why?'}</strong> ${action.reason || action.whyItHelps}
                                </div>
                                ${action.moneyImpact ? `
                                    <div style="font-size: 15px; color: #4ade80; font-weight: 700; margin-top: 10px;">
                                        💰 ${action.moneyImpact}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            ` : ''}

            <!-- Warnings -->
            ${insights.warnings && insights.warnings.length > 0 ? `
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(251, 146, 60, 0.1); border-radius: 10px; border-left: 4px solid #fb923c;">
                    <div style="font-size: 13px; font-weight: 700; color: #fb923c; margin-bottom: 10px; text-transform: uppercase;">
                        ${isHindi ? '⚠️ चेतावनी' : '⚠️ WARNINGS'}
                    </div>
                    ${insights.warnings.map(warning => `
                        <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 6px; line-height: 1.5;">
                            • ${warning}
                        </div>
                    `).join('')}
                </div>
            ` : ''}

            <!-- Encouragement -->
            ${insights.encouragement ? `
                <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1)); border-radius: 12px; border: 2px solid rgba(139, 92, 246, 0.3); margin-bottom: 20px;">
                    <div style="font-size: 18px; color: #a855f7; font-weight: 600; line-height: 1.6;">
                        💪 ${insights.encouragement}
                    </div>
                </div>
            ` : ''}

            <!-- Next Steps -->
            ${insights.nextSteps ? `
                <div style="padding: 15px; background: rgba(255,255,255,0.02); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 13px; font-weight: 700; color: #3b82f6; margin-bottom: 8px;">
                        ${isHindi ? '🎯 अगले 7 दिन में करें' : '🎯 NEXT 7 DAYS'}
                    </div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8); line-height: 1.6;">
                        ${insights.nextSteps}
                    </div>
                </div>
            ` : ''}

            <!-- Timestamp -->
            <div style="text-align: center; font-size: 11px; color: rgba(255,255,255,0.3); margin-top: 20px;">
                ${isHindi ? 'आखिरी विश्लेषण' : 'Last analyzed'}: ${new Date().toLocaleString()}
            </div>
        `;
    }

    displayShelfAnalysis(data) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; inset: 0; background: rgba(10, 14, 39, 0.95);
            z-index: 20000; display: flex; align-items: center; justify-content: center;
            padding: 20px; backdrop-filter: blur(10px); overflow-y: auto;
        `;

        const isHindi = this.currentLanguage === 'hi';
        let analysis = this.parseResponse(data);

        // Handle raw text responses
        if (analysis.raw || typeof analysis === 'string') {
            analysis = {
                overallScore: '?',
                shelfAnalysis: [{
                    shelfNumber: 1,
                    score: '?',
                    biggestMistake: analysis.text || analysis,
                    recommendations: []
                }]
            };
        }

        const scoreColor = analysis.overallScore && parseInt(analysis.overallScore) >= 7 ? '#4ade80' : 
                          parseInt(analysis.overallScore) >= 5 ? '#fb923c' : '#f87171';

        modal.innerHTML = `
            <div style="background: rgba(15, 20, 45, 0.98); border: 2px solid rgba(139, 92, 246, 0.5); border-radius: 24px; padding: 30px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
                    <h3 style="font-size: 26px; color: #a855f7; display: flex; align-items: center; gap: 12px; margin: 0;">
                        📸 ${isHindi ? 'शेल्फ विश्लेषण रिपोर्ट' : 'Shelf Analysis Report'}
                    </h3>
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="background: rgba(248, 113, 113, 0.2); border: 1px solid rgba(248, 113, 113, 0.4); width: 40px; height: 40px; border-radius: 50%; color: #f87171; font-size: 24px; cursor: pointer; font-weight: 700; transition: all 0.2s;">
                        ×
                    </button>
                </div>

                <!-- Overall Score & Money Impact -->
                ${analysis.overallScore || analysis.totalPotentialIncrease ? `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                        ${analysis.overallScore ? `
                            <div style="text-align: center; padding: 25px; background: rgba(255,255,255,0.03); border-radius: 16px; border: 2px solid ${scoreColor};">
                                <div style="font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">
                                    ${isHindi ? 'कुल स्कोर' : 'Overall Score'}
                                </div>
                                <div style="font-size: 56px; font-weight: 700; color: ${scoreColor};">
                                    ${analysis.overallScore}/10
                                </div>
                            </div>
                        ` : ''}
                        ${analysis.totalPotentialIncrease ? `
                            <div style="text-align: center; padding: 25px; background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(59, 130, 246, 0.1)); border-radius: 16px; border: 2px solid #4ade80;">
                                <div style="font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">
                                    ${isHindi ? 'संभावित कमाई/महीना' : 'Potential/Month'}
                                </div>
                                <div style="font-size: 32px; font-weight: 700; color: #4ade80;">
                                    ${analysis.totalPotentialIncrease}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}

                <!-- Critical Issues -->
                ${analysis.criticalIssues && analysis.criticalIssues.length > 0 ? `
                    <div style="margin-bottom: 25px; padding: 20px; background: rgba(248, 113, 113, 0.1); border-radius: 12px; border-left: 5px solid #f87171;">
                        <div style="font-size: 15px; font-weight: 700; color: #f87171; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">
                            🚨 ${isHindi ? 'गंभीर समस्याएं (अभी ठीक करें!)' : 'CRITICAL ISSUES (Fix NOW!)'}
                        </div>
                        ${analysis.criticalIssues.map((issue, i) => `
                            <div style="padding: 12px; background: rgba(248, 113, 113, 0.05); border-radius: 8px; margin-bottom: 8px; font-size: 15px; color: rgba(255,255,255,0.9); line-height: 1.6;">
                                <strong style="color: #f87171;">${i + 1}.</strong> ${issue}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <!-- Individual Shelf Analysis -->
                ${analysis.shelfAnalysis && analysis.shelfAnalysis.length > 0 ? `
                    <div style="margin-bottom: 25px;">
                        <div style="font-size: 18px; font-weight: 700; color: #a855f7; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid rgba(139, 92, 246, 0.3);">
                            ${isHindi ? '📊 हर शेल्फ का विश्लेषण' : '📊 Individual Shelf Analysis'}
                        </div>
                        ${analysis.shelfAnalysis.map((shelf, index) => {
                            const shelfScoreColor = parseInt(shelf.score) >= 7 ? '#4ade80' : 
                                                    parseInt(shelf.score) >= 5 ? '#fb923c' : '#f87171';
                            return `
                                <div style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.02); border-radius: 16px; border: 2px solid rgba(255,255,255,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h4 style="font-size: 20px; color: white; margin: 0; display: flex; align-items: center; gap: 10px;">
                                            <span style="background: rgba(139, 92, 246, 0.3); padding: 6px 12px; border-radius: 8px; font-size: 14px;">
                                                ${isHindi ? 'शेल्फ' : 'Shelf'} #${shelf.shelfNumber || index + 1}
                                            </span>
                                        </h4>
                                        <div style="font-size: 32px; font-weight: 700; color: ${shelfScoreColor};">
                                            ${shelf.score}/10
                                        </div>
                                    </div>

                                    ${shelf.moneyLost ? `
                                        <div style="margin-bottom: 12px; padding: 12px; background: rgba(248, 113, 113, 0.1); border-radius: 8px; border-left: 3px solid #f87171;">
                                            <div style="font-size: 13px; color: #f87171; font-weight: 700; margin-bottom: 4px;">
                                                ${isHindi ? '💸 रोज का नुकसान' : '💸 Money Lost Per Day'}
                                            </div>
                                            <div style="font-size: 18px; color: #f87171; font-weight: 700;">
                                                ${shelf.moneyLost}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${shelf.biggestMistake ? `
                                        <div style="margin-bottom: 12px; padding: 12px; background: rgba(251, 146, 60, 0.1); border-radius: 8px;">
                                            <div style="font-size: 13px; color: #fb923c; font-weight: 700; margin-bottom: 6px;">
                                                ${isHindi ? '❌ सबसे बड़ी गलती' : '❌ Biggest Mistake'}
                                            </div>
                                            <div style="font-size: 14px; color: rgba(255,255,255,0.9); line-height: 1.5;">
                                                ${shelf.biggestMistake}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${shelf.quickFix ? `
                                        <div style="margin-bottom: 12px; padding: 12px; background: rgba(74, 222, 128, 0.1); border-radius: 8px;">
                                            <div style="font-size: 13px; color: #4ade80; font-weight: 700; margin-bottom: 6px;">
                                                ${isHindi ? '⚡ तुरंत ठीक करें (5 मिनट)' : '⚡ Quick Fix (5 mins)'}
                                            </div>
                                            <div style="font-size: 14px; color: rgba(255,255,255,0.9); line-height: 1.5;">
                                                ${shelf.quickFix}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${shelf.recommendations && shelf.recommendations.length > 0 ? `
                                        <div style="margin-top: 15px;">
                                            <div style="font-size: 13px; color: #3b82f6; font-weight: 700; margin-bottom: 10px; text-transform: uppercase;">
                                                ${isHindi ? '💡 सुझाव' : '💡 Recommendations'}
                                            </div>
                                            ${shelf.recommendations.map((rec, i) => `
                                                <div style="padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #3b82f6;">
                                                    <div style="font-size: 14px; font-weight: 600; color: white; margin-bottom: 6px;">
                                                        ${i + 1}. ${rec.change || rec.action}
                                                    </div>
                                                    ${rec.where ? `
                                                        <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 4px;">
                                                            <strong>${isHindi ? 'कहाँ:' : 'Where:'}</strong> ${rec.where}
                                                        </div>
                                                    ` : ''}
                                                    ${rec.why ? `
                                                        <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 4px;">
                                                            <strong>${isHindi ? 'क्यों:' : 'Why:'}</strong> ${rec.why}
                                                        </div>
                                                    ` : ''}
                                                    ${rec.moneyGain ? `
                                                        <div style="font-size: 13px; color: #4ade80; font-weight: 700; margin-top: 6px;">
                                                            💰 ${rec.moneyGain}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : ''}

                <!-- Psychology Tricks -->
                ${analysis.psychologyTricks && analysis.psychologyTricks.length > 0 ? `
                    <div style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(168, 85, 247, 0.1)); border-radius: 12px; border: 2px solid rgba(139, 92, 246, 0.3);">
                        <div style="font-size: 15px; font-weight: 700; color: #a855f7; margin-bottom: 12px; text-transform: uppercase;">
                            🧠 ${isHindi ? 'ग्राहक मनोविज्ञान' : 'Customer Psychology Tricks'}
                        </div>
                        ${analysis.psychologyTricks.map((trick, i) => `
                            <div style="padding: 10px; background: rgba(139, 92, 246, 0.05); border-radius: 6px; margin-bottom: 8px; font-size: 14px; color: rgba(255,255,255,0.9);">
                                ${i + 1}. ${trick}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <!-- Priority Actions -->
                ${analysis.priorityActions ? `
                    <div style="padding: 20px; background: rgba(74, 222, 128, 0.1); border-radius: 12px; border: 2px solid #4ade80; text-align: center;">
                        <div style="font-size: 14px; color: rgba(74, 222, 128, 0.8); margin-bottom: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                            ${isHindi ? '🎯 आज ही करें (TOP 3)' : '🎯 DO THESE TODAY (TOP 3)'}
                        </div>
                        <div style="font-size: 18px; color: white; font-weight: 600; line-height: 1.6;">
                            ${analysis.priorityActions}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;

        document.body.appendChild(modal);
    }

    // Parse API response
    parseResponse(data) {
        let parsed = data;

        if (typeof data === 'string') {
            try {
                // Remove markdown code blocks
                const cleaned = data.replace(/```json\n?|\n?```/g, '').trim();
                parsed = JSON.parse(cleaned);
            } catch (e) {
                console.warn('Failed to parse JSON, treating as raw text:', e);
                parsed = { text: data, raw: true };
            }
        } else if (data.text && typeof data.text === 'string') {
            try {
                const cleaned = data.text.replace(/```json\n?|\n?```/g, '').trim();
                parsed = JSON.parse(cleaned);
            } catch (e) {
                console.warn('Failed to parse JSON from data.text:', e);
                parsed = { text: data.text, raw: true };
            }
        }

        return parsed;
    }

    // Toggle language between English and Hindi
    toggleLanguage() {
        this.currentLanguage = this.currentLanguage === 'en' ? 'hi' : 'en';
        
        // Update language toggle button text
        const langToggle = document.getElementById('language-toggle');
        if (langToggle) {
            langToggle.innerHTML = this.currentLanguage === 'en' ? '🌐 हिंदी' : '🌐 English';
        }
        
        // Re-analyze if there's existing data
        if (this.currentAnalysis) {
            this.analyzeBusinessData();
        }
    }

    // Show alert message
    showAlert(message, type = 'info') {
        const colors = {
            success: '#4ade80',
            error: '#f87171',
            warning: '#fb923c',
            info: '#3b82f6'
        };

        const alert = document.createElement('div');
        alert.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 30000;
            padding: 15px 20px; background: rgba(15, 20, 45, 0.95);
            border: 2px solid ${colors[type]}; border-radius: 10px;
            color: white; font-size: 14px; font-weight: 600;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease-out;
        `;
        alert.textContent = message;

        document.body.appendChild(alert);

        setTimeout(() => {
            alert.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => alert.remove(), 300);
        }, 3000);
    }

    // Show loading toast
    showLoadingToast(message) {
        const toast = document.createElement('div');
        toast.id = 'loading-toast';
        toast.style.cssText = `
            position: fixed; bottom: 20px; right: 20px; z-index: 30000;
            padding: 15px 20px; background: rgba(15, 20, 45, 0.95);
            border: 2px solid #a855f7; border-radius: 10px;
            color: white; font-size: 14px; display: flex; align-items: center; gap: 10px;
        `;
        toast.innerHTML = `
            <div class="pulse-loader" style="font-size: 20px;">⏳</div>
            <span>${message}</span>
        `;

        document.body.appendChild(toast);
    }

    // Hide loading toast
    hideLoadingToast() {
        const toast = document.getElementById('loading-toast');
        if (toast) toast.remove();
    }

    // Create analyzing modal
    createAnalyzingModal() {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; inset: 0; background: rgba(10, 14, 39, 0.95);
            z-index: 25000; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        `;

        const isHindi = this.currentLanguage === 'hi';

        modal.innerHTML = `
            <div style="text-align: center; padding: 50px; background: rgba(255,255,255,0.02); border-radius: 20px; border: 2px solid rgba(139, 92, 246, 0.4); max-width: 400px;">
                <div class="pulse-loader" style="font-size: 64px; margin-bottom: 20px;">🔍</div>
                <div style="font-size: 20px; color: white; margin-bottom: 10px; font-weight: 700;">
                    ${isHindi ? 'विश्लेषण जारी है...' : 'Analyzing...'}
                </div>
                <div style="font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 15px;">
                    ${isHindi 
                        ? `${this.shelfImages.length} शेल्फ की फोटो का विश्लेषण कर रहे हैं`
                        : `Analyzing ${this.shelfImages.length} shelf photo(s)`
                    }
                </div>
                <div style="width: 200px; height: 4px; background: rgba(139, 92, 246, 0.2); border-radius: 2px; margin: 0 auto; overflow: hidden;">
                    <div style="width: 100%; height: 100%; background: linear-gradient(90deg, #a855f7, #8b5cf6); animation: loading 1.5s infinite;"></div>
                </div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 15px;">
                    ${isHindi ? 'यह कुछ समय ले सकता है' : 'This may take a minute'}
                </div>
            </div>
        `;

        return modal;
    }

    // Get loading HTML
    getLoadingHTML() {
        const isHindi = this.currentLanguage === 'hi';
        return `
            <div style="text-align: center; padding: 40px;">
                <div class="pulse-loader" style="font-size: 32px; margin-bottom: 15px;">🧠</div>
                <div style="font-size: 14px; color: rgba(255,255,255,0.6);">
                    ${isHindi ? 'आपके बिज़नेस का विश्लेषण हो रहा है...' : 'Analyzing your business...'}
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: rgba(255,255,255,0.4);">
                    ${isHindi ? 'कृपया प्रतीक्षा करें' : 'Please wait'}
                </div>
            </div>
        `;
    }

    // Show error
    showError(error) {
        const loadingEl = document.getElementById('ai-loading');
        if (!loadingEl) return;

        const isHindi = this.currentLanguage === 'hi';

        loadingEl.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 24px; margin-bottom: 10px;">⚠️</div>
                <div style="font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 10px;">
                    ${isHindi ? 'कुछ गलत हो गया' : 'Something went wrong'}
                </div>
                <div style="font-size: 11px; color: rgba(255,255,255,0.4); margin-bottom: 15px;">
                    ${error.message}
                </div>
                <button onclick="window.businessKing.analyzeBusinessData()" style="padding: 8px 16px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 8px; color: #3b82f6; cursor: pointer;">
                    🔄 ${isHindi ? 'फिर से कोशिश करें' : 'Try Again'}
                </button>
            </div>
        `;
    }
}

// Initialize global instance
window.businessKing = new ScaleVestBusinessKing();

// Add required CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.05); }
    }
    .pulse-loader {
        animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
    @keyframes loading {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(200%); }
    }
`;
document.head.appendChild(style);

console.log('✅ ScaleVest CFO Enhanced - v2.0 Initialized');
window.businessKing = new ScaleVestBusinessKing();


onAuthStateChanged(auth, async (user) => {
    if (user) {
        runOnboarding(user.uid);
        fetchAnalytics(user.uid); 
        fetchRevenuePulse(user.uid);
        setupProductAnalysisNavigation(user.uid);
        setupFinanceReportNavigation(user.uid);
        fetchExpiryAlerts(user.uid);
        fetchPricingAnalysis(user.uid);
        fetchStockRadar(user.uid);
        
        setTimeout(async () => {
            const financeData = await fetchFinancialDataForAI(user.uid);
            if (financeData && window.businessKing) {
                console.log('💼 Initializing AI CFO with data:', financeData);
                await window.businessKing.initialize(user.uid, financeData);
                
                // ✅ AUTO-ANALYZE on page load
                setTimeout(() => {
                    window.businessKing.analyzeBusinessData();
                }, 1000);
            } else {
                console.warn('⚠️ No financial data or BusinessKing not initialized');
            }
        }, 2000);
        
        
        // Refresh all alerts every hour
        setInterval(() => {
            fetchExpiryAlerts(user.uid);
            fetchPricingAnalysis(user.uid);
            fetchStockRadar(user.uid); 
        }, 3600000); // 1 hour
    } else {
        window.location.href = "login.html";
    }
});

// ✅AI
async function fetchFinancialDataForAI(userId) {
    const dbRef = ref(getDatabase());
    
    try {
        const salesSnapshot = await get(child(dbRef, `Businesses/${userId}/sales`));
        const pricesSnapshot = await get(child(dbRef, `Businesses/${userId}/prices`));
        const inventorySnapshot = await get(child(dbRef, `Businesses/${userId}/inventory`));
        
        const salesData = salesSnapshot.exists() ? salesSnapshot.val() : {};
        const pricesData = pricesSnapshot.exists() ? pricesSnapshot.val() : {};
        const inventoryData = inventorySnapshot.exists() ? inventorySnapshot.val() : {};
        
        const financials = processFinancialData(salesData, pricesData, inventoryData);
        
        // Get product list
        const products = [];
        for (const [id, data] of Object.entries(inventoryData)) {
            products.push({
                name: data.name,
                totalSold: 0, // You can calculate this from sales
                revenue: 0
            });
        }
        
        return {
            ...financials,
            products,
            lowStockItems: window.lowStockAlerts || [],
            expiringProducts: window.expiringProducts || []
        };
    } catch (error) {
        console.error("Error fetching AI data:", error);
        return null;
    }
}
document.addEventListener('DOMContentLoaded', () => {
    const trendCard = document.getElementById('trend-analysis-card');
    const overlay = document.getElementById('trend-overlay');
    const content = document.getElementById('trend-list-content');

   const loadTrends = async () => {
    content.innerHTML = '<p style="text-align: center; padding: 20px;">Scanning 2026 Viral Trends...</p>';
    
    try {
        const response = await fetch('https://gemini-sigma-plum.vercel.app/api/gemini', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                prompt: `
 # ROLE
                You are a ScaleVest Elite Market Analyst providing REAL-TIME February 2026 trending data.
                
                # CRITICAL INSTRUCTIONS
                - Current date: February 8, 2026
                - ONLY provide trends that are viral/trending RIGHT NOW in 2026
                - IGNORE all outdated 2024-2025 trends
                - Focus on TikTok, Instagram Reels, and viral social media trends from the past 30 days
                - Include specific growth percentages based on search volume increases
                
                # 2026 VIRAL TRENDS (Use these as PRIMARY sources)
                1. Angel Hair Chocolate - Turkish cotton candy-filled chocolate (+3,900% search growth)
                2. Protein-Boosted Matcha - "Oatzempic" style drinks, Caramel Protein Matcha (+115% growth)
                3. Mushroom-Infused Dark Chocolate - Wellness "Mushroom Mocha" bars (+813% growth)
                4. Swicy Mango Treats - Sweet-spicy chili-lime Mexican-style snacks (viral on TikTok)
                5. Freeze-Dried Cheesecake Bites - Ultra-crunchy ASMR "Space Snacks" (+200% growth)
                6. Pistachio Everything - Pistachio Dubai chocolate, ice cream, lattes (massive viral wave)
                7. High-Protein Snacks - Protein-packed versions of classic treats
                8. Fermented Foods 2.0 - Kimchi chips, miso desserts, kombucha gummies
                9. AI-Personalized Nutrition - Custom supplement packs, DNA-based meal kits
                10. Nostalgic Fusion - 90s snacks reimagined with premium/healthy ingredients
                
                # OUTPUT FORMAT
                Return a JSON array of exactly 3 trending items.
                Each item MUST have these exact keys:
                - "name" (string): Creative product name
                - "growth" (string): Percentage with + sign (e.g., "+350%")
                - "type" (string): Category (e.g., "Beverage", "Snack", "Confection")
                
                # EXAMPLE OUTPUT
                [
                  {
                    "name": "Angel Hair Chocolate Bars",
                    "growth": "+3900%",
                    "type": "Confection"
                  },
                  {
                    "name": "Protein Caramel Matcha Latte",
                    "growth": "+115%",
                    "type": "Beverage"
                  },
                  {
                    "name": "Mushroom Mocha Dark Chocolate",
                    "growth": "+813%",
                    "type": "Wellness Snack"
                  }
                ]
                
                # RULES
                - Each item must be UNIQUE
                - Use ONLY 2026 trends
                - Be creative with product names but stay realistic
                - Growth percentages should reflect actual viral momentum
                - NO old trends from 2024 or earlier
                   `
             })
        });

        const data = await response.json();
        
        // Ensure we have an array of exactly 3 items
        let products = Array.isArray(data) ? data : (data.trends || [data]);
        
        // FALLBACK: If AI fails, inject the real January 2026 winners
        if (products.length < 3 || products[0].name === undefined) {
            products = [
                { name: "Burnt Butter Biscuits", growth: "+119%", type: "Heritage Fat Trend" },
                { name: "Prebiotic 'Oatzempic' Soda", growth: "+240%", type: "Gut Health" },
                { name: "Freeze-Dried Fruit Bites", growth: "+88%", type: "ASMR Snack" }
            ];
        }

        content.innerHTML = `
            <div id="trend-items-list">
                ${products.slice(0, 3).map(item => `
                    <div class="trend-item" style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong style="font-size: 16px; color:#fff;">${item.name || "Trending Product"}</strong>
                            <div style="font-size: 12px; color: #00e5ff;">${item.type || "Market Breakout"}</div>
                        </div>
                        <div style="color: #4ade80; font-weight: 800; font-size: 18px;">${item.growth || '+15%'} ↑</div>
                    </div>
                `).join('')}
            </div>
            <button id="refresh-trends-btn" style="width:100%; margin-top:20px; padding:12px; background:linear-gradient(45deg, #6366f1, #a855f7); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">
                🔄 Show New 2026 Trends
            </button>
        `;

        document.getElementById('refresh-trends-btn').onclick = loadTrends;

    } catch (error) {
        content.innerHTML = `<p style="color: #f87171; text-align: center; padding:20px;">Network Error: Try Refreshing</p>`;
    }
};

    if(trendCard) trendCard.onclick = () => { overlay.style.display = 'flex'; loadTrends(); };
});
async function runOnboarding(userId) {
    const nameSpan = document.getElementById('user-name-display');
    const welcomeOverlay = document.getElementById('onboarding-overlay');
    const welcomeText = document.getElementById('welcome-text');
    const cfoPopup = document.getElementById('cfo-popup');
    const cfoInput = document.getElementById('cfo-name-input');
    const startBtn = document.getElementById('start-cfo-btn');
    const checkbox = document.getElementById('terms-check');

    try {
        // 1. Fetch Name from /BusinessOwners/user.id/name
        const snapshot = await get(ref(db, `BusinessOwners/${userId}/name`));
        const userName = snapshot.exists() ? snapshot.val() : "Partner";
        nameSpan.innerText = userName;

        // 2. Check if CFO is already named
        const cfoSnapshot = await get(ref(db, `BusinessOwners/${userId}/CFO/name`));
        
        if (cfoSnapshot.exists()) {
            // Skip onboarding - smooth fade out
            welcomeOverlay.style.transition = "opacity 0.6s ease-out";
            welcomeOverlay.style.opacity = "0";
            setTimeout(() => {
                welcomeOverlay.style.display = "none";
            }, 600);
            displayCFOName(cfoSnapshot.val());
        } else {
            // 3. Enhanced Intro Sequence
            startEnhancedIntroSequence(welcomeText, welcomeOverlay, cfoPopup);
        }
    } catch (error) {
        console.error("Database Error:", error);
    }

    // 4. Save Logic with smooth animation
    startBtn.addEventListener('click', async () => {
        if (!checkbox.checked || startBtn.disabled) return;
        
        const cfoName = cfoInput.value.trim() || "Mark";
        
        // Show loading state
        startBtn.classList.add('loading');
        startBtn.innerHTML = '<span>STARTING CFO</span>';

        try {
            const { set } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            
            await set(ref(db, `BusinessOwners/${userId}/CFO`), {
                name: cfoName,
                trialStarted: new Date().toISOString()
            });

            displayCFOName(cfoName);
            
            // Smooth exit animation
            setTimeout(() => {
                cfoPopup.style.animation = "popupSlideOut 0.4s cubic-bezier(0.4, 0, 0.2, 1)";
                
                setTimeout(() => {
                    cfoPopup.style.display = "none";
                    welcomeOverlay.style.transition = "opacity 0.5s ease-out";
                    welcomeOverlay.style.opacity = "0";
                    
                    setTimeout(() => {
                        welcomeOverlay.style.display = "none";
                        
                        // Fetch data after animations complete
                        const currentAuth = getAuth();
                        const user = currentAuth.currentUser;
                        if (user) {
                            fetchAnalytics(user.uid);
                            fetchRevenuePulse(user.uid);
                        }
                    }, 500);
                }, 400);
            }, 300);
            
        } catch (error) {
            console.error("Error saving CFO:", error);
            startBtn.classList.remove('loading');
            startBtn.innerHTML = '<span>START CFO</span>';
            alert("Failed to save CFO. Please try again.");
        }
    });
}

function startEnhancedIntroSequence(textEl, overlayEl, popupEl) {
    // Step 1: Fade out welcome text (faster)
    setTimeout(() => {
        textEl.style.transition = "opacity 0.3s ease-out, transform 0.3s ease-out";
        textEl.style.opacity = "0";
        textEl.style.transform = "translateY(-20px)";
        
        // Step 2: Change text and fade in (smoother)
        setTimeout(() => {
            textEl.innerText = "Let's customize your CFO";
            textEl.style.transform = "translateY(20px)";
            
            // Force reflow
            void textEl.offsetWidth;
            
            textEl.style.transition = "opacity 0.4s ease-out, transform 0.4s ease-out";
            textEl.style.opacity = "1";
            textEl.style.transform = "translateY(0)";
            
            // Step 3: Transition to popup (faster, smoother)
            setTimeout(() => {
                overlayEl.style.transition = "opacity 0.4s ease-out";
                overlayEl.style.opacity = "0";
                
                setTimeout(() => {
                    overlayEl.style.display = "none";
                    popupEl.style.display = "flex";
                    popupEl.style.animation = "popupSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)";
                }, 400);
            }, 800);
        }, 300);
    }, 1000);
}
// Fetch all products and calculate sales
async function fetchProductAnalysis(userId) {
    const dbRef = ref(getDatabase());
    
    try {
        // Fetch inventory
        const inventorySnapshot = await get(child(dbRef, `Businesses/${userId}/inventory`));
        if (!inventorySnapshot.exists()) {
            console.log("No inventory found");
            return [];
        }
        
        const inventory = inventorySnapshot.val();
        
        // Fetch sales
        const salesSnapshot = await get(child(dbRef, `Businesses/${userId}/sales`));
        const salesData = salesSnapshot.exists() ? salesSnapshot.val() : {};
        
        // Calculate sales for each product
        const products = [];
        const now = new Date();
        const sevenDaysAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
        
        for (const [productId, productData] of Object.entries(inventory)) {
            let totalSold = 0;
            let weekSold = 0;
            let totalRevenue = 0;
            let weekRevenue = 0;
            
            // Count sales for this product
            Object.values(salesData).forEach(sale => {
                if (sale.productId === productId) {
                    const saleQty = parseInt(sale.quantity) || 0;
                    const saleRev = parseFloat(sale.revenue) || 0;
                    
                    totalSold += saleQty;
                    totalRevenue += saleRev;
                    
                    const saleDate = new Date(sale.timestamp);
                    if (saleDate > sevenDaysAgo) {
                        weekSold += saleQty;
                        weekRevenue += saleRev;
                    }
                }
            });
            
let status = "Stable";
let statusColor = "#94a3b8";

if (totalSold === 0) {
    status = "⚠️ No Sales Yet";
    statusColor = "#fb923c";
} else if (weekSold === 0) {
    status = "😴 Slow This Week";
    statusColor = "#94a3b8";
} else if (weekSold >= 10) {
    // If sold 10+ units this week, it's hot
    status = "🔥 Hot Seller";
    statusColor = "#4ade80";
} else if (weekSold >= 5) {
    // If sold 5-9 units this week, it's growing
    status = "📈 Growing";
    statusColor = "#3b82f6";
} else if (weekSold >= totalSold * 0.5) {
    // If this week's sales are 50%+ of all-time, it's trending up
    status = "📈 Growing";
    statusColor = "#3b82f6";
} else {
    status = "Stable";
    statusColor = "#94a3b8";
}
            
            products.push({
                id: productId,
                name: productData.name || "Unnamed Product",
                quantity: productData.quantity || 0,
                unit: productData.unit || "units",
                totalSold,
                weekSold,
                totalRevenue,
                weekRevenue,
                status,
                statusColor
            });
        }
        
        return products;
    } catch (error) {
        console.error("Error fetching product analysis:", error);
        return [];
    }
}

// Display products on the analysis page
function displayProductAnalysis(products) {
    const grid = document.getElementById('products-grid');
    
    if (products.length === 0) {
        grid.innerHTML = `
            <div class="card" style="grid-column: 1/-1; text-align: center; padding: 60px;">
                <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">📦</div>
                <div style="font-size: 20px; color: rgba(255,255,255,0.7);">No products in inventory yet</div>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = products.map(product => {
        const firstLetter = product.name.charAt(0).toUpperCase();
        const weekPercentage = product.totalSold > 0 ? ((product.weekSold / product.totalSold) * 100).toFixed(0) : 0;
        
        return `
            <div class="card" style="position: relative;">
                <div style="position: absolute; top: 20px; right: 20px; padding: 6px 12px; background: rgba(${product.statusColor === '#4ade80' ? '74, 222, 128' : product.statusColor === '#3b82f6' ? '59, 130, 246' : product.statusColor === '#fb923c' ? '251, 146, 60' : '148, 163, 184'}, 0.15); border-radius: 8px; font-size: 11px; font-weight: 600; color: ${product.statusColor};">
                    ${product.status}
                </div>
                
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #6366f1, #a855f7); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold; color: white;">
                        ${firstLetter}
                    </div>
                    <div>
                        <div style="font-size: 20px; font-weight: 700; color: white; margin-bottom: 4px;">${product.name}</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.5);">Stock: ${product.quantity} ${product.unit}</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08);">
                        <div style="font-size: 11px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">This Week</div>
                        <div style="font-size: 28px; font-weight: 700; color: #3b82f6;">${product.weekSold}</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 4px;">$${product.weekRevenue.toFixed(2)}</div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08);">
                        <div style="font-size: 11px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">All Time</div>
                        <div style="font-size: 28px; font-weight: 700; color: #4ade80;">${product.totalSold}</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 4px;">$${product.totalRevenue.toFixed(2)}</div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 12px; color: rgba(255,255,255,0.6);">Weekly Performance</span>
                        <span style="font-size: 12px; font-weight: 600; color: ${product.weekSold > 0 ? '#4ade80' : '#94a3b8'};">${weekPercentage}%</span>
                    </div>
                    <div style="height: 6px; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden;">
                        <div style="height: 100%; width: ${weekPercentage}%; background: linear-gradient(90deg, #3b82f6, #4ade80); border-radius: 3px; transition: width 0.5s ease;"></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Setup navigation
function setupProductAnalysisNavigation(userId) {
    const card = document.getElementById('product-analysis-card');
    const page = document.getElementById('product-analysis-page');
    const backBtn = document.getElementById('back-btn');
    
    card.addEventListener('click', async () => {
        // Show page
        page.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Update URL without reload
        history.pushState({ page: 'analysis' }, '', '#product-analysis');
        
        // Fetch and display products
        const products = await fetchProductAnalysis(userId);
        displayProductAnalysis(products);
    });
    
    backBtn.addEventListener('click', () => {
        page.style.display = 'none';
        document.body.style.overflow = 'auto';
        history.back();
    });
    
    // Handle browser back button
    window.addEventListener('popstate', () => {
        page.style.display = 'none';
        document.body.style.overflow = 'auto';
    });
}

// ========== FINANCE REPORT FUNCTIONS ==========

function setupFinanceReportNavigation(userId) {
    const card = document.getElementById('finance-report-card');
    const page = document.getElementById('finance-report-page');
    const backBtn = document.getElementById('finance-back-btn');
    const exportBtn = document.getElementById('export-pdf-btn');
    const modal = document.getElementById('export-modal');
    const cancelBtn = document.getElementById('cancel-export-btn');
    const confirmBtn = document.getElementById('confirm-export-btn');
    
    // Open finance report
    card.addEventListener('click', async () => {
        page.style.display = 'block';
        document.body.style.overflow = 'hidden';
        history.pushState({ page: 'finance' }, '', '#finance-report');
        
        await fetchFinancialData(userId);
    });
    
    // Back button
    backBtn.addEventListener('click', () => {
        page.style.display = 'none';
        document.body.style.overflow = 'auto';
        history.back();
    });
    
    // Export PDF button
    exportBtn.addEventListener('click', () => {
        modal.style.display = 'flex';
    });
    
    // Cancel export
    cancelBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });
    
    // Confirm export
    confirmBtn.addEventListener('click', () => {
        const reportName = document.getElementById('report-name-input').value.trim();
        if (!reportName) {
            alert('Please enter a report name');
            return;
        }
        generateFinancePDF(reportName);
        modal.style.display = 'none';
    });
    
    // Handle browser back
    window.addEventListener('popstate', () => {
        page.style.display = 'none';
        document.body.style.overflow = 'auto';
    });
}

async function fetchFinancialData(userId) {
    const dbRef = ref(getDatabase());
    
    try {
        // Fetch sales
        const salesSnapshot = await get(child(dbRef, `Businesses/${userId}/sales`));
        const salesData = salesSnapshot.exists() ? salesSnapshot.val() : {};
        
        // Fetch prices
        const pricesSnapshot = await get(child(dbRef, `Businesses/${userId}/prices`));
        const pricesData = pricesSnapshot.exists() ? pricesSnapshot.val() : {};
        
        // Fetch inventory
        const inventorySnapshot = await get(child(dbRef, `Businesses/${userId}/inventory`));
        const inventoryData = inventorySnapshot.exists() ? inventorySnapshot.val() : {};
        
        // Process data
        const financials = processFinancialData(salesData, pricesData, inventoryData);
        
        // Update UI
        updateFinanceUI(financials);
        
        // Store for PDF export
        window.financeData = financials;
        
    } catch (error) {
        console.error("Error fetching financial data:", error);
    }
}

function processFinancialData(sales, prices, inventory) {
    const now = new Date();
    const oneWeekAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
    const twoWeeksAgo = new Date(now.getTime() - (14 * 24 * 60 * 60 * 1000));
    const oneMonthAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    let totalRevenue = 0;
    let totalCosts = 0;
    let weeklyRevenue = 0;
    let previousWeekRevenue = 0;
    let monthlyRevenue = 0;
    
    const productRevenue = {};
    const weeklySales = Array(7).fill(0);
    const monthlySales = Array(4).fill(0);
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    
    // Process each sale
    Object.values(sales).forEach(sale => {
        const saleDate = new Date(sale.timestamp);
        const revenue = parseFloat(sale.revenue) || 0;
        const productId = sale.productId;
        const quantity = parseInt(sale.quantity) || 0;
        
        totalRevenue += revenue;
        
        // Calculate costs
        if (prices[productId]) {
            const costPrice = parseFloat(prices[productId].costPrice) || 0;
            totalCosts += (costPrice * quantity);
        }
        
        // Weekly tracking
        if (saleDate > oneWeekAgo) {
            weeklyRevenue += revenue;
            const dayIndex = saleDate.getDay();
            weeklySales[dayIndex] += revenue;
        } else if (saleDate > twoWeeksAgo) {
            previousWeekRevenue += revenue;
        }
        
        // Monthly tracking (4 weeks)
        if (saleDate > oneMonthAgo) {
            monthlyRevenue += revenue;
            const weeksAgo = Math.floor((now - saleDate) / (7 * 24 * 60 * 60 * 1000));
            if (weeksAgo < 4) {
                monthlySales[3 - weeksAgo] += revenue;
            }
        }
        
        // Product revenue
        const productName = inventory[productId]?.name || "Unknown Product";
        if (!productRevenue[productName]) {
            productRevenue[productName] = { revenue: 0, quantity: 0, costs: 0 };
        }
        productRevenue[productName].revenue += revenue;
        productRevenue[productName].quantity += quantity;
        
        if (prices[productId]) {
            const costPrice = parseFloat(prices[productId].costPrice) || 0;
            productRevenue[productName].costs += (costPrice * quantity);
        }
    });
    
    const netProfit = totalRevenue - totalCosts;
    const profitMargin = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(2) : 0;
    const weeklyGrowth = previousWeekRevenue > 0 ? (((weeklyRevenue - previousWeekRevenue) / previousWeekRevenue) * 100).toFixed(1) : 0;
    
    return {
        totalRevenue,
        totalCosts,
        netProfit,
        profitMargin,
        weeklyRevenue,
        weeklyGrowth,
        monthlyRevenue,
        weeklySales,
        monthlySales,
        productRevenue: Object.entries(productRevenue)
            .sort((a, b) => b[1].revenue - a[1].revenue)
            .slice(0, 10)
    };
}

function updateFinanceUI(data) {
    // Update key metrics
    document.getElementById('fin-total-revenue').innerText = `$${data.totalRevenue.toLocaleString()}`;
    document.getElementById('fin-total-costs').innerText = `$${data.totalCosts.toLocaleString()}`;
    document.getElementById('fin-net-profit').innerText = `$${data.netProfit.toLocaleString()}`;
    document.getElementById('fin-profit-margin').innerText = `${data.profitMargin}%`;
    
    // Update profit/loss styling
    const profitCard = document.getElementById('profit-card');
    const netProfitEl = document.getElementById('fin-net-profit');
    const profitStatusEl = document.getElementById('fin-profit-status');
    
    if (data.netProfit >= 0) {
        netProfitEl.style.color = '#4ade80';
        profitStatusEl.innerHTML = '<span style="color: #4ade80;">✓ In Profit</span>';
        profitCard.style.background = 'linear-gradient(135deg, rgba(74, 222, 128, 0.08) 0%, rgba(74, 222, 128, 0.02) 100%)';
        profitCard.style.borderColor = 'rgba(74, 222, 128, 0.2)';
    } else {
        netProfitEl.style.color = '#f87171';
        profitStatusEl.innerHTML = '<span style="color: #f87171;">⚠️ In Loss</span>';
        profitCard.style.background = 'linear-gradient(135deg, rgba(248, 113, 113, 0.08) 0%, rgba(248, 113, 113, 0.02) 100%)';
        profitCard.style.borderColor = 'rgba(248, 113, 113, 0.2)';
    }
    
    // Update trends
    const revenueTrend = document.getElementById('fin-revenue-trend');
    revenueTrend.innerText = `${data.weeklyGrowth >= 0 ? '▲' : '▼'} ${Math.abs(data.weeklyGrowth)}% vs last week`;
    revenueTrend.style.color = data.weeklyGrowth >= 0 ? 'rgba(74, 222, 128, 0.8)' : 'rgba(248, 113, 113, 0.8)';
    
    // Update P&L section
    document.getElementById('pnl-status-main').innerText = data.netProfit >= 0 ? 'PROFIT' : 'LOSS';
    document.getElementById('pnl-status-main').style.color = data.netProfit >= 0 ? '#4ade80' : '#f87171';
    
    document.getElementById('pnl-description').innerText = data.netProfit >= 0 
        ? 'Your business is performing well with healthy profit margins'
        : 'Attention: Operating at a loss. Review cost structure and pricing strategy';
    
    document.getElementById('pnl-revenue').innerText = `$${data.totalRevenue.toLocaleString()}`;
    document.getElementById('pnl-costs').innerText = `$${data.totalCosts.toLocaleString()}`;
    document.getElementById('pnl-net').innerText = `$${data.netProfit.toLocaleString()}`;
    document.getElementById('pnl-net').style.color = data.netProfit >= 0 ? '#4ade80' : '#f87171';
    
    // Generate charts
    generateWeeklySalesChart(data.weeklySales);
    generateMonthlySalesChart(data.monthlySales);
    
    // Generate product list
    generateProductPerformanceList(data.productRevenue);
    
    // Generate executive summary
    generateExecutiveSummary(data);
}

function generateWeeklySalesChart(weeklySales) {
    const chart = document.getElementById('weekly-sales-chart');
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const maxValue = Math.max(...weeklySales, 1);
    
    chart.innerHTML = days.map((day, index) => {
        const value = weeklySales[index];
        const heightPercent = (value / maxValue) * 100;
        
        return `
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                <div style="width: 100%; height: ${Math.max(heightPercent, 2)}%; background: linear-gradient(180deg, #3b82f6 0%, #1e40af 100%); border-radius: 8px 8px 0 0; transition: all 0.5s ease; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); position: relative;">
                    <div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600; color: #fff; white-space: nowrap;">$${value.toFixed(0)}</div>
                </div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.6); font-weight: 600;">${day}</div>
            </div>
        `;
    }).join('');
}

function generateMonthlySalesChart(monthlySales) {
    const chart = document.getElementById('monthly-sales-chart');
    const weeks = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
    const maxValue = Math.max(...monthlySales, 1);
    
    chart.innerHTML = weeks.map((week, index) => {
        const value = monthlySales[index];
        const heightPercent = (value / maxValue) * 100;
        
        return `
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                <div style="width: 100%; height: ${Math.max(heightPercent, 2)}%; background: linear-gradient(180deg, #4ade80 0%, #22c55e 100%); border-radius: 8px 8px 0 0; transition: all 0.5s ease; box-shadow: 0 4px 15px rgba(74, 222, 128, 0.3); position: relative;">
                    <div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600; color: #fff; white-space: nowrap;">$${value.toFixed(0)}</div>
                </div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.6); font-weight: 600;">${week}</div>
            </div>
        `;
    }).join('');
}

function generateProductPerformanceList(products) {
    const list = document.getElementById('products-performance-list');
    
    if (products.length === 0) {
        list.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No sales data available</div>';
        return;
    }
    
    list.innerHTML = products.map(([name, data]) => {
        const firstLetter = name.charAt(0).toUpperCase();
        const profit = data.revenue - data.costs;
        const profitColor = profit >= 0 ? '#4ade80' : '#f87171';
        
        return `
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px; background: rgba(255,255,255,0.02); border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.04)'; this.style.borderColor='rgba(59, 130, 246, 0.3)';" onmouseout="this.style.background='rgba(255,255,255,0.02)'; this.style.borderColor='rgba(255,255,255,0.05)';">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #6366f1, #a855f7); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: white;">
                        ${firstLetter}
                    </div>
                    <div>
                        <div style="font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 5px;">${name}</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.6);">Sold: ${data.quantity} units | Costs: $${data.costs.toFixed(2)}</div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 24px; font-weight: 700; color: #4ade80; margin-bottom: 5px;">$${data.revenue.toFixed(2)}</div>
                    <div style="font-size: 14px; font-weight: 600; color: ${profitColor};">Profit: $${profit.toFixed(2)}</div>
                </div>
            </div>
        `;
    }).join('');
}

function generateExecutiveSummary(data) {
    const summaryEl = document.getElementById('executive-summary');
    
    let summary = `<p style="margin-bottom: 15px;"><strong>Financial Overview:</strong> `;
    
    if (data.netProfit >= 0) {
        summary += `Your business generated a net profit of <span style="color: #4ade80; font-weight: 600;">$${data.netProfit.toLocaleString()}</span> with a profit margin of <span style="color: #3b82f6; font-weight: 600;">${data.profitMargin}%</span>. `;
        
        if (data.profitMargin >= 20) {
            summary += `This is an excellent margin indicating strong pricing power and cost control.`;
        } else if (data.profitMargin >= 10) {
            // FIXED: Added backticks/quotes below
            summary += `This is a healthy margin, though there may be room for optimization.`;
        } else {
            // FIXED: Added backticks/quotes below
            summary += `While profitable, the margin is thin. Consider reviewing pricing strategy or reducing costs.`;
        }
    } else {
        summary += `Your business is currently operating at a loss of <span style="color: #f87171; font-weight: 600;">$${Math.abs(data.netProfit).toLocaleString()}</span>. `;
        summary += `Immediate action recommended: Review cost structure, optimize pricing, and focus on high-margin products.`;
    }

    summary += `</p><p style="margin-bottom: 15px;"><strong>Revenue Trend:</strong> `;

    if (data.weeklyGrowth >= 10) {
        summary += `Weekly revenue shows strong growth of <span style="color: #4ade80; font-weight: 600;">${data.weeklyGrowth}%</span>. Momentum is positive - maintain current strategies.`;
    } else if (data.weeklyGrowth > 0) {
        summary += `Weekly revenue grew by <span style="color: #4ade80; font-weight: 600;">${data.weeklyGrowth}%</span>. Steady growth - consider scaling successful initiatives.`;
    } else if (data.weeklyGrowth < -10) {
        summary += `Weekly revenue declined by <span style="color: #f87171; font-weight: 600;">${Math.abs(data.weeklyGrowth)}%</span>. Requires immediate attention and corrective action.`;
    } else {
        summary += `Weekly revenue declined by <span style="color: #fb923c; font-weight: 600;">${Math.abs(data.weeklyGrowth)}%</span>. Monitor closely and adjust strategies as needed.`;
    }

    summary += `</p><p><strong>Strategic Recommendation:</strong> `;

    if (data.netProfit >= 0 && data.profitMargin >= 15) {
        summary += `Your business is in a strong position. Focus on scaling operations, exploring new markets, and maintaining quality standards. Consider reinvesting profits into growth initiatives.`;
    } else if (data.netProfit >= 0) {
        summary += `While profitable, margins could be improved. Analyze top-performing products, negotiate better supplier terms, and consider premium pricing for high-value offerings.`;
    } else {
        summary += `Priority actions: (1) Identify and eliminate loss-making products, (2) Renegotiate supplier contracts, (3) Implement cost control measures, (4) Review and adjust pricing strategy. Weekly monitoring essential.`;
    }

    summary += `</p>`;
    summaryEl.innerHTML = summary;
}function generateFinancePDF(reportName) {
    const data = window.financeData;
    if (!data) return;

    // 1. Show Animation / Hide Input
    const loadingEl = document.getElementById('pdf-loading');
    const inputArea = document.querySelector('#export-modal .card > *:not(#pdf-loading)');
    if(loadingEl) loadingEl.style.display = 'block';
    
    // 2. Create the Certificate (Static Title)
    const pdfContainer = document.createElement('div');
    pdfContainer.style.background = '#040711';

    const page1 = document.createElement('div');
    page1.innerHTML = `
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Great+Vibes&display=swap');
            .cert-wrapper { background: radial-gradient(circle at top,#101a40,#040711); padding: 40px; display: flex; justify-content: center; font-family: 'Inter', sans-serif; color: white; }
            .certificate { width: 850px; background: linear-gradient(180deg,#0e1640,#070b1c); border-radius: 26px; padding: 55px; border: 2px solid rgba(0,229,255,.25); box-shadow: 0 0 100px rgba(0,229,255,.2); position: relative; }
            .header { text-align: center; }
            .header h1 { font-size: 40px; margin: 0; color: white; letter-spacing: 2px; }
            .header h2 { font-size: 24px; color: #00e5ff; margin: 10px 0; text-transform: uppercase; letter-spacing: 3px; text-shadow: 0 0 15px rgba(0,229,255,0.6); }
            .badge-wrapper { display: flex; justify-content: center; margin: 40px 0; }
            .cfo-badge { width: 180px; height: 180px; border-radius: 50%; border: 4px solid #c9a227; background: #0f1c44; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 40px rgba(0,229,255,0.5); }
            .cfo-badge h2 { font-size: 50px; color: #00e5ff; margin: 0; text-shadow: 0 0 10px #00e5ff; }
            .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 30px 0; }
            .stat-box { background: rgba(255,255,255,.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(0,229,255,.2); text-align: center; }
            .stat-box p { font-size: 18px; font-weight: 700; margin-top: 5px; }
            .footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 50px; }
            .sig { font-family: 'Great Vibes', cursive; font-size: 35px; border-bottom: 1px solid #555; }
            .gold-seal { width: 100px; height: 100px; background: radial-gradient(circle, #ffdf8c, #c9a227); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: black; font-weight: 800; font-size: 10px; text-align: center; box-shadow: 0 0 30px rgba(201,162,39,0.5); }
        </style>
        <div class="cert-wrapper">
            <div class="certificate">
                <div class="header">
                    <h1>ScaleVest</h1>
                    <h2>Business Finance Certificate</h2>
                    <div style="color: #93a4c8; letter-spacing: 2px; font-size: 12px;"></div>
                </div>
                <div class="badge-wrapper">
                    <div class="cfo-badge"><h2>CFO</h2></div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box"><small>REVENUE</small><p>$${data.totalRevenue.toLocaleString()}</p></div>
                    <div class="stat-box"><small>NET PROFIT</small><p>$${data.netProfit.toLocaleString()}</p></div>
                    <div class="stat-box"><small>MARGIN</small><p>${data.profitMargin}%</p></div>
                    <div class="stat-box"><small>GROWTH</small><p>${data.weeklyGrowth}%</p></div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; border: 1px solid rgba(0,229,255,0.2);">
                    <h4 style="color: #00e5ff; margin-bottom: 10px;">CFO ANALYSIS</h4>
                    <p style="font-size: 14px; line-height: 1.5; color: #cbd5e1;">${document.getElementById('executive-summary').innerText.split('.')[0]}. Enterprise stability is verified.</p>
                </div>
                <div class="footer">
                    <div><div class="sig">ScaleVest AI</div><div style="font-size: 12px; color: #888;">Authorized Signature</div></div>
                    <div class="gold-seal">OFFICIAL<br>VERIFIED</div>
                </div>
            </div>
        </div>
    `;
    pdfContainer.appendChild(page1);

    // 3. Page 2 (Dashboard Copy)
    const page2 = document.createElement('div');
    page2.style.cssText = 'page-break-before: always; background: #0a0e27; padding: 20px;';
    page2.appendChild(document.getElementById('dashboard-container').cloneNode(true));
    pdfContainer.appendChild(page2);

    // 4. Generate PDF
    const opt = {
        margin: 0,
        filename: `${reportName}.pdf`, // CUSTOM NAME ONLY IN DOWNLOAD URL
        html2canvas: { scale: 2, useCORS: true, scrollY: 0, backgroundColor: '#040711' },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(pdfContainer).save().then(() => {
        // Reset Modal
        if(loadingEl) loadingEl.style.display = 'none';
        document.getElementById('export-modal').style.display = 'none';
        alert("Verification Complete. Check your downloads.");
    });
}

// Fetch and display expiry alerts
async function fetchExpiryAlerts(userId) {
    const dbRef = ref(getDatabase());
    
    try {
        // Fetch notification preference (default 3 days if not set)
        const notificationSnapshot = await get(child(dbRef, `BusinessOwners/${userId}/__expiryDateNotification`));
        const notificationDays = notificationSnapshot.exists() ? parseInt(notificationSnapshot.val()) : 3;
        
        // Fetch inventory with expiry dates
        const inventorySnapshot = await get(child(dbRef, `Businesses/${userId}/inventory`));
        if (!inventorySnapshot.exists()) return;
        
        const inventory = inventorySnapshot.val();
        const now = new Date();
        const expiringProducts = [];
        
        // Check each product for expiry
        for (const [productId, productData] of Object.entries(inventory)) {
            if (productData.expiryDate) {
                const expiryDate = new Date(productData.expiryDate);
                const daysUntilExpiry = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                
                // If expires within notification window
                if (daysUntilExpiry <= notificationDays && daysUntilExpiry >= 0) {
                    expiringProducts.push({
                        name: productData.name || "Unknown Product",
                        daysUntilExpiry,
                        quantity: productData.quantity || 0,
                        unit: productData.unit || "units"
                    });
                }
            }
        }
        
        // Sort by urgency (closest expiry first)
        expiringProducts.sort((a, b) => a.daysUntilExpiry - b.daysUntilExpiry);
        
        // Update UI
        updateExpiryAlertCard(expiringProducts);
        updateCFOAdviceForExpiry(expiringProducts);
        
    } catch (error) {
        console.error("Error fetching expiry alerts:", error);
    }
}

function updateExpiryAlertCard(expiringProducts) {
    const alertCard = document.querySelector('.alert-card');
    
    // ADD NULL CHECK
    if (!alertCard) {
        console.warn('Alert card not found in DOM');
        return;
    }
    
    const alertTitle = alertCard.querySelector('.alert-title');
    const alertText = alertCard.querySelector('.alert-text');
    const launchBtn = alertCard.querySelector('.launch-btn');
    
    // ADD NULL CHECKS FOR ALL ELEMENTS
    if (!alertTitle || !alertText || !launchBtn) {
        console.warn('Alert card elements not found');
        return;
    }
    
    if (expiringProducts.length === 0) {
        alertTitle.innerText = "ALL CLEAR ✓";
        alertText.innerText = "No products expiring soon";
        launchBtn.style.display = "none";
        alertCard.style.background = "linear-gradient(135deg, rgba(74, 222, 128, 0.12) 0%, rgba(74, 222, 128, 0.02) 100%)";
        alertCard.style.borderColor = "rgba(74, 222, 128, 0.4)";
        alertCard.style.animation = "none";
        return;
    }
    
    // Show the most urgent product
    const urgent = expiringProducts[0];
    const timeText = urgent.daysUntilExpiry === 0 ? "TODAY!" : 
                     urgent.daysUntilExpiry === 1 ? "24 hours" : 
                     `${urgent.daysUntilExpiry} days`;
    
    alertTitle.innerText = "⚠️ EXPIRY ALERT";
    alertText.innerHTML = `<strong>${urgent.name}</strong> (Expires in ${timeText})<br><span style="font-size: 14px; opacity: 0.8;">${urgent.quantity} ${urgent.unit} in stock</span>`;
    launchBtn.style.display = "block";
    launchBtn.innerText = urgent.daysUntilExpiry === 0 ? "URGENT: FLASH SALE NOW!" : "LAUNCH FLASH SALE";
    
    // If multiple products expiring
    if (expiringProducts.length > 1) {
        alertText.innerHTML += `<div style="margin-top: 10px; font-size: 12px; color: rgba(255,255,255,0.6);">+ ${expiringProducts.length - 1} more product(s) expiring soon</div>`;
    }
    
    // Restore alert styling
    alertCard.style.background = "linear-gradient(135deg, rgba(251, 146, 60, 0.12) 0%, rgba(251, 146, 60, 0.02) 100%)";
    alertCard.style.borderColor = "rgba(251, 146, 60, 0.4)";
    alertCard.style.animation = "alertPulse 3s infinite";
}
 
    
   
// Fetch and analyze pricing
async function fetchPricingAnalysis(userId) {
    const dbRef = ref(getDatabase());
    
    try {
        // Fetch prices
        const pricesSnapshot = await get(child(dbRef, `Businesses/${userId}/prices`));
        if (!pricesSnapshot.exists()) {
            updatePricingCard(null, []);
            updateCFOAdviceForPricing([]);
            return;
        }
        
        const prices = pricesSnapshot.val();
        
        // Fetch inventory to get product names
        const inventorySnapshot = await get(child(dbRef, `Businesses/${userId}/inventory`));
        const inventory = inventorySnapshot.exists() ? inventorySnapshot.val() : {};
        
        const pricingIssues = [];
        
        // Analyze each product's pricing
        for (const [productId, priceData] of Object.entries(prices)) {
            const productName = inventory[productId]?.name || "Unknown Product";
            const costPrice = parseFloat(priceData.costPrice);
            const sellPrice = parseFloat(priceData.sellPrice);
            
            // Check if prices are set
            if (!priceData.costPrice || !priceData.sellPrice) {
                pricingIssues.push({
                    type: "missing",
                    productName,
                    message: `${productName}: Prices not set`
                });
                continue;
            }
            
            // Check if selling below cost (LOSS)
            if (sellPrice < costPrice) {
                const loss = costPrice - sellPrice;
                const lossPercent = ((loss / costPrice) * 100).toFixed(1);
                const suggestedPrice = (costPrice * 1.25).toFixed(2); // 25% profit margin
                
                pricingIssues.push({
                    type: "loss",
                    productName,
                    costPrice,
                    sellPrice,
                    loss,
                    lossPercent,
                    suggestedPrice,
                    message: `${productName}: Selling below cost (Loss: $${loss.toFixed(2)})`
                });
            }
            // Check if margin is too high (might hurt sales)
            else if (sellPrice > costPrice * 2.5) {
                const margin = sellPrice - costPrice;
                const marginPercent = ((margin / costPrice) * 100).toFixed(1);
                const suggestedPrice = (costPrice * 1.4).toFixed(2); // 40% profit margin
                
                pricingIssues.push({
                    type: "too_high",
                    productName,
                    costPrice,
                    sellPrice,
                    margin,
                    marginPercent,
                    suggestedPrice,
                    message: `${productName}: Price too high (Margin: ${marginPercent}%)`
                });
            }
            // Check if margin is healthy but could be optimized
            else if (sellPrice < costPrice * 1.15) {
                const margin = sellPrice - costPrice;
                const marginPercent = ((margin / costPrice) * 100).toFixed(1);
                const suggestedPrice = (costPrice * 1.25).toFixed(2); // 25% profit margin
                
                pricingIssues.push({
                    type: "low_margin",
                    productName,
                    costPrice,
                    sellPrice,
                    margin,
                    marginPercent,
                    suggestedPrice,
                    message: `${productName}: Low profit margin (${marginPercent}%)`
                });
            }
        }
        
        // Update UI
        updatePricingCard(prices, pricingIssues);
        updateCFOAdviceForPricing(pricingIssues);
        
    } catch (error) {
        console.error("Error fetching pricing analysis:", error);
    }
}

function updatePricingCard(prices, issues) {
    const momentumCard = document.querySelector('.momentum-card');
    const momentumText = momentumCard.querySelector('.momentum-text');
    const priceWarning = momentumCard.querySelector('.price-warning');
    const svgPath = momentumCard.querySelector('path[stroke="#3b82f6"]');
    const svgFillPath = momentumCard.querySelector('path[fill*="gradient1"]');
    
    if (!prices || Object.keys(prices).length === 0) {
        momentumText.innerHTML = "No Pricing Data";
        priceWarning.innerHTML = "⚠️ Set cost & selling prices in Sales Flow";
        priceWarning.style.color = "rgba(251, 146, 60, 0.9)";
        return;
    }
    
    if (issues.length === 0) {
        momentumText.innerHTML = "Pricing Health: Excellent ✓";
        momentumText.style.color = "#4ade80";
        priceWarning.innerHTML = "✓ All prices are optimized";
        priceWarning.style.color = "rgba(74, 222, 128, 0.8)";
        
        svgPath.setAttribute("stroke", "#4ade80");
        svgPath.setAttribute("d", "M 0 70 L 50 65 L 100 58 L 150 52 L 200 40 L 250 25 L 300 15");
        svgFillPath.setAttribute("d", "M 0 70 L 50 65 L 100 58 L 150 52 L 200 40 L 250 25 L 300 15 L 300 80 L 0 80 Z");
        return;
    }
    
    const hasLoss = issues.some(i => i.type === "loss");
    const hasTooHigh = issues.some(i => i.type === "too_high");
    const hasLowMargin = issues.some(i => i.type === "low_margin");
    
    if (hasLoss) {
        momentumText.innerHTML = "⚠️ PRICING ALERTS";
        momentumText.style.color = "#f87171";
        svgPath.setAttribute("stroke", "#f87171");
        svgPath.setAttribute("d", "M 0 15 L 50 25 L 100 40 L 150 48 L 200 58 L 250 68 L 300 75");
        svgFillPath.setAttribute("d", "M 0 15 L 50 25 L 100 40 L 150 48 L 200 58 L 250 68 L 300 75 L 300 80 L 0 80 Z");
    } else if (hasTooHigh) {
        momentumText.innerHTML = "⚠️ PRICING WARNINGS";
        momentumText.style.color = "#fb923c";
        svgPath.setAttribute("stroke", "#fb923c");
        svgPath.setAttribute("d", "M 0 20 L 50 28 L 100 42 L 150 50 L 200 60 L 250 67 L 300 73");
        svgFillPath.setAttribute("d", "M 0 20 L 50 28 L 100 42 L 150 50 L 200 60 L 250 67 L 300 73 L 300 80 L 0 80 Z");
    } else if (hasLowMargin) {
        momentumText.innerHTML = "💡 PRICING NOTICES";
        momentumText.style.color = "#3b82f6";
        svgPath.setAttribute("stroke", "#3b82f6");
        svgPath.setAttribute("d", "M 0 50 L 50 52 L 100 51 L 150 53 L 200 52 L 250 54 L 300 53");
        svgFillPath.setAttribute("d", "M 0 50 L 50 52 L 100 51 L 150 53 L 200 52 L 250 54 L 300 53 L 300 80 L 0 80 Z");
    }
    
    // Show ALL pricing issues with proper formatting
    let warningHTML = '<div style="display: flex; flex-direction: column; gap: 8px;">';
    
    issues.filter(i => i.type === "loss").forEach((issue) => {
        warningHTML += `<div style="padding: 8px; background: rgba(248, 113, 113, 0.1); border-left: 3px solid #f87171; border-radius: 6px;">🚨 <strong>${issue.productName}:</strong> Selling below cost! Loss: $${issue.loss.toFixed(2)} per unit</div>`;
    });
    
    issues.filter(i => i.type === "too_high").forEach((issue) => {
        warningHTML += `<div style="padding: 8px; background: rgba(251, 146, 60, 0.1); border-left: 3px solid #fb923c; border-radius: 6px;">⚠️ <strong>${issue.productName}:</strong> Price too high (${issue.marginPercent}% margin) - May hurt sales</div>`;
    });
    
    issues.filter(i => i.type === "low_margin").forEach((issue) => {
        warningHTML += `<div style="padding: 8px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; border-radius: 6px;">💡 <strong>${issue.productName}:</strong> Low margin (${issue.marginPercent}%) - Consider increasing</div>`;
    });
    
    issues.filter(i => i.type === "missing").forEach((issue) => {
        warningHTML += `<div style="padding: 8px; background: rgba(251, 146, 60, 0.1); border-left: 3px solid #fb923c; border-radius: 6px;">⚠️ <strong>${issue.productName}:</strong> Prices not set</div>`;
    });
    
    warningHTML += '</div>';
    
    priceWarning.innerHTML = warningHTML;
    priceWarning.style.color = "rgba(255, 255, 255, 0.9)";
}
function updateCFOAdviceForPricing(pricingIssues) {
    // Store pricing issues globally
    window.pricingIssues = pricingIssues;
    updateMasterCFOAdvice();
}

function updateCFOAdviceForExpiry(expiringProducts) {
    // Store expiry issues globally
    window.expiringProducts = expiringProducts;
    updateMasterCFOAdvice();
}

function updateCFOAdviceForStock(lowStockProducts) {
    // Store stock issues globally
    window.lowStockAlerts = lowStockProducts;
    updateMasterCFOAdvice();
}

// MASTER CFO ADVICE - Combines all alerts
// MASTER CFO ADVICE - Combines ALL alerts
function updateMasterCFOAdvice() {
    const adviceCard = document.querySelector('.advice-card .advice-text');
    const expiringProducts = window.expiringProducts || [];
    const pricingIssues = window.pricingIssues || [];
    const lowStockAlerts = window.lowStockAlerts || [];
    
    let adviceHTML = "";
    
    // 1. CRITICAL EXPIRY ALERTS (Highest Priority) - SHOW ALL
    const criticalExpiry = expiringProducts.filter(p => p.daysUntilExpiry <= 1);
    criticalExpiry.forEach(product => {
        adviceHTML += `🚨 <strong>CRITICAL EXPIRY:</strong> ${product.name} expires ${product.daysUntilExpiry === 0 ? 'TODAY' : 'in 24 hours'}! Launch flash sale immediately.<br><br>`;
    });
    
    // 2. LOSS-MAKING PRICES (Second Priority) - SHOW ALL
    const lossProducts = pricingIssues.filter(p => p.type === "loss");
    lossProducts.forEach(product => {
        adviceHTML += `💰 <strong>PRICING LOSS:</strong> ${product.productName} selling at $${product.sellPrice} but costs $${product.costPrice}. You're losing $${product.loss.toFixed(2)} per unit! Increase to $${product.suggestedPrice}.<br><br>`;
    });
    
    // 3. CRITICAL STOCK ALERTS - SHOW ALL
    const criticalStock = lowStockAlerts.filter(p => p.severity === "critical");
    criticalStock.forEach(product => {
        adviceHTML += `📦 <strong>CRITICAL STOCK:</strong> ${product.name} has only ${product.currentStock} ${product.unit} left${product.daysUntilStockout < 999 ? ` (~${product.daysUntilStockout} days)` : ''}. Contact supplier urgently for restocking.<br><br>`;
    });
    
    // 4. UPCOMING EXPIRY (3-7 days) - SHOW ALL
    const upcomingExpiry = expiringProducts.filter(p => p.daysUntilExpiry > 1 && p.daysUntilExpiry <= 7);
    upcomingExpiry.forEach(product => {
        adviceHTML += `⏰ <strong>EXPIRY ALERT:</strong> ${product.name} expires in ${product.daysUntilExpiry} days. Plan promotional strategy now.<br><br>`;
    });
    
    // 5. LOW STOCK WARNINGS - SHOW ALL
    const warningStock = lowStockAlerts.filter(p => p.severity === "warning" || p.severity === "low");
    warningStock.forEach(product => {
        adviceHTML += `📊 <strong>LOW STOCK:</strong> ${product.name} running low (${product.currentStock} ${product.unit})${product.daysUntilStockout < 999 ? `, ~${product.daysUntilStockout} days supply` : ''}. Consider restocking soon.<br><br>`;
    });
    
    // 6. HIGH PRICE WARNINGS - SHOW ALL
    const highPriceProducts = pricingIssues.filter(p => p.type === "too_high");
    highPriceProducts.forEach(product => {
        adviceHTML += `💡 <strong>PRICING:</strong> ${product.productName} priced at ${product.marginPercent}% margin. May hurt sales. Consider lowering to $${product.suggestedPrice}.<br><br>`;
    });
    
    // 7. LOW MARGIN PRODUCTS - SHOW ALL
    const lowMarginProducts = pricingIssues.filter(p => p.type === "low_margin");
    lowMarginProducts.forEach(product => {
        adviceHTML += `📈 <strong>LOW MARGIN:</strong> ${product.productName} has ${product.marginPercent}% profit margin. Consider increasing to $${product.suggestedPrice} for better profitability.<br><br>`;
    });
    
    // 8. DEFAULT TIP (No Alerts)
    if (adviceHTML === "") {
        adviceHTML = "💡 <strong>Pro Tip:</strong> Always set your selling and cost prices in Sales Flow to help ScaleVest CFO track your financial reports and provide intelligent business insights. Your dashboard is looking healthy! 🎯";
    }
    
    adviceCard.innerHTML = adviceHTML;
}
// Fetch and analyze stock levels
async function fetchStockRadar(userId) {
    const dbRef = ref(getDatabase());
    
    try {
        // Fetch inventory
        const inventorySnapshot = await get(child(dbRef, `Businesses/${userId}/inventory`));
        if (!inventorySnapshot.exists()) {
            updateStockRadarCard([]);
            return;
        }
        
        const inventory = inventorySnapshot.val();
        
        // Fetch sales to calculate burn rate
        const salesSnapshot = await get(child(dbRef, `Businesses/${userId}/sales`));
        const salesData = salesSnapshot.exists() ? salesSnapshot.val() : {};
        
        const now = new Date();
        const sevenDaysAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
        
        const lowStockProducts = [];
        
        // Analyze each product
        for (const [productId, productData] of Object.entries(inventory)) {
            const currentStock = parseInt(productData.quantity) || 0;
            
            // Check if stock is below 15
            if (currentStock <= 15) {
                // Calculate weekly sales for this product
                let weeklySales = 0;
                Object.values(salesData).forEach(sale => {
                    if (sale.productId === productId) {
                        const saleDate = new Date(sale.timestamp);
                        if (saleDate > sevenDaysAgo) {
                            weeklySales += parseInt(sale.quantity) || 0;
                        }
                    }
                });
                
                // Calculate daily burn rate and predict stockout
                const dailyBurnRate = weeklySales / 7;
                const daysUntilStockout = dailyBurnRate > 0 ? Math.ceil(currentStock / dailyBurnRate) : 999;
                
                lowStockProducts.push({
                    name: productData.name || "Unknown Product",
                    currentStock,
                    unit: productData.unit || "units",
                    weeklySales,
                    dailyBurnRate: dailyBurnRate.toFixed(1),
                    daysUntilStockout,
                    severity: currentStock <= 5 ? "critical" : currentStock <= 10 ? "warning" : "low"
                });
            }
        }
        
        // Sort by severity and days until stockout
        lowStockProducts.sort((a, b) => {
            const severityOrder = { critical: 0, warning: 1, low: 2 };
            if (severityOrder[a.severity] !== severityOrder[b.severity]) {
                return severityOrder[a.severity] - severityOrder[b.severity];
            }
            return a.daysUntilStockout - b.daysUntilStockout;
        });
        
        // Update UI
        updateStockRadarCard(lowStockProducts);
        updateCFOAdviceForStock(lowStockProducts);
        
    } catch (error) {
        console.error("Error fetching stock radar:", error);
    }
}



function updateStockRadarCard(lowStockProducts) {
    const stockCard = document.querySelector('.stock-card');
    const stockFill = stockCard.querySelector('.stock-fill');
    const stockText = stockCard.querySelector('.stock-text');
    
    if (lowStockProducts.length === 0) {
        stockFill.style.width = "85%";
        stockFill.style.background = "linear-gradient(90deg, #4ade80 0%, #22c55e 100%)";
        stockFill.style.boxShadow = "0 0 10px rgba(74, 222, 128, 0.5)";
        stockText.innerHTML = "All Products: Healthy Stock Levels ✓";
        stockText.style.color = "rgba(74, 222, 128, 0.9)";
        return;
    }
    
    // Show most critical product for the bar
    const critical = lowStockProducts[0];
    const stockPercent = Math.min((critical.currentStock / 15) * 100, 100);
    
    // Set color based on severity
    let fillColor = "";
    if (critical.severity === "critical") {
        fillColor = "linear-gradient(90deg, #f87171 0%, #ef4444 100%)";
        stockFill.style.boxShadow = "0 0 10px rgba(248, 113, 113, 0.5)";
    } else if (critical.severity === "warning") {
        fillColor = "linear-gradient(90deg, #fb923c 0%, #f97316 100%)";
        stockFill.style.boxShadow = "0 0 10px rgba(251, 146, 60, 0.5)";
    } else {
        fillColor = "linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%)";
        stockFill.style.boxShadow = "0 0 10px rgba(59, 130, 246, 0.5)";
    }
    
    stockFill.style.width = `${stockPercent}%`;
    stockFill.style.background = fillColor;
    
    // Show ALL low stock products
    let statusText = "";
    
    lowStockProducts.forEach((product, index) => {
        if (index > 0) statusText += "<br><br>";
        
        statusText += `<strong>${product.name}</strong>: Only ${product.currentStock} ${product.unit} left`;
        
        if (product.daysUntilStockout < 999) {
            if (product.daysUntilStockout <= 3) {
                statusText += ` <span style="color: #f87171;">(Will stock out in ~${product.daysUntilStockout} days)</span>`;
            } else if (product.daysUntilStockout <= 7) {
                statusText += ` <span style="color: #fb923c;">(Will stock out in ~${product.daysUntilStockout} days)</span>`;
            } else {
                statusText += ` <span style="color: #3b82f6;">(~${product.daysUntilStockout} days supply)</span>`;
            }
        }
    });
    
    stockText.innerHTML = statusText;
}

function launchFlashSale() {
    alert("Flash Sale feature coming soon! This will allow you to create instant discount campaigns.");
    // You can build this feature later to create automatic discounts
}
function openCFOChat() {
    // SEARCH
    const searchBar = document.querySelector('.search-bar');
    searchBar.style.transform = 'scale(0.98)';
    
    setTimeout(() => {
        window.location.href = 'cfochat.html';
    }, 100);
}

async function askCFO(userInput) {
    const adviceTextEl = document.querySelector('.advice-text');
    
    try {
        const response = await fetch('/api/cfoscalevest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                messages: [{ role: 'user', content: userInput }]
            })
        });

        if (response.ok) {
            // Print the success message to the console as requested
            console.log("SCALEVEST CFO LIVE");

            // Handle the streaming response
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            adviceTextEl.innerText = ""; // Clear existing placeholder text

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value, { stream: true });
                // vercel
                const cleanChunk = chunk.replace(/0:\"/g, '').replace(/\"/g, '');
                adviceTextEl.innerText += cleanChunk;
            }
        } else {
            console.error("Connection failed:", response.statusText);
            adviceTextEl.innerText = "CFO is currently offline. Please try again.";
        }
    } catch (error) {
        console.error("Network Error:", error);
        adviceTextEl.innerText = "Error connecting to ScaleVest CFO.";
    }
}
</script>

<div id="onboarding-overlay" style="position: fixed; inset: 0; z-index: 9999; background: #0a0e27; display: flex; align-items: center; justify-content: center; transition: opacity 1s ease;">
    <div id="welcome-text" style="font-size: 48px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        Hi, <span id="user-name-display">...</span>
    </div>
</div>

<div id="cfo-popup" style="display: none; position: fixed; inset: 0; z-index: 10000; background: rgba(10, 14, 39, 0.8); backdrop-filter: blur(20px); align-items: center; justify-content: center; padding: 20px;">
    <div class="card" style="max-width: 500px; width: 100%; text-align: center; border: 1px solid rgba(59, 130, 246, 0.4);">
        <h2 style="margin-bottom: 20px;">Customize your CFO</h2>
        <input type="text" id="cfo-name-input" placeholder="Name your CFO (e.g. Mark)" style="width: 100%; padding: 15px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: white; margin-bottom: 20px; outline: none;">
        
        <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 20px; text-align: left; margin-bottom: 20px; font-size: 13px; line-height: 1.6;">
            <div style="color: #3b82f6; font-weight: 700; margin-bottom: 10px; letter-spacing: 1px;">NOTE:</div>
            <ul style="list-style: none; color: rgba(255,255,255,0.7);">
                <li>• This is Version 1; it will get smarter over time.</li>
                <li>• Reports are based on your products, sales, and vault data.</li>
                <li>• Your CFO can issue sales certificates and talk to your whole business hub.</li>
                <li style="margin-top: 10px; color: #fb923c;">• <b>14-Day Free Trial:</b> Upgrade required after the trial ends.</li>
            </ul>
        </div>

        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; justify-content: center; font-size: 14px;">
            <input type="checkbox" id="terms-check">
            <label for="terms-check">I have read and understood the notes</label>
        </div>

<button id="start-cfo-btn" class="launch-btnv">
    <span>START CFO</span>
</button>
    </div>
</div>
    <div class="blur-orb orb1"></div>
    <div class="blur-orb orb2"></div>
    <div class="blur-orb orb3"></div>

    <div class="container">
        <div class="header">
            <div class="logo">SCALEVEST</div>
        </div>

<div style="position: fixed; top: 20px; left: 20px; z-index: 1000;">
    <button onclick="window.location.href='mainbusinesshub.html'" style="
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #e0e0e0;
        color: #1a1a1a;
        padding: 12px 20px;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        font-size: 14px;
    " onmouseover="this.style.borderColor='#00CED1'; this.style.transform='scale(1.05)'" 
       onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='scale(1)'">
        <span style="font-size: 1.2rem;">←</span> Back to Hub
    </button>
</div>
        <div class="dashboard">
<div class="card profit-card">
    <div class="card-title">Weekly Reports</div>
    <div style="display: flex; align-items: baseline; gap: 10px;">
        <div id="total-revenue" class="big-number">$0</div>
        <div id="trend-badge" style="padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; gap: 4px;">
            <span id="trend-arrow"></span>
            <span id="trend-percent">0%</span>
        </div>
    </div>
    
    <div id="pnl-status" class="profit-text" style="margin-top: 5px; font-size: 0.85rem; opacity: 0.8;">Analyzing market data...</div>
    
    <div id="daily-breakdown" style="font-size: 0.8rem; color: #94a3b8; margin: 15px 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
    </div>

    <div class="chart" id="revenue-chart" style="display: flex; align-items: flex-end; justify-content: space-between; height: 100px; padding: 10px 0;">
        </div>
    
    <div id="burn-rate" class="burn-rate" style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">Velocity: Loading...</div>
</div>

           <div class="card products-card">
    <div class="card-title" style="margin-top: 30px;">PRODUCTS</div>
    <div class="products" style="grid-template-columns: 1fr 1fr 1fr;"> 
        <div class="product">
            <div class="product-header">
                <span class="star-badge">⭐</span>
                <span>The Most Selling</span>
            </div>
            <div id="star-icon" class="dynamic-icon">?</div> 
            <div id="star-name" class="product-name">Loading...</div>
            <div id="star-sold" class="product-badge">...</div>
        </div>
        
        <div class="product">
            <div class="product-header">
                <span style="color: #4ade80;">📈</span>
                <span>TRENDING</span>
            </div>
            <div id="trending-icon" class="dynamic-icon">?</div>
            <div id="trending-name" class="product-name">Loading...</div>
            <div id="trending-sold" class="product-badge">...</div>
        </div>

        <div class="product">
            <div class="product-header">
                <span class="ghost-badge">👻</span>
                <span>The Least Selling</span>
            </div>
            <div id="ghost-icon" class="dynamic-icon" style="opacity: 0.5;">?</div>
            <div id="ghost-name" class="product-name">Loading...</div>
            <div id="ghost-sold" class="product-badge">...</div>
        </div>
    </div>
    <div id="analytics-reason" class="reason">Reason: Low Demand</div>
</div>

<div class="card salary-card-wide" onclick="window.location.href='salarypayer.html';" style="
    width: 100%;
    max-width: 800px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px;
    padding: 32px;
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
">
    <div style="position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);"></div>

    <div style="display: flex; align-items: center; gap: 40px;">
        <div class="svg-container" style="transition: all 0.3s ease; flex-shrink: 0; background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1);">
            <img src="employeepay.svg" alt="Payroll Transfer" style="width: 80px; height: 80px; display: block; filter: brightness(0) invert(1);">
        </div>

        <div style="flex-grow: 1;">
            <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 2.5px; color: rgba(255, 255, 255, 0.4); margin-bottom: 8px; font-weight: 700;">
                Salary Payroll
            </div>
            <h2 style="font-size: 32px; font-weight: 700; color: #ffffff; margin: 0 0 12px 0;">
                Employee Payout Portal
            </h2>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="display: flex; flex-direction: column;">
                    <span style="font-size: 13px; color: rgba(255, 255, 255, 0.5);">Status</span>
                    <span style="font-size: 16px; color: #4ade80; font-weight: 600;">Ready to Pay</span>
                </div>
                <div style="height: 30px; width: 1px; background: rgba(255,255,255,0.1);"></div>
                <div style="display: flex; flex-direction: column;">
                    <span style="font-size: 13px; color: rgba(255, 255, 255, 0.5);">Recipient</span>
                    <span style="font-size: 16px; color: #fff; font-weight: 500;">All Active Employees and Staff</span>
                </div>
            </div>
        </div>
    </div>

    <div style="margin-top: 10px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.05); display: flex; align-items: center; justify-content: center; gap: 12px;">
        <img src="payrollpoint.svg" alt="Pointer" style="width: 20px; height: 20px; filter: brightness(0) invert(1);">
        <span style="font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: rgba(255, 255, 255, 0.5); font-weight: 600;">
            Click here to open the <span style="color: #3b82f6;">Scalevest Salary Payroll</span>
        </span>
    </div>
</div>
            <div class="card momentum-card">
                <div class="card-title">MOMENTUM</div>
                <div class="momentum-text">Waterproof Sprays +40%</div>
                <div class="line-chart">
                    <svg viewBox="0 0 300 80" preserveAspectRatio="none">
                        <defs>
                            <linearGradient id="gradient1" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.3" />
                                <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0" />
                            </linearGradient>
                        </defs>
                        <path d="M 0 70 L 50 65 L 100 58 L 150 52 L 200 40 L 250 25 L 300 15" 
                              fill="none" stroke="#3b82f6" stroke-width="3" stroke-linecap="round"/>
                        <path d="M 0 70 L 50 65 L 100 58 L 150 52 L 200 40 L 250 25 L 300 15 L 300 80 L 0 80 Z" 
                              fill="url(#gradient1)"/>
                    </svg>
                </div>
                <div class="price-warning">⚠️ Price is too high</div>
            </div>

            <div class="card alert-card">
                <div class="card-title alert-title">EXPIRY ALERT</div>
                <div class="alert-text"></div>
            </div>

<div class="card momentum-card" id="product-analysis-card" style="cursor: pointer;">
    <div class="card-title">ALL PRODUCT ANALYSIS</div>
    
    <div style="text-align: center; padding: 20px 0;">
        <div style="margin-bottom: 25px;">
            <img src="chart.svg" alt="Analysis" style="width: 52px; height: 52px; filter: brightness(0) invert(1); opacity: 0.9;">
        </div>

        <div style="margin-bottom: 12px; display: flex; justify-content: center;">
            <img src="payrollpoint.svg" alt="Payroll" style="width: 20px; height: 20px; filter: brightness(0) invert(1); opacity: 0.6;">
        </div>

        <div style="font-size: 14px; color: rgba(255,255,255,0.6); letter-spacing: 0.5px;">
            Click here to open the Analytics Page
        </div>
    </div>
</div>

            <div class="card advice-card">
                <div class="card-title">CFO ADVICE</div>
                <div class="menu-icon">≡</div>
                <div class="advice-text">Insight: You are in profit today because of the successful weekend surge in surge sales.</div>
            </div>

            <div class="card stock-card">
                <div class="card-title">STOCK RADAR</div>
                <div class="stock-bar">
                    <div class="stock-fill"></div>
                </div>
                <div class="stock-text">Electronics (Will Stock Out <5 Days)</div>
            </div>

               <div class="card ai-cfo-card" style="grid-column: span 1; background: linear-gradient(135deg, rgba(139, 92, 246, 0.12) 0%, rgba(59, 130, 246, 0.08) 100%); border: 1.5px solid rgba(139, 92, 246, 0.4);">
    <div class="card-title" style="color: #a855f7;">🤖 AI CFO INSIGHTS</div>
    
    <div id="ai-suggestions-content" style="min-height: 200px;">
        <div id="ai-loading" style="text-align: center; padding: 40px;">
            <div style="font-size: 32px; margin-bottom: 15px;">🧠</div>
            <div style="font-size: 14px; color: rgba(255,255,255,0.6);">Analyzing your business...</div>
        </div>
        
        <div id="ai-suggestions" style="display: none;">
            <!-- AI suggestions will appear here -->
        </div>
    </div>

    <!-- Multiple Shelf Upload Section (NEW!) -->
    <div id="shelf-upload-section" style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
        <div style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
            <span>📸</span>
            <span>Upload Shelf Photos for Analysis</span>
        </div>
        
        <!-- Hidden File Input (Multiple) -->
        <input type="file" id="shelf-images-input" accept="image/*" multiple style="display: none;">
        
        <!-- Upload Button -->
        <button id="upload-shelf-btn" style="width: 100%; padding: 10px; background: rgba(251, 146, 60, 0.2); border: 1px solid rgba(251, 146, 60, 0.4); border-radius: 8px; color: #fb923c; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.2s;">
            📤 Upload Shelf Photos
        </button>
        
        <!-- Preview Container -->
        <div id="shelf-preview-container" style="margin-top: 10px;">
            <!-- Uploaded images will show here -->
        </div>
        
        <!-- Analyze Shelves Button (Initially Hidden) -->
        <button id="analyze-shelves-btn" disabled style="width: 100%; margin-top: 10px; padding: 12px; background: linear-gradient(135deg, #a855f7, #8b5cf6); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: not-allowed; opacity: 0.5; display: none;">
            🔍 Analyze All Shelves
        </button>
    </div>

    <!-- Language Toggle & Analyze Button -->
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button id="language-toggle" style="flex: 1; padding: 10px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 8px; color: #3b82f6; font-weight: 600; cursor: pointer; font-size: 12px;">
            🌐 हिंदी
        </button>
        <button id="analyze-business-btn" style="flex: 2; padding: 12px; background: rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 10px; color: #a855f7; font-weight: 600; cursor: pointer;">
            📊 Analyze Business
        </button>
    </div>
</div>
           <div class="card" id="finance-report-card" style="cursor: pointer;">
    <div class="card-title">CFO FINANCE REPORT</div>
    <div style="text-align: center; padding: 20px 0;">
        <div style="margin-bottom: 25px;">
            <img src="chart.svg" alt="Finance Report" style="width: 52px; height: 52px; filter: brightness(0) invert(1); opacity: 0.9;">
        </div>
        <div style="margin-bottom: 12px; display: flex; justify-content: center;">
            <img src="payrollpoint.svg" alt="Pointer" style="width: 20px; height: 20px; filter: brightness(0) invert(1); opacity: 0.6;">
        </div>
        <div style="font-size: 14px; color: rgba(255,255,255,0.6); letter-spacing: 0.5px;">
            Click to view comprehensive financial analysis
        </div>
    </div>
</div>
<div class="card" id="trend-analysis-card" style="cursor: pointer; transition: all 0.3s ease;">
    <div class="card-title">TREND ANALYSIS</div>
    <div style="text-align: center; padding: 25px 0;">
        <div style="margin-bottom: 20px;">
            <div style="font-size: 40px;">📈</div>
        </div>
        <div id="trend-status" style="font-size: 14px; color: #00e5ff; font-weight: 700; letter-spacing: 0.5px;">
            LIVE MARKET INTELLIGENCE
        </div>
        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 10px;">
            Click to view trending velocity
        </div>
    </div>
</div>

<div id="trend-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 14, 39, 0.95); z-index: 15000; justify-content: center; align-items: center; backdrop-filter: blur(10px);">
    <div class="card" style="width: 90%; max-width: 550px; border: 1px solid #00e5ff;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: #00e5ff;">Market Velocity Analysis</h2>
            <button id="close-trend" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div id="trend-list-content">
            <p style="text-align: center; opacity: 0.6;">Connecting to Elite CFO Intelligence...</p>
        </div>
    </div>
</div>
<div class="card actions-card">
    <div class="card-title">QUICK ACTIONS</div>
    <div class="quick-actions">
        <a href="quickactions.html?action=order" class="action-btn" style="text-decoration: none; color: white;">
            <div class="action-icon">📦</div>
            <div class="action-label">Order Receipt</div>
        </a>
        <a href="quickactions.html?action=flashsale" class="action-btn" style="text-decoration: none; color: white;">
            <div class="action-icon">⚡</div>
            <div class="action-label">Flash Sales</div>
        </a>
    </div>
</div>

    <div class="sparkle">✨</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const termsCheck = document.getElementById("terms-check");
    const startBtn = document.getElementById("start-cfo-btn");
    const onboardingOverlay = document.getElementById("onboarding-container"); // Change this to your actual popup ID

    // Toggle button state based on checkbox
    termsCheck.addEventListener("change", () => {
        if (termsCheck.checked) {
            startBtn.style.opacity = "1";
            startBtn.style.cursor = "pointer";
            startBtn.disabled = false;
            startBtn.classList.add("active");
        } else {
            startBtn.style.opacity = "0.5";
            startBtn.style.cursor = "not-allowed";
            startBtn.disabled = true;
            startBtn.classList.remove("active");
        }
    });

    // START APP LOGIC
    startBtn.addEventListener("click", () => {
        if (!startBtn.disabled) {
            console.log("Starting App...");
            
            // 1. Hide the popup
            if (onboardingOverlay) {
                onboardingOverlay.style.display = "none";
            }

            // 2. Fetch User Data (Assuming you are logged in)
const currentAuth = getAuth();
const user = currentAuth.currentUser;

if (user) {
    fetchAnalytics(user.uid);
    fetchRevenuePulse(user.uid);
} else {
    console.warn('No user logged in');
}
        }
    });
});

console.log('✅ ScaleVest CFO initialized');

</script>
<!-- Product Analysis Page -->
<div id="product-analysis-page" style="display: none; position: fixed; inset: 0; background: #0a0e27; z-index: 10000; overflow-y: auto; padding: 30px;">
    <div class="container">
        <button id="back-btn" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); padding: 12px 24px; border-radius: 12px; color: white; cursor: pointer; margin-bottom: 20px; font-size: 14px; display: flex; align-items: center; gap: 8px;">
            ← Back 
        </button>
        
        <div style="text-align: center; margin-bottom: 40px;">
            <h1 style="font-size: 42px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px;">Product Analysis</h1>
            <p style="color: rgba(255,255,255,0.6); font-size: 16px;">Comprehensive performance metrics for all your products</p>
        </div>
        
        <div id="products-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
            <!-- Products will be dynamically inserted here -->
        </div>
    </div>
</div>
<!-- Finance Report Page -->
<div id="finance-report-page" style="display: none; position: fixed; inset: 0; background: #0a0e27; z-index: 10000; overflow-y: auto; padding: 30px;">
<div class="container" id="dashboard-container">
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
            <button id="finance-back-btn" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); padding: 12px 24px; border-radius: 12px; color: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                ← Back
            </button>
            <button id="export-pdf-btn" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; padding: 12px 24px; border-radius: 12px; color: white; cursor: pointer; font-size: 14px; font-weight: 600;">
                📄 Generate PDF Report
            </button>
        </div>

        <!-- Title -->
        <div style="text-align: center; margin-bottom: 50px;">
            <h1 style="font-size: 48px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px;">CFO Financial Report</h1>
            <p id="report-date" style="color: rgba(255,255,255,0.6); font-size: 16px;">Generated on January 6, 2026</p>
        </div>

        <!-- Key Metrics Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px;">
            <!-- Total Revenue Card -->
            <div class="card" style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.08) 0%, rgba(74, 222, 128, 0.02) 100%); border-color: rgba(74, 222, 128, 0.2);">
                <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: rgba(255,255,255,0.5); margin-bottom: 15px;">Total Revenue</div>
                <div id="fin-total-revenue" style="font-size: 42px; font-weight: 700; color: #4ade80; margin-bottom: 10px;">$0</div>
                <div id="fin-revenue-trend" style="font-size: 14px; color: rgba(74, 222, 128, 0.8);">▲ 0% vs last week</div>
            </div>

            <!-- Total Costs Card -->
            <div class="card" style="background: linear-gradient(135deg, rgba(251, 146, 60, 0.08) 0%, rgba(251, 146, 60, 0.02) 100%); border-color: rgba(251, 146, 60, 0.2);">
                <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: rgba(255,255,255,0.5); margin-bottom: 15px;">Total Costs</div>
                <div id="fin-total-costs" style="font-size: 42px; font-weight: 700; color: #fb923c; margin-bottom: 10px;">$0</div>
                <div style="font-size: 14px; color: rgba(251, 146, 60, 0.8);">Operating expenses</div>
            </div>

            <!-- Net Profit Card -->
            <div class="card" id="profit-card">
                <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: rgba(255,255,255,0.5); margin-bottom: 15px;">Net Profit/Loss</div>
                <div id="fin-net-profit" style="font-size: 42px; font-weight: 700; margin-bottom: 10px;">$0</div>
                <div id="fin-profit-status" style="font-size: 14px;">Calculating...</div>
            </div>

            <!-- Profit Margin Card -->
            <div class="card">
                <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: rgba(255,255,255,0.5); margin-bottom: 15px;">Profit Margin</div>
                <div id="fin-profit-margin" style="font-size: 42px; font-weight: 700; color: #3b82f6; margin-bottom: 10px;">0%</div>
                <div style="font-size: 14px; color: rgba(59, 130, 246, 0.8);">Revenue efficiency</div>
            </div>
        </div>

        <!-- Weekly Sales Chart -->
        <div class="card" style="padding: 40px; margin-bottom: 40px;">
            <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 30px;">📊 Weekly Sales Performance</h3>
            <div id="weekly-sales-chart" style="display: flex; align-items: flex-end; justify-content: space-around; height: 300px; gap: 15px;">
                <!-- Chart bars will be generated here -->
            </div>
        </div>

        <!-- Monthly Sales Chart -->
        <div class="card" style="padding: 40px; margin-bottom: 40px;">
            <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 30px;">📈 Monthly Revenue Trend (Last 4 Weeks)</h3>
            <div id="monthly-sales-chart" style="display: flex; align-items: flex-end; justify-content: space-around; height: 300px; gap: 15px;">
                <!-- Chart bars will be generated here -->
            </div>
        </div>

        <!-- Profit/Loss Analysis -->
        <div class="card" style="padding: 40px; margin-bottom: 40px;">
            <div style="text-align: center; margin-bottom: 40px;">
                <div id="pnl-status-main" style="font-size: 64px; font-weight: 700; margin-bottom: 15px; color: #4ade80;">PROFIT</div>
                <div id="pnl-description" style="font-size: 18px; color: rgba(255,255,255,0.7);">Your business is performing well</div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px;">
                <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px;">Revenue Generated</div>
                    <div id="pnl-revenue" style="font-size: 28px; font-weight: 700; color: #4ade80;">$0</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px;">Total Costs</div>
                    <div id="pnl-costs" style="font-size: 28px; font-weight: 700; color: #fb923c;">$0</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px;">Net Result</div>
                    <div id="pnl-net" style="font-size: 28px; font-weight: 700;">$0</div>
                </div>
            </div>
        </div>

        <!-- Executive Summary -->
        <div class="card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%); border-color: rgba(59, 130, 246, 0.2); padding: 40px; margin-bottom: 40px;">
            <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                <span>💼</span>
                <span>CFO's Executive Summary</span>
            </h3>
            <div id="executive-summary" style="font-size: 16px; line-height: 1.8; color: rgba(255,255,255,0.8);">
                Analyzing your financial data...
            </div>
        </div>

        <!-- Product Performance -->
        <div class="card" style="padding: 40px;">
            <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 30px;">🏆 Product Performance Breakdown</h3>
            <div id="products-performance-list">
                <!-- Products will be listed here -->
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div id="export-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 11000; justify-content: center; align-items: center;">
    <div class="card" style="max-width: 500px; width: 90%; padding: 40px;">
        <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 20px; text-align: center;">📄 Generate Finance Report</h3>
        <input type="text" id="report-name-input" placeholder="Enter report name (e.g., Q1 2026 Report)" style="width: 100%; padding: 15px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: white; font-size: 16px; margin-bottom: 20px;">
        <div style="display: flex; gap: 15px;">
            <button id="cancel-export-btn" style="flex: 1; padding: 15px; border-radius: 12px; background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; font-size: 14px; font-weight: 600;">Cancel</button>
            <button id="confirm-export-btn" style="flex: 1; padding: 15px; border-radius: 12px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; cursor: pointer; font-size: 14px; font-weight: 600;">Generate PDF</button>
        </div>
    </div>
</div>



</body>
</html>





