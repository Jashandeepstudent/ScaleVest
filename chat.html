<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Session | ScaleVest</title>
    <script src='https://8x8.vc/external_api.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.27/jsrsasign-all-min.js"></script>
    <style>
        /* Reusing your ScaleVest Theme */
        body { font-family: 'SF Pro Display', -apple-system, sans-serif; background: #f8f9fa; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* HEADER */
        .chat-header {
            background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between; z-index: 100;
        }
        
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-logo { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #e5e7eb; }
        .header-title { font-weight: 800; font-size: 1.2rem; color: #1a1a1a; }
        .header-sub { font-size: 0.85rem; color: #10b981; font-weight: 600; }
        .header-actions { display: flex; align-items: center; gap: 10px; }

        .action-btn {
            background: #f3f4f6; border: 1px solid #e5e7eb; padding: 8px 14px; border-radius: 8px;
            cursor: pointer; font-size: 0.85rem; font-weight: 600; color: #374151;
            display: flex; align-items: center; gap: 6px; transition: 0.2s; text-decoration: none; height: 38px;
        }
        .meeting-btn { background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; display: none; }
        .action-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* CHAT AREA */
        #chatContainer {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px;
            position: relative; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px;
        }

        /* MESSAGES */
        .message-bubble { max-width: 70%; padding: 12px 18px; border-radius: 18px; font-size: 15px; line-height: 1.5; position: relative; animation: popIn 0.3s ease; word-wrap: break-word; }
        .msg-mine { background: #10b981; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-theirs { background: white; color: #374151; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .timestamp { font-size: 10px; opacity: 0.7; margin-top: 5px; display: block; text-align: right; }
        
        /* MEETING CARD */
        .meeting-card {
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; padding: 15px; margin-top: 5px; cursor: pointer; transition: 0.2s;
        }
        .meeting-card:hover { background: rgba(255,255,255,0.25); }
        .msg-theirs .meeting-card { background: #f0fdf4; border-color: #10b981; color: #064e3b; }
        .join-btn { background: #fff; color: #10b981; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 700; margin-top: 10px; cursor: pointer; width: 100%; }

        /* INPUT AREA */
        .input-area { background: white; padding: 15px 20px; display: flex; gap: 12px; border-top: 1px solid #e5e7eb; align-items: center; }
        #attachBtn { background: #f3f4f6; color: #6b7280; border: none; padding: 10px; border-radius: 50%; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; width: 45px; height: 45px; }
        #attachBtn:hover { background: #e5e7eb; color: #1a1a1a; }
        #msgInput { flex: 1; padding: 15px; border: 2px solid #e5e7eb; border-radius: 12px; outline: none; font-size: 16px; transition: 0.3s; }
        #msgInput:focus { border-color: #10b981; }
        #sendBtn { background: #10b981; color: white; border: none; padding: 0 25px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; height: 50px; }
        #sendBtn:hover { transform: scale(1.05); }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        .modal-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 20px; color: #111; }
        .modal-input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; margin-bottom: 15px; font-size: 1rem; box-sizing: border-box;}
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .modal-btn { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; transition: 0.2s; width: 100%; }
        .btn-primary { background: #10b981; color: white; }
        .btn-secondary { background: #f3f4f6; color: #333; }

        /* VIDEO INTERFACE */
        #videoConferenceContainer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 3000; display: none; flex-direction: column;
        }
        #jitsiFrame { flex: 1; width: 100%; border: none; position: relative; }
        #meetingLoader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 3001; color: white;
        }
        .loader-spinner {
            width: 60px; height: 60px; border: 4px solid #333; border-top: 4px solid #10b981;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        .loader-text { margin-top: 20px; font-size: 1rem; color: #999; }
        .video-controls {
            height: 80px; background: #111; display: flex; align-items: center; justify-content: center; gap: 20px;
        }
        .control-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            background: #333; color: white; transition: 0.2s;
        }
        .control-btn.active { background: #ef4444; color: white; }
        
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="uploadProgress" style="position: fixed; top: 0; left: 0; width: 0%; height: 4px; background: #10b981; z-index: 200;"></div>

    <div class="chat-header">
        <div class="header-left">
            <img src="ScaleVestLogo.png" alt="SV" class="header-logo" onerror="this.src='https://via.placeholder.com/45?text=SV'"> 
            <div>
                <div class="header-title" id="chatTitle">Connecting...</div>
                <div class="header-sub">ScaleVest Secure Line</div>
            </div>
        </div>
        
        <div class="header-actions">
            <button class="action-btn meeting-btn" id="meetingBtn" onclick="openMeetingModal()">Arrange Meeting</button>
            <button class="action-btn" onclick="history.back()">Back</button>
        </div>
    </div>

    <div id="chatContainer">
        <div id="initialLoader" style="position: absolute; top:0; left:0; width:100%; height:100%; background:#f8f9fa; z-index:50; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div class="loader-spinner"></div>
            <div style="margin-top:10px; color:#888;">Syncing...</div>
        </div>
        <div class="typing-indicator" id="typingBubble" style="display:none;">
            Typing...
        </div>
    </div>

    <div class="input-area">
        <button id="attachBtn">üìé</button>
        <input type="file" id="fileInput" style="display: none;">
        <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off">
        <button id="sendBtn">SEND</button>
    </div>

    <div id="meetingSetupModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Arrange Meeting</div>
            <input type="text" id="meetingTitle" class="modal-input" placeholder="Meeting Title">
            <div class="modal-grid">
                <input type="date" id="meetingDate" class="modal-input">
                <input type="time" id="meetingTime" class="modal-input">
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="modal-btn btn-secondary" onclick="closeMeetingModal()">Cancel</button>
                <button class="modal-btn btn-primary" onclick="createMeeting()">Generate Link</button>
            </div>
        </div>
    </div>

    <div id="waitingRoomModal" class="modal-overlay">
        <div class="modal-box" style="text-align:center;">
            <div style="font-size:3rem;">‚è≥</div>
            <div class="modal-title">Meeting Scheduled</div>
            <p id="waitDisplayTime">--:--</p>
            <button class="modal-btn btn-secondary" onclick="document.getElementById('waitingRoomModal').style.display='none'">Wait</button>
        </div>
    </div>

    <div id="videoConferenceContainer">
        <div id="jitsiFrame">
            <div id="meetingLoader">
                <div class="loader-spinner"></div>
                <div class="loader-text">Securing session...</div>
            </div>
        </div>
        <div class="video-controls">
            <button class="control-btn" onclick="toggleAudio()" id="btnMic">üé§</button>
            <button class="control-btn" onclick="toggleVideo()" id="btnCam">üì∑</button>
            <button class="control-btn" style="background:#ef4444;" onclick="leaveMeeting()">Leave</button>
            <button class="control-btn" id="btnEndAll" style="display:none; width:auto; padding:0 20px; border-radius:25px; background:#b91c1c;" onclick="endMeetingForAll()">End All</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, get, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
            authDomain: "scalevest-163a0.firebaseapp.com",
            databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
            projectId: "scalevest-163a0",
            appId: "1:938358950124:web:043506aeaacea2a96bfdc9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser, chatRoomID, jitsiAPI, isInvestor = false, userDisplayName = "User", userAvatar = "";
        let audioMuted = false, videoMuted = false;

        const params = new URLSearchParams(window.location.search);
        const recipientUID = params.get('recipient');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await identifyUserRole();
                initializeChat();
            } else { window.location.href = "login3.html"; }
        });

        async function identifyUserRole() {
            const invSnap = await get(ref(db, `investorProfiles/${currentUser.uid}`));
            if (invSnap.exists()) {
                isInvestor = true;
                document.getElementById('meetingBtn').style.display = 'flex';
                document.getElementById('btnEndAll').style.display = 'flex';
                userDisplayName = invSnap.val().fullName || "Investor";
            } else {
                const fndSnap = await get(ref(db, `founderProfile/${currentUser.uid}`));
                if (fndSnap.exists()) userDisplayName = fndSnap.val().founderUsername || "Founder";
            }
        }

        // --- GLOBAL FUNCTION MAPPING (Fixes "Not defined" errors) ---
        window.openMeetingModal = () => document.getElementById('meetingSetupModal').style.display = 'flex';
        window.closeMeetingModal = () => document.getElementById('meetingSetupModal').style.display = 'none';
        
        window.toggleAudio = () => { if(jitsiAPI) { jitsiAPI.executeCommand('toggleAudio'); audioMuted = !audioMuted; document.getElementById('btnMic').classList.toggle('active', audioMuted); } };
        window.toggleVideo = () => { if(jitsiAPI) { jitsiAPI.executeCommand('toggleVideo'); videoMuted = !videoMuted; document.getElementById('btnCam').classList.toggle('active', videoMuted); } };
        window.leaveMeeting = () => { if(jitsiAPI) jitsiAPI.dispose(); document.getElementById('videoConferenceContainer').style.display = 'none'; };
        window.endMeetingForAll = () => { if(confirm("End meeting for everyone?")) { if(jitsiAPI) jitsiAPI.executeCommand('hangup'); window.leaveMeeting(); } };

        window.generateJitsiToken = function(roomName) {
            const appId = "vpaas-magic-cookie-0fd84653e8f44399aba55f69eaf1f6fe";
            const kid = "e06cc7";
            
            const prvKeyPEM = "-----BEGIN RSA PRIVATE KEY-----\n" +
                "MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCytntDVcixIfHE\n" +
                "9WsWkCSbuX1Dyemm0beZCSXhvCesqNP0sdUP8gSskZzLPsRlH4iLJIOIg/m6nYcK\n" +
                "hDGUTivM1HLEb5pf3c38b1qDYGpjm67UFfv2l2/YeGuPkutUSjos90M3l0lHxeLR\n" +
                "YIxpbFCm8nYEBIvGHU6ifCODsfnvN9neR527ipf8rwUxm1TSPtWzr+EfI/+s9f/3\n" +
                "7DM+iXWD2lQLCQVOxBNlUOTCCkEzaIV8N2kwhHzCs1l3I7pQxEvQTxqZIeP12i2r\n" +
                "40/30IBeLAnfOHY3XeG6Y00typKHU6B1xqR8MCD8O2ALEb/9xGMEfRYQTSNCq6ve\n" +
                "9iGIGJ2fAgMBAAECggEAaiOc46nwLtuVJsAHYPgs9dvdfMRPo8cMPrTDLeU8vvvq\n" +
                "Hnr7qqO3iPJWaBOYOuLWiqUeBZc0W1QxntpSQ92Ff/pxSx9pVSR7sUBFRp+dsBkH\n" +
                "ZWjFI3hfcfZbE4NThtUq5gfYgQy19g2eH3IzEm3FHNIFq28zwG8pg7EsuouagCru\n" +
                "k3KpI/VxiYJ3YKpJpxOkdMw1Wce1bKGZdGcLi5Wsww/R0E2tpBVcqoJgYGUajQd5\n" +
                "LvJskxXpHbIfMZKuHt5wghLB0rZGla6bPrM4yb3r5uZf1qtBDHBFqfrQgL+yougG\n" +
                "JHbY7Z63HtQIl02tVowWJR8RZL0vd6kvwbYO4JfX6QKBgQD/DbudQU+kkQnmGFWv\n" +
                "ZQQITbSe32x+Ma5uyXfCV8UHsmXqBdXieIrHLJGmxYp++S3eMvPEjmZCO9TJFge3\n" +
                "/s79NL/ricMQVGP9cVCQQZAmIy0Nl1vgD1O5mBO9+KgfCJyXKBznCJPx34J4MCgE\n" +
                "hAoVQqKn/hVIFx2HaHpfD9WiGwKBgQCzYDwm8wjNyxQaoBxzqXr/bxfLuSfhbQbf\n" +
                "0t2YiZM5N2OjBeuEvrKTBl3DjHtEU/Vh1gDbHVEgm+8qT78pjjGwVv3N90qCEzls\n" +
                "VAYEBZRdK+0VmHumEYLTcG/WKf+M828pXrsMYVJRhso7yip+IShrW/4TC6gysUUM\n" +
                "auwQ7h5KzQKBgAo4QKZCcbCEZ0MjAnvurkSu6GfdR/megADMbdIJtkliqpa/+RwD\n" +
                "/HuSm5t1GuGPlnjqzb24fvx0bUhJa7HBsgWPUYlckcZbu03ydmnxVpdQnYOH5xSJ\n" +
                "SK+NGm1oQ0RLEgs0fkP7ogH1FMNAGrpjmAvWCbJ1ieDDnFlKpGyes861AoGAE0pe\n" +
                "LbIlWDxmxRZC+Q1Y9O91l6sp5sxa2OdMfYMOGjEivf18/qGjgrxEiSsqdoaw9PyW\n" +
                "yvm0J9WdOueon0dzgItacDQQBz0aB9RhcT1IX1zB+niTk6B+eU62OEn7+aSUZ9aQ\n" +
                "NxygRbRBO3zaZQYb2q/h+xpd1FXMHzHAgXGaQGECgYEArNdypdZIWNH8DmcH+vq3\n" +
                "J+gTaaH62Ipqts4l9mUsFvto2HVfA8Hcgsi2aNN+MBF6cytYVwVks99w1/hVOBe2\n" +
                "M7yVbIhkAg9PuZwxpYEaAW6lOU1aYh2xYfZigalUY45ivIbNmk/czaFJ8dXIe7M0\n" +
                "b3jwupOm6VFUtDOi4xuQ8VI=\n" +
                "-----END RSA PRIVATE KEY-----";

            const keyObj = KEYUTIL.getKey(prvKeyPEM);
            const header = { alg: 'RS256', typ: 'JWT', kid: kid };
            const now = Math.floor(Date.now() / 1000);
            const payload = {
                aud: "jitsi", iss: "chat", sub: appId, room: roomName,
                iat: now, exp: now + 7200,
                context: { user: { name: userDisplayName, moderator: isInvestor } }
            };
            return KJUR.jws.JWS.sign("RS256", JSON.stringify(header), JSON.stringify(payload), keyObj);
        };

        window.tryJoinMeeting = async (meetingId, scheduledTime) => {
            const now = Date.now();
            if (scheduledTime !== 'now' && now < (scheduledTime - 5 * 60 * 1000)) {
                document.getElementById('waitingRoomModal').style.display = 'flex';
                return;
            }

            const room = "ScaleVest_" + meetingId;
            const token = window.generateJitsiToken(room);
            document.getElementById('videoConferenceContainer').style.display = 'flex';
            document.getElementById('meetingLoader').style.display = 'flex';

            const options = {
                roomName: "vpaas-magic-cookie-0fd84653e8f44399aba55f69eaf1f6fe/" + room,
                jwt: token,
                width: "100%", height: "100%",
                parentNode: document.querySelector('#jitsiFrame'),
                configOverwrite: { prejoinPageEnabled: false, enableLobby: false }
            };

            try {
                jitsiAPI = new JitsiMeetExternalAPI("8x8.vc", options);
                jitsiAPI.addEventListener('videoConferenceJoined', () => document.getElementById('meetingLoader').style.display = 'none');
            } catch (e) { console.error(e); }
        };

        window.createMeeting = async () => {
            const mId = `meet_${Date.now()}`;
            await push(ref(db, `Chats/${chatRoomID}`), {
                sender: currentUser.uid, type: 'meeting', title: document.getElementById('meetingTitle').value || "Quick Sync",
                meetingId: mId, scheduledTime: 'now', timestamp: Date.now()
            });
            window.closeMeetingModal();
        };

        // --- INITIALIZE CHAT ---
        function initializeChat() {
            const ids = [currentUser.uid, recipientUID].sort();
            chatRoomID = `chat_${ids[0]}_${ids[1]}`;
            onChildAdded(ref(db, `Chats/${chatRoomID}`), (snap) => renderMessage(snap.val()));
            document.getElementById('initialLoader').style.display = 'none';
        }

        function renderMessage(msg) {
            if(!msg.sender) return;
            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = `message-bubble ${msg.sender === currentUser.uid ? 'msg-mine' : 'msg-theirs'}`;
            
            if (msg.type === 'meeting') {
                div.innerHTML = `<div class="meeting-card"><strong>üìπ ${msg.title}</strong><button class="join-btn" onclick="tryJoinMeeting('${msg.meetingId}', 'now')">JOIN</button></div>`;
            } else { div.textContent = msg.text; }
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        document.getElementById('sendBtn').onclick = async () => {
            const val = document.getElementById('msgInput').value;
            if(!val) return;
            await push(ref(db, `Chats/${chatRoomID}`), { sender: currentUser.uid, text: val, timestamp: Date.now() });
            document.getElementById('msgInput').value = "";
        };
    </script>
</body>
</html>
