<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Inventory Pro - Unlimited Alerts</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>
*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:#f6f7fb;padding:30px}

/* HEADER */
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:15px}
.top h2{margin:0;font-size:26px;font-weight:700}
.top .actions{display:flex;gap:10px;flex-wrap:wrap}
.top button{padding:12px 18px;border:none;border-radius:14px;background:#000;color:#fff;font-weight:600;cursor:pointer}

/* SEARCH */
.search-container {width:100%; margin-bottom:20px;}
#searchInput {
  width:100%; padding:16px 20px; border-radius:16px; border:1px solid #ddd;
  font-size:16px; outline:none; box-shadow:0 10px 20px rgba(0,0,0,0.03);
}

/* STATS */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:30px}
.stat{background:#fff;padding:22px;border-radius:20px;box-shadow:0 10px 25px rgba(0,0,0,.06)}
.stat h3{margin:8px 0 0;font-size:26px}

/* TABLE */
.table{background:#fff;border-radius:22px;box-shadow:0 15px 35px rgba(0,0,0,.08);overflow:hidden}
.head,.row{display:grid;grid-template-columns:2fr 1fr 1fr 2fr;padding:16px 22px;align-items:center}
.head{background:#f1f3f7;font-weight:600}
.row:not(:last-child){border-bottom:1px solid #eee}

/* STATUS */
.status.ok{color:#16a34a}
.status.low{color:#d97706}
.status.out{color:#dc2626}

/* MODALS */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(8px)}
.modal-box{width:400px;background:#fff;padding:30px;border-radius:30px;text-align:center;box-shadow:0 20px 50px rgba(0,0,0,0.3)}

.ai-visualizer {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 5px;
  height: 60px;
  margin: 20px 0;
}
.bar {
  width: 6px;
  height: 10px;
  background: #2563eb;
  border-radius: 10px;
  animation: bounce 1s ease-in-out infinite;
}
@keyframes bounce { 0%, 100% { height: 10px; } 50% { height: 50px; } }
.confirm-mode .bar { background: #ef4444 !important; }

/* SUCCESS POPUP */
.success-popup {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: #16a34a;
  color: white;
  padding: 12px 25px;
  border-radius: 50px;
  font-weight: 600;
  display: none;
  z-index: 3000;
  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

.flash{position:fixed;inset:0;background:rgba(34,197,94,.25);pointer-events:none;z-index:3000;opacity:0;transition:.15s}
.flash.show{opacity:1}
</style>
</head>

<body>

<div id="flash" class="flash"></div>
<div id="successPopup" class="success-popup"></div>

<div id="notifModal" class="modal" style="display: flex;">
  <div class="modal-box">
    <h2 style="margin-top:0">Stock Alerts</h2>
    <p>Enable notifications to get instant alerts when items are low or out of stock.</p>
    <button onclick="requestPushPermission()" style="background:#16a34a; width:100%; margin-bottom:10px;">Enable Notifications</button>
    <button onclick="closeNotifModal()" style="background:#ddd; color:#333; width:100%;">Maybe Later</button>
  </div>
</div>

<div class="top">
  <h2>Inventory</h2>
  <div class="actions">
    <button onclick="openScanner()">üì∑ Scanner</button>
    <button style="background:#2563eb" onclick="startVoiceAssistant()">üéôÔ∏è AI Voice</button>
  </div>
</div>

<div class="search-container">
  <input type="text" id="searchInput" placeholder="Search inventory..." onkeyup="render()">
</div>

<div class="stats">
  <div class="stat"><span>Total</span><h3 id="total">0</h3></div>
  <div class="stat"><span>Low</span><h3 id="low">0</h3></div>
  <div class="stat"><span>Out</span><h3 id="out">0</h3></div>
</div>

<div class="table">
  <div class="head"><div>Product</div><div>Quantity</div><div>Status</div><div>Actions</div></div>
  <div id="products"></div>
</div>

<div id="voiceModal" class="modal">
  <div class="modal-box">
    <h2 style="margin-top:0">AI Voice Assistant</h2>
    <div id="viz" class="ai-visualizer">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>
    <div id="speechOutput" style="font-style:italic; color:#2563eb; margin-bottom:20px; min-height:24px">Waiting for you to speak...</div>
    <button onclick="stopVoiceAssistant()" style="background:#ef4444">Close Assistant</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// --- CONFIG ---
firebase.initializeApp({
  apiKey:"AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain:"scalevest-163a0.firebaseapp.com",
  databaseURL:"https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId:"scalevest-163a0"
});

const auth=firebase.auth(), db=firebase.database();
let inventory={}, invRef, recognition, isAssistantActive = false;
let pendingAction = null;

auth.onAuthStateChanged(u=>{
  if(!u) return;
  invRef=db.ref(`Businesses/${u.uid}/inventory`);
  invRef.on("value",s=>{ inventory=s.val()||{}; render(); });
  
  // Hide permission modal if already granted
  if (Notification.permission === "granted") closeNotifModal();
});

// --- PUSH NOTIFICATION LOGIC ---
function closeNotifModal() { document.getElementById('notifModal').style.display = 'none'; }

function requestPushPermission() {
  Notification.requestPermission().then(permission => {
    if (permission === "granted") {
      new Notification("Alerts Enabled!", { body: "You will now receive stock alerts." });
    }
    closeNotifModal();
  });
}

function triggerPushAlert(title, message) {
  if (Notification.permission === "granted") {
    new Notification(title, { body: message });
  }
}

// --- AI VOICE LOGIC ---
function startVoiceAssistant() {
  if (!('webkitSpeechRecognition' in window)) return alert("Voice not supported");
  isAssistantActive = true;
  document.getElementById("voiceModal").style.display = "flex";
  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true; 
  recognition.interimResults = true;

  recognition.onresult = (event) => {
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        const finalTranscript = event.results[i][0].transcript;
        document.getElementById("speechOutput").textContent = `"${finalTranscript}"`;
        processSmartAI(finalTranscript);
      }
    }
  };
  recognition.onend = () => { if (isAssistantActive) recognition.start(); };
  recognition.start();
  speakWithAI("I am listening.");
}

function stopVoiceAssistant() {
  isAssistantActive = false;
  document.getElementById("voiceModal").style.display = "none";
  if (recognition) recognition.stop();
}

async function processSmartAI(cmd) {
  cmd = cmd.toLowerCase();

  // 1. Extract Quantity & Name
  const numberMap = { 'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5, 'ten': 10 };
  let qty = 1;
  const numMatch = cmd.match(/(\d+)/);
  if (numMatch) qty = parseInt(numMatch[0]);
  else Object.keys(numberMap).forEach(word => { if(cmd.includes(word)) qty = numberMap[word]; });

  let pName = cmd.replace(/\d+|add|remove|delete|increase|decrease|minus|plus|update|to|of|set|the/g, '').trim();
  if (pName.length < 2) return;

  const existingEntry = Object.entries(inventory).find(([_, p]) => p.name.toLowerCase() === pName);

  // 2. Action Logic
  if (cmd.includes("remove") || cmd.includes("delete")) {
    if (existingEntry) {
      invRef.child(existingEntry[0]).remove();
      speakWithAI(`Deleted ${pName}`);
    }
  } else {
    let newQty;
    if (existingEntry) {
      const current = existingEntry[1].quantity;
      newQty = (cmd.includes("decrease") || cmd.includes("minus") || cmd.includes("less")) ? Math.max(0, current - qty) : current + qty;
      invRef.child(existingEntry[0]).update({ quantity: newQty });
    } else {
      newQty = qty;
      invRef.push({ name: pName.charAt(0).toUpperCase() + pName.slice(1), quantity: newQty, unit: "pcs" });
    }

    // 3. PUSH ALERT TRIGGER
    if (newQty === 0) triggerPushAlert("üö® OUT OF STOCK", `${pName} is now empty!`);
    else if (newQty < 10) triggerPushAlert("‚ö†Ô∏è LOW STOCK", `${pName} is down to ${newQty}.`);

    speakWithAI(`Updated ${pName} to ${newQty}`);
    triggerSuccess(`Updated ${pName}`);
  }
}

function speakWithAI(text) {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(new SpeechSynthesisUtterance(text));
  }
}

function triggerSuccess(msg) {
  const popup = document.getElementById("successPopup");
  popup.textContent = msg; popup.style.display = "block";
  document.getElementById("flash").classList.add("show");
  setTimeout(() => { popup.style.display = "none"; document.getElementById("flash").classList.remove("show"); }, 2000);
}

function render(){
  const productsDiv = document.getElementById("products");
  productsDiv.innerHTML="";
  let lowC=0, outC=0;

  Object.entries(inventory).forEach(([id,p])=>{
    let s="OK", c="ok";
    if(p.quantity===0){s="Out"; c="out"; outC++}
    else if(p.quantity<10){s="Low"; c="low"; lowC++}

    productsDiv.innerHTML+=`
    <div class="row">
      <div style="font-weight:600">${p.name}</div>
      <div>${p.quantity} <small>${p.unit || 'pcs'}</small></div>
      <div class="status ${c}">${s}</div>
      <div>
        <button onclick="manualChange('${id}', 1)">+</button>
        <button class="remove" onclick="handleManualDelete('${id}', '${p.name}')">üóëÔ∏è</button>
      </div>
    </div>`;
  });
  document.getElementById("total").textContent=Object.keys(inventory).length;
  document.getElementById("low").textContent=lowC;
  document.getElementById("out").textContent=outC;
}

function handleManualDelete(id, name) { if(confirm(`Delete ${name}?`)) invRef.child(id).remove(); }
function manualChange(id, dir) {
  const p = inventory[id];
  const newQty = Math.max(0, p.quantity + dir);
  invRef.child(id).update({ quantity: newQty });
  if (newQty === 0) triggerPushAlert("üö® OUT OF STOCK", `${p.name} is now empty!`);
}
</script>

</body>
</html>
